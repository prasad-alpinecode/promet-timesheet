<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

	<script src="chrome-extension://mooikfkahbdckldjjndioackbalphokd/assets/prompt.js"></script>

	<link rel='stylesheet' href='all.min.css'>
	<link rel='stylesheet' href='angular-material.min-1.1.20.css'>
	<link rel='stylesheet' href='iziToast.min.1.4.0.css'>
	<link rel='stylesheet' href='jquery-clockpicker.min.css'>
	<link rel='stylesheet' href='picker.min.css'>
	<link rel='stylesheet' href='timesheet.master.css'>
	<link rel='stylesheet' href='timesheet.css'>

	<script src='style.js'></script>
	<script src='jquery-3.3.1.min.js'></script>
	<script src='angular.min.js'></script>
	<script src='angular-material.min-1.1.20.js'></script>
	<script src='angular-animate.min.js'></script>
	<script src='angular-aria.min.js'></script>
	<script src='base64.js'></script>
	<script src='jspdf.js'></script>
	<script src='jspdf.min.js'></script>
	<script src='moment.js'></script>
	<script src='jspdf.plugin.autotable.min.js'></script>
	<script src='iziToast.min.1.4.0.js'></script>
	<script src='general.func.js'></script>
	<script src='company_properties_timesheet.js'></script>
	<script src='picker.min.js'></script>
	<script src='tokn-component.js'></script>
	<script src='touch.js'></script>
	<script src='chart.min.js'></script>
	<script src='angular-chart.min.js'></script>
	
	<script>
		var qrcode;
		var app = angular.module('TOKNApp', ['ngAria', 'ngMaterial']);
		app.controller('dataController', ['$scope','$interval', function ($scope,$interval) {

			$scope.testdata = false;
			$scope.logs = true;
			$scope.version = "0.1";
			
			$scope.getPropertyValue = function(param){
                    for(var i =0; i < COMPANY_PROPERTIES.length;i++){
                        if(COMPANY_PROPERTIES[i].Name===param ){
                            return COMPANY_PROPERTIES[i].Value;
                        };
					};
					
                    return undefined;
			};
				
			/*Read and initialize with company_properties_timesheet.js file*/	
			$scope.company=$scope.getPropertyValue('Company');
			$scope.appName=$scope.getPropertyValue('AppName');
			$scope.screenName=$scope.getPropertyValue('ScreenName');  
			$scope.LocalSyncObject=$scope.getPropertyValue('LocalSyncObject');
			$scope.LocalSyncStatusObject=$scope.getPropertyValue('LocalSyncStatusObject');
			$scope.genDataStoreAppName=$scope.getPropertyValue('genDataStoreAppName');
			$scope.genDataStoreObjName=$scope.getPropertyValue('genDataStoreObjName');
			$scope.genDataStoreUpdMethod=$scope.getPropertyValue('genDataStoreUpdMethod');
			$scope.WebHook = $scope.getPropertyValue('WebHook');
			$scope.emailTemplate = $scope.getPropertyValue('emailTemplate');
			$scope.sendPostToConnect = $scope.getPropertyValue('sendPostToConnect');
			$scope.approveURL = $scope.getPropertyValue('approveURL');

			$scope.GTCompanyCode=$scope.getPropertyValue('GTCompanyCode');
/* STYLING CODE ==============================================================================*/
			$scope.applyStyling = STYLES;

			$scope.banner = {
				"background-color": $scope.applyStyling.primary,
				"border-top": "4px solid " + $scope.applyStyling.primary,
				"border-bottom": "1px solid #eee"
			};
			$scope.subBanner = {
				"background-color": $scope.applyStyling.secondary,
			};
			$scope.heading = {
				"color": "#fff"
			};

			$scope.bodyText = {
				"color": "#000"
			};

			$scope.secondBG = {	"background-color": "#fff"};

			$scope.icon = {
				"color": $scope.applyStyling.primary
			};

			$scope.barWhite = {
				"background-color":"white"
			};

			$scope.bar = {
				"background-color": $scope.applyStyling.secondary
			};

			$scope.footer = {
				"background-color": $scope.applyStyling.primary
			};

			$scope.button = {
				"color": $scope.applyStyling.secondary
			};

			$scope.button1 = {
				"border-top": "1px solid #999",
				"border-right": "1px solid #999",
				"background-color": $scope.applyStyling.primary,
				"color":"white"
			};
			$scope.button2 = {
				"background-color": "#F04F23",
				"color":"black"
			};
			$scope.button3 = {
				"background-color": "transparent",
				"color":"#999999"
			};
			$scope.userNameheading = {
				"background-color": $scope.applyStyling.primary,
				"color": $scope.applyStyling.secondary
			};

			$scope.subHeading = {
				"color": $scope.applyStyling.primary,
			};
			$scope.subHeadingNew = {
				"color": "rgb(2 46 84)",
			};
			$scope.subHeadingHours = {
				"color": $scope.applyStyling.primary,
				"font-size": "28px"
			};

			$scope.lineBTM = {
				"border-bottom": "1px solid " + $scope.applyStyling.primary
			};

			$scope.lineTOP = {
				"border-top": "0px solid " + $scope.applyStyling.primary
			};

			$scope.navMenu = {
				"background-color": $scope.applyStyling.secondary,
				"color": "Black"
			};

			$scope.border = {
				"border": "1px solid " + $scope.applyStyling.primary
			};
			$scope.loadingJob = false;
			$scope.ListManagers = [];
			$scope.showEmail =true;
			$scope.postTimesheetEntry ={};
			$scope.ToknUserList = [];
			$scope.AllUserList = [];
			$scope.ToknUserListAll = [];
			$scope.selectedEmployee={
				"name":"",
				"code":"",
				"obj":{}
			};
			$scope.SearchEmpText ="";
			$scope.loadingAC =false;
          	$scope.loadingWC = false;
          	$scope.loadedNoWCData = false;
			$scope.newData = [];
	
          
			$scope.jobcode ="";
			$scope.selectedJobObj ={};

            $scope.activityFilter="";
			$scope.SearchWCText="";			
			$scope.sendTStoGT = false;
			$scope.sendAttachToJCJOB = false;
			$scope.first = true;
			$scope.user;
			$scope.dayList = [];
			$scope.weekendingday = "";
			$scope.interval = .25;
			$scope.timesheets = [];
			$scope.applyStyling = STYLES;
			$scope.today = new Date();
			$scope.today.setSeconds(0, 0);
			$scope.dateOutput = $scope.today;
			$scope.outputWEDate = "";
			$scope.rawOutputWEDate = "";

			$scope.connectionStatus = "";
			$scope.showSignatureNote =false;	
			$scope.lockDate =false;	
			$scope.externalLock =true;	
			
			$scope.showMoreEntry =false;
			$scope.MakeModel = "";
			$scope.RegoFleet = "";
			$scope.SerialVIN = "";
			$scope.KMHrS = "";
			$scope.NotesLeft = "";
			$scope.oldNotes="";
			$scope.toogleAccordion = function (){
				$scope.showMoreEntry  = !$scope.showMoreEntry;
			};

			$scope.DailyUlb =true;
			$scope.time = {};
			$scope.time.hoursWorked = "0.00";
			$scope.time.startTime;
			$scope.time.endTime;
			$scope.pickerStartTime = "";
			$scope.pickerEndTime = "";
			$scope.imageAttachments = [];
			$scope.addAttach = new Boolean(true);
			$scope.maxAttachments = 1;
			$scope.attachWidth = 0;
			$scope.attachHeight = 0;
			$scope.pickerNumberOfHours = "0.00";
  
			$scope.allJobList =[];
			$scope.selectedJobACGroup="";
			/*Get activity group name from the Job entered and then get all activity codes for the group*/
			/*This data has default workkcentres to use as well. App will populate this for selection*/
			$scope.activityGroup="";		
			$scope.WCDescList = [];
		
			$scope.captureTimesheet = {};

			$scope.chkforKMS = false;

			var max = 2;
			var min = 1;

			$scope.weekendingformat = {};

			$scope.minDate = new moment();
			$scope.getDesiredWeekEnding = function(){
				switch($scope.desiredDate.toUpperCase()) {
							case "MONDAY":
							    return 1;
								
							case "TUESDAY":
								return 2;
								
							case "WEDNESDAY":
								return 3;
								
							case "THURSDAY":
							    return 4;
								
							case "FRIDAY":
							    return 5;
								
							case "SATURDAY":
							    return 6;
								
							case "SUNDAY":
							    return 7;													
							default:
								break;
				};	
				return 7;	
			};
			$scope.desiredDate = $scope.getPropertyValue('WeekEndingDate', $scope.appName);
			$scope.desiredWeekday = $scope.getDesiredWeekEnding();	
			$scope.currentWeekday = moment().isoWeekday();
			$scope.nextThursday = moment().add((($scope.desiredWeekday - $scope.currentWeekday) + 7) % 7, "days");
			$scope.thisWeekEndingDate = new Date($scope.nextThursday.toDate());
			$scope.minDate = $scope.nextThursday.subtract(3, 'weeks');
			$scope.minDate = $scope.minDate.toDate();
			
		
			$scope.selectDate = new Date();  
			$scope.editTimeSheetDate;

			$scope.PayGroup = "";
			$scope.lineItem = {};
			$scope.defaultWC="";
			$scope.defaultWCCode="";
			$scope.selectedWorkcentre = {};
			$scope.selectedActivity = {};
			$scope.selectedJob = {};
			$scope.jobACGroup="";

			$scope.selectedWeekWorkcentre = {};
			$scope.selectedWeekActivity = {};
			$scope.selectedWeekJob = {};
  
			$scope.filterTimesheets = {};

			$scope.selectNewWorkcentre = {};
			$scope.selectNewActivity = {};

			$scope.failedTimeSheets = [];
			$scope.failedMessageList = [];
			$scope.localTimeSheets = [];

			$scope.margins = {
				top: 70,
				bottom: 40,
				left: 30,
				width: 550
			};

			$scope.Jobs = [];
			$scope.Activities = [];
			$scope.WCS = [];

			$scope.alerts = [];
			$scope.alert = {};
			$scope.lineIndex = "";

			$scope.edit = false;
			$scope.editTAG = "None";
			$scope.selectedWeekEnding = 0;
			$scope.jobname = "";
			$scope.jobDesc = "";
			$scope.StandardText = "";
			$scope.signatureName = "";
			$scope.signature = "";
			$scope.travel = true;
			$scope.travelLocal = true;
			$scope.travelRemote = false;			
			$scope.travelHr = 0;
			$scope.index = {};
			$scope.index.dayIndex = 0;

			var s = new Date();
			var e = new Date(s);
			e.setHours(s.getHours() + 1);
			$scope.startTime = s.toLocaleTimeString();
			$scope.endTime = e.toLocaleTimeString();
			$scope.timeEntries = [];
			$scope.timeEntry = {};
			$scope.hoursperday = [];

			$scope.lockDaily = true;
			$scope.lockWeekly = true;
			$scope.lock = {};
			$scope.lock.lockWeeklytime = false;
			$scope.lock.unlockJob = false;

			$scope.pickerDailyhours = {};

			$scope.pickerDailyStart = {};
			$scope.pickerDailyEnd = {};
			$scope.pickerWeeklyStart = {};
			$scope.pickerWeeklyEnd = {};
			$scope.dayEntry = {};
			$scope.pickerDayStart = {};
			$scope.pickerDayEnd = {};
			$scope.emailsuffix = $scope.getPropertyValue('EmailSuffix',$scope.appName);			
			$scope.email = "";
			/*$scope.externalemail = "";*/
			$scope.supervisorEmail = "";
			$scope.supervisorEmailList =[];	
			
			$scope.empActivityGroup="";
			$scope.empActivityCode="";
			$scope.jobWCPlan = "";
			$scope.workcentreList=[];
			$scope.activitylist=[];
			$scope.Useractivitylist=[];
			$scope.UserDefaultWorkCentre=[];
			$scope.WCactivitylist=[];

			$scope.jobACList=[];
			$scope.selectedWCActivityGrp="";

			$scope.deviceUser={};
			$scope.toknUser={};

			$scope.numOfSyncs=0;
			$scope.syncMethodText='';
			$scope.localTSSyncs=[];
			$scope.uniqueTimesheetno ="";

			$scope.SitesList = [];
			$scope.selectedUserList = [];
			$scope.selectedUserNameList = [];
			$scope.selectedSite = {};
			$scope.TravelDataDaily = {travelHr:"",standBy:"",delay:""}

		
			
			$scope.emailJSON = {
				"personalizations": [
					{
						"to": [
						]
					}
				],
				"aws":"x",
				"from": {
					"email": "TimeSheetAPP@tokntechnology.com"
				},
				"subject": "TimeSheet",
				"content": [
					{
						"type": "text/plain",
						"value": "Please find TimeSheet PDF attached!"
					}
				],
				"attachments": [
					{
						"content": "",
						"filename": "",
						"disposition": "attachment",
						"content_id": ""
					}
				]
			};
			
			$scope.loading =false;
			$scope.loadingMessage = "Loading your data";
          	$scope.loadingData =true;
			$scope.showSVList =false;
			$scope.perDayTravelHr =[0,0,0,0,0,0,0];
			$scope.perDayTravelKm =[0,0,0,0,0,0,0];
			$scope.tempNewEntry = {};
			// $scope.loadingInit= true;
			$scope.currentStatus = "";
			$scope.leaveRequestData = [];
			$scope.leaveCodes = [];
			// $scope.oneHourRule = false;
			$scope.typeOfTimeSheet = "";
			$scope.allWorkCentreList = [];
			$scope.allActivityCodesList = [];
			$scope.GroupFilterCode = '';
			$scope.ListManagersDisbursType = [];

			$scope.overTimeHours = "0.00";
			$scope.jobManagerUsualName = "";
			$scope.jobManagerCode = "";
			

			$scope.checkAppOnlineOrOffline = function(){

				var link = {};

				link.Instr = "connectionstatus"; 
				link.FunctionOnReturn = "getStatusOfAppOnlineorOffline";

				link = "MiTokn" + JSON.stringify(link); 
				link = encodeURI(link);
				console.log(link);

				var _frameCONNECT = document.createElement('iframe');
				_frameCONNECT.width = 0; _frameCONNECT.height = 0; _frameCONNECT.frameBorder = 0;
				document.body.appendChild(_frameCONNECT);

				try {
						if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
								window.HtmlCommunicator.getDataFromHTML(link); 
						}else{
							_frameCONNECT.src = link;
						};
				}
				catch (err){
					$scope.log("windows changes for sync " + err.message());
				};
				setTimeout(function () { document.body.removeChild(_frameCONNECT); }, 5000);

			};

			$scope.checkAppOnlineOrOffline();

			/* This funcion fires on screen startup and keeps checking for the arrival of data before */
            /* allowing the user to do any activity */

            var SychIncomingData = $interval(function(){
				if($scope.toknUser == undefined || $scope.toknUser.userID==undefined 
				// || $scope.user == undefined
				// || $scope.allJobList.length ==0 
				// || $scope.allActivityCodesList.length == 0
				// || $scope.allWorkCentreList.length === 0
				|| ($scope.AllUserList.length == 0)){
                    $scope.getAllDataInitial(); 
                }else{
                    $interval.cancel(SychIncomingData);  
                    $scope.loadingInit= false;
                };
            },2000);

            $scope.getAllDataInitial = function(){
				$scope.exeDataRefresh("GetTimesheetData", "injectTimesheet");
				// $scope.exeDataRefresh("Demo-01-GetEmployee", "setEmployees");
				$scope.exeDataRefresh("GetToknUser", "setToknUser");
				$scope.exeDataRefresh("GetUserList", "setToknUserList");
				$scope.exeDataRefresh("Sites", "GetSitesData");
			};
			$scope.log=function(text){
				if ($scope.logs){
					console.log(text);
				};
			};
			/* This is a generic function where the object and function to call can be passed dynamically */
            /* This is to select the data from local DB and to inject to the screen through function on return */
            $scope.exeDataRefresh = function(objParam, FunctionOnReturn){
                var link = {};
                link.Instr = "Select";
                link.App = $scope.appName;
                link.Screen = $scope.screenName;
                link.Seq = "1";
                link.Data = [];
                var entry = {};
                entry.Query = "select * from tblJSONData where appName ='"+  $scope.appName +"' and objectName = '" + objParam + "' order by key";
                entry.FunctionOnReturn = FunctionOnReturn;
                entry.InsertOnReturn = "Y";
                link.Data.push(entry);
                link = "MiTokn" + JSON.stringify(link);
                var _frameRefresh = document.createElement('iframe');
                _frameRefresh.width = 0; _frameRefresh.height = 0; _frameRefresh.frameBorder = 0;
                document.body.appendChild(_frameRefresh);
                
                try {
                    if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
                        window.HtmlCommunicator.getDataFromHTML(link); 
                    }else{
                        _frameRefresh.src = link;
                    };
                }
                catch (err){
                    $scope.log("windows changes for sync " + err.message());
                };
                setTimeout(function () { document.body.removeChild(_frameRefresh); }, 300); 
            };

			/*Common: Function for MiTokn call*/
			$scope.callMiTokenFunction = function (link) {
				try {
					if (!link)
						throw 'Invalid link object.';

					link = 'MiTokn' + JSON.stringify(link);
					if ($scope.isEncodeUri)
						link = encodeURI(link);

					$scope.isEncodeUri = false;

					if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
						window.HtmlCommunicator.getDataFromHTML(link);
					} else {
						var _frame = document.createElement('iframe');
						_frame.width = 0;
						_frame.height = 0;
						_frame.frameBorder = 0;
						document.body.appendChild(_frame);
						_frame.src = link;
						setTimeout(function () { document.body.removeChild(_frame); }, 1000);
					}
				}
				catch (error) {
					console.log("Error in CallMiTokenFunction. Message: " + error);
				}
			};

			$scope.fetchData = (connectionObjectName, recordId, responceMethodName) => {
				try {
					var link = {
						Instr: "DataFetch",
						App: $scope.appName,
						Object: connectionObjectName,
						Seq: "1",
						InsertOnReturn: "N",
						URLAdd: recordId,
						FunctionOnReturn: responceMethodName
					};
					$scope.callMiTokenFunction(link);
				}
				catch (error) {
					console.log("Error occurred in fetchData function. Message: " + error);
				}
			};
          
			$scope.getWeekendingDate = function () {

				try {
					var desiredWeekday = $scope.desiredWeekday;
					var selectedday = moment($scope.selectDate).isoWeekday();
					var selectdate = moment($scope.selectDate);
					var nextThursday = selectdate.add(((desiredWeekday - selectedday) + 7) % 7, "days");
					$scope.outputWEDate = nextThursday.format('DD/MM/YYYY');
					$scope.rawOutputWEDate = nextThursday.toDate();
				} catch (err) {
					alert("error in getWeekendingDate");
				};

			};

			$scope.addLineItemtoTimesheets = function (timesheet) {
				try {
					var index = -1;
					for (var i = 0; i < $scope.timesheets.length; i++) {
						if($scope.timesheets[i].WeekEndingDate.includes("/")){
							var date1 = new Date(Number($scope.timesheets[i].WeekEndingDate.substring(6, 19)));
						}else{
							var date1 =new Date($scope.timesheets[i].WeekEndingDate);
						};
						if(timesheet.WeekEndingDate.includes("/")){
							var date2 = new Date(Number(timesheet.WeekEndingDate.substring(6, 19)));
						}else{
							var date2 =new Date(timesheet.WeekEndingDate);
						};
					
						if ($scope.getddmmyyyy(date1) === $scope.getddmmyyyy(date2)) {
							index = i;
							break;
						};
					};
					if (index == -1) {
						$scope.timesheets.push(timesheet);
					} else {
						/*$scope.timesheets[index].STATE = "new";*/
						for (var i = 0; i < timesheet.LineItems.length; i++) {
							$scope.timesheets[index].LineItems.push(timesheet.LineItems[i]);
						};
					};
				} catch (err) {
					alert("Error in addLineItemtoTimesheets");
				};
			};

			$scope.zeroPrefix = function (input) {

				if (input.length < 2) {
					input = "0".concat(input);
				};
				return input;
			};
			

			$scope.resetHoursPerDay = function () {
				$scope.hoursperday = [
					{ "Id":0, "Day": "Sun", "Hours": 0, "Date": "", "startTime": "", "endTime": "", "travelHr": "", "travelKm": "", "standBy":"","delay":"" },
					{ "Id":1, "Day": "Mon", "Hours": 0, "Date": "", "startTime": "", "endTime": "", "travelHr": "", "travelKm": "", "standBy":"","delay":""},
					{ "Id":2, "Day": "Tue", "Hours": 0, "Date": "", "startTime": "", "endTime": "", "travelHr": "", "travelKm": "", "standBy":"","delay":""},
					{ "Id":3, "Day": "Wed", "Hours": 0, "Date": "", "startTime": "", "endTime": "", "travelHr": "", "travelKm": "", "standBy":"","delay":""},
					{ "Id":4, "Day": "Thu", "Hours": 0, "Date": "", "startTime": "", "endTime": "", "travelHr": "", "travelKm": "", "standBy":"","delay":""},
					{ "Id":5, "Day": "Fri", "Hours": 0, "Date": "", "startTime": "", "endTime": "", "travelHr": "", "travelKm": "", "standBy":"","delay":""},
					{ "Id":6, "Day": "Sat", "Hours": 0, "Date": "", "startTime": "", "endTime": "", "travelHr": "", "travelKm": "", "standBy":"","delay":""},
					{ "Id":7, "Day": "Sun", "Hours": 0, "Date": "", "startTime": "", "endTime": "", "travelHr": "", "travelKm": "", "standBy":"","delay":""},
					{ "Id":8, "Day": "Mon", "Hours": 0, "Date": "", "startTime": "", "endTime": "", "travelHr": "", "travelKm": "", "standBy":"","delay":""},
					{ "Id":9, "Day": "Tue", "Hours": 0, "Date": "", "startTime": "", "endTime": "", "travelHr": "", "travelKm": "", "standBy":"","delay":""},
					{ "Id":10, "Day": "Wed", "Hours": 0, "Date": "", "startTime": "", "endTime": "", "travelHr": "", "travelKm": "", "standBy":"","delay":""},
					{ "Id":11, "Day": "Thu", "Hours": 0, "Date": "", "startTime": "", "endTime": "", "travelHr": "", "travelKm": "", "standBy":"","delay":""},
					{ "Id":12, "Day": "Fri", "Hours": 0, "Date": "", "startTime": "", "endTime": "", "travelHr": "", "travelKm": "", "standBy":"","delay":""},
					{ "Id":13, "Day": "Sat", "Hours": 0, "Date": "", "startTime": "", "endTime": "", "travelHr": "", "travelKm": "", "standBy":"","delay":""},
					{ "Id":14, "Day": "Total", "Hours": 0, "Date": "", "startTime": "", "endTime": "","extraHours":"" },
				];

			};

			
			$scope.calcDatePerDay = function (index) {
				var days = [ "Monday", "Tuesday", "Wednesday","Thursday", "Friday", "Saturday","Sunday"];
				var dat = $scope.selectDate;
				for (x = 0; x < 14; x++) {
					var d = new Date(dat);
					d.setDate(d.getDate() + (x));
					dateformat = $scope.getddmmyyyy(d);
					$scope.hoursperday[x].Date = dateformat;
				};
			};

			$scope.stripNonDigits = function(input){
				try {
					return input.replace(/\D/g,'');
				}
				catch (err){
					return input;
				};
			};

			$scope.removeTrZero = function(param,index){
				if(param=="Daily"){
					if($scope.travelHr==0){
						$scope.travelHr="";
					};
				};
				if(param=="Weekly"){
					if($scope.perDayTravelHr[index]==0){
						$scope.perDayTravelHr[index]="";
					};
				};

			};

			$scope.initTrZero = function(param,index){
				if(param=="Daily"){
					if($scope.travelHr=="" || $scope.travelHr==null){
						$scope.travelHr=0;
					};
				};
				if(param=="Weekly"){
					if($scope.perDayTravelHr[index]=="" || $scope.perDayTravelHr[index]==null){
						$scope.perDayTravelHr[index]=0;
					};
				};

			};

			$scope.calcTotalHours = function () {
				var totalmins = 0;

				for (var z = 0; z < $scope.hoursperday.length - 1; z++) {
					var mins = 0;
					var splitAT = ":";
					if($scope.hoursperday[z].Hours == '0.00'){
						$scope.hoursperday[z].Hours = 0;
					};
					if (typeof ($scope.hoursperday[z].Hours) == 'string') {
						if ($scope.hoursperday[z].Hours.length === 2) {						
							$scope.hoursperday[z].Hours += ":00";
						};
					
						if ($scope.hoursperday[z].Hours.indexOf(":") > -1) {
							splitAT = ":";
						};
						var timearr = $scope.hoursperday[z].Hours.split(splitAT);
				
						/*Remove anything that is isnt a number from the individual fields*/
						
						timearr[0] = $scope.stripNonDigits(timearr[0]);
						timearr[1] = $scope.stripNonDigits(timearr[1]);
						
						mins = parseInt(timearr[0]) * 60 + parseInt(timearr[1]);
						totalmins += mins;
					};
				};

				var hours = parseInt(totalmins / 60).toString();
				mins = (totalmins % 60).toString();
				/*mins = (mins/60).toFixed(2);*/
				$scope.hoursperday[14].Hours = hours + ":" + ("0" + mins).slice(-2);

				/*cal total travel hours*/
			};

			$scope.getDate = function (inputDate) {
				var dat;
				if (inputDate.indexOf("Date") !== -1) {
					dat = new Date(Number(inputDate.substring(6, 19)));
				}
				else {
					dat = new Date();
					var splitchar = "-";
					if (inputDate.indexOf("/") != -1) {
						splitchar = "/";
						var segDat = inputDate.split(splitchar);

						dat.setFullYear(parseInt(segDat[2]));
						dat.setDate(parseInt(segDat[0]));
						var _month = parseInt(segDat[1]);
						_month = _month - 1;
						dat.setMonth(_month);
						dat = new Date(segDat[2], _month, segDat[0], 08, 00, 0);

					} else {
						var segDat = inputDate.split(splitchar);
						dat.setFullYear(parseInt(segDat[0]));
						dat.setMonth(parseInt(segDat[1]) - 1);
						dat.setDate(parseInt(segDat[2]));
					};

				};
				return dat;
			};

			$scope.setTimeSheet = function (index) {
				$scope.selectedWeekEnding = index;
				$('.off-canvas').removeClass('open');
				$('body').removeClass('expand');
				$('.hm-btn').removeClass('open');
			};

			$scope.selectableDate = function (date) {
				var day = date.getDay();
				var today = new Date();
				return day === 0;				
			};



			$scope.checkDataEntry = function (param) {

				if ($scope.testdata === false ) {

					if ($scope.toknUser.name =='Universal' && ($scope.selectedEmployee.code == undefined || $scope.selectedEmployee.code == ""))  {
						$scope.msgOnError('User Required', 'Please select User');
						return false;
					};
					
					if ($scope.jobname == undefined || $scope.jobname == "") {
						$scope.msgOnError('Job Code Required', 'Please enter Job Code');
						return false;
					};

					if ($scope.selectedUserNameList == [] || $scope.selectedUserNameList.length == 0) {
						$scope.msgOnError('User is Required', 'Please select atleast one user');
						return false;
					};
					if ($scope.selectedSite.FullName == '' || $scope.selectedSite.FullName == null || $scope.selectedSite.FullName == undefined ) {
						$scope.msgOnError('Site is Required', 'Please select atleast one site');
						return false;
					};

					if(!$scope.travel && param == 'Daily' && $scope.newLineItems.length == 0){
						if ($scope.time.hoursWorked == "0.00" || $scope.time.hoursWorked == "00:00")
						{
							$scope.msgOnError('Total Hours Required','Please select number of hours and mins');
							return false;
						};
					}

						
				};
				return true;

			};

			$scope.checkOverlapTimes = (param, specificDate, startTimeStamp, endTimeStamp)=>{
				try{
					$scope.getWeekendingDate();
					$scope.selectedDate = moment(specificDate).format("DD/MM/YYYY");
					var selectedDateSplit = angular.copy($scope.selectedDate.split('/'));
					startTimeStamp.setYear(selectedDateSplit[2]);
					startTimeStamp.setMonth(parseInt(selectedDateSplit[1])-1);
					startTimeStamp.setDate(selectedDateSplit[0]);
					startTimeStamp.setSeconds(0);
					startTimeStamp.setMilliseconds(0);
					let startTime = moment(startTimeStamp).format('HH:mm');

					endTimeStamp.setYear(selectedDateSplit[2]);
					endTimeStamp.setMonth(parseInt(selectedDateSplit[1])-1);
					endTimeStamp.setDate(selectedDateSplit[0]);
					endTimeStamp.setSeconds(0);
					endTimeStamp.setMilliseconds(0);
					let endTime = moment(endTimeStamp).format('HH:mm');

					let WEEkENDdate = new Date($scope.rawOutputWEDate).getTime();
					WEEkENDdate = "/Date(" + WEEkENDdate.toString() + ")/";
					let index = $scope.checkIfWeekendingExists(WEEkENDdate);

					if(index != -1){
						for(let y = 0; y < $scope.timesheets[index].LineItems.length; y++) {
							if($scope.selectedDate == $scope.timesheets[index].LineItems[y].ListDate){
								if($scope.timesheets[index].LineItems[y].ActivityType != 'Disbursement'){ //&& $scope.timesheets[index].LineItems[y].ActivityType != 'Supplementary'){
									if($scope.editTAG === $scope.timesheets[index].LineItems[y].TAG){
										continue;
									};
									if($scope.timesheets[index].LineItems[y].STATE == 'Rejected'){
										continue;
									};
									if($scope.timesheets[index].LineItems[y].TYPE == 'Daily'){
										var timesheetDate = angular.copy($scope.timesheets[index].LineItems[y].ListDate.split('/'));
										var time = $scope.timesheets[index].LineItems[y].StartTime.split(':');
										var timesheetStartDateTime = new Date(timesheetDate[2],(parseInt(timesheetDate[1]) - 1), timesheetDate[0] );
										timesheetStartDateTime.setHours(time[0]);
										timesheetStartDateTime.setMinutes(time[1]);
										timesheetStartDateTime.setSeconds(0);
										timesheetStartDateTime.setMilliseconds(0);

										var time1 = $scope.timesheets[index].LineItems[y].FinishTime.split(':');
										var timesheeEndDateTime = new Date(timesheetDate[2],(parseInt(timesheetDate[1]) - 1), timesheetDate[0] );
										timesheeEndDateTime.setHours(time1[0]);
										timesheeEndDateTime.setMinutes(time1[1]);
										timesheeEndDateTime.setSeconds(0);
										timesheeEndDateTime.setMilliseconds(0);

										const current = $scope.checkStartTimeEndTime(startTimeStamp.getTime(), endTimeStamp.getTime());
										const exist = $scope.checkStartTimeEndTime(timesheetStartDateTime.getTime(), timesheeEndDateTime.getTime())
										
										if(current && exist){
											const {first,second} = $scope.splitDates(startTimeStamp, endTimeStamp);
											const Exist = $scope.splitDates(timesheetStartDateTime, timesheeEndDateTime);
											if($scope.checkIsTimeExist(first.start.toDate().getTime(), first.end.toDate().getTime(), Exist.first.start.toDate().getTime(), Exist.first.end.toDate().getTime()) 
												|| $scope.checkIsTimeExist(second.start.toDate().getTime(), second.end.toDate().getTime(), Exist.second.start.toDate().getTime(), Exist.second.end.toDate().getTime())
												|| $scope.checkIsTimeExist(first.start.toDate().getTime(), first.end.toDate().getTime(), Exist.second.start.toDate().getTime(), Exist.second.end.toDate().getTime()) 
												|| $scope.checkIsTimeExist(second.start.toDate().getTime(), second.end.toDate().getTime(), Exist.first.start.toDate().getTime(), Exist.first.end.toDate().getTime())){
												return true;
											}
										}
										else if(current && !exist){
											const {first,second} = $scope.splitDates(startTimeStamp, endTimeStamp);
											if($scope.checkIsTimeExist(first.start.toDate().getTime(), first.end.toDate().getTime(), timesheetStartDateTime.getTime(), timesheeEndDateTime.getTime()) 
												|| $scope.checkIsTimeExist(second.start.toDate().getTime(), second.end.toDate().getTime(), timesheetStartDateTime.getTime(), timesheeEndDateTime.getTime())){
												return true;
											}
										}
										else if(!current && exist){
											const {first,second} =	$scope.splitDates(timesheetStartDateTime, timesheeEndDateTime);
											if($scope.checkIsTimeExist(startTimeStamp.getTime(), endTimeStamp.getTime(), first.start.toDate().getTime(), first.end.toDate().getTime())
												|| $scope.checkIsTimeExist(startTimeStamp.getTime(), endTimeStamp.getTime(), second.start.toDate().getTime(), second.end.toDate().getTime())){
												return true;
											}
										}
										else{
											if($scope.checkIsTimeExist(startTimeStamp.getTime(), endTimeStamp.getTime(), timesheetStartDateTime.getTime(), timesheeEndDateTime.getTime())){
												return true;
											}
										}

										// if((startTimeStamp.getTime()) <  (timesheeEndDateTime.getTime()) && (timesheetStartDateTime.getTime()) < (endTimeStamp.getTime())){
										// 	console.log("old Overlap timings ====>",timesheetStartDateTime,"<-->",timesheeEndDateTime);
										// 	console.log("current Overlap timings ====>",startTimeStamp,"<-->",endTimeStamp);
										// 	$scope.msgOnError("Duplicate", "You already have a timesheet for the same timings");
										// 	return true;
										// }

									}
									else if($scope.timesheets[index].LineItems[y].TYPE == 'Weekly'){
										var timesheetDate = angular.copy($scope.timesheets[index].LineItems[y].ListDate.split('/'));
										var time = $scope.timesheets[index].LineItems[y].StartTime.split(':');
										var timesheetStartDateTime = new Date(timesheetDate[2],(parseInt(timesheetDate[1]) - 1), timesheetDate[0] );
										timesheetStartDateTime.setHours(time[0]);
										timesheetStartDateTime.setMinutes(time[1]);
										timesheetStartDateTime.setSeconds(0);
										timesheetStartDateTime.setMilliseconds(0);

										var time1 = $scope.timesheets[index].LineItems[y].FinishTime.split(':');
										var timesheeEndDateTime = new Date(timesheetDate[2],(parseInt(timesheetDate[1]) - 1), timesheetDate[0] );
										timesheeEndDateTime.setHours(time1[0]);
										timesheeEndDateTime.setMinutes(time1[1]);
										timesheeEndDateTime.setSeconds(0);
										timesheeEndDateTime.setMilliseconds(0);

										const current = $scope.checkStartTimeEndTime(startTimeStamp.getTime(), endTimeStamp.getTime());
										const exist = $scope.checkStartTimeEndTime(timesheetStartDateTime.getTime(), timesheeEndDateTime.getTime())
										
										if(current && exist){
											const {first,second} = $scope.splitDates(startTimeStamp, endTimeStamp);
											const Exist = $scope.splitDates(timesheetStartDateTime, timesheeEndDateTime);
											if($scope.checkIsTimeExist(first.start.toDate().getTime(), first.end.toDate().getTime(), Exist.first.start.toDate().getTime(), Exist.first.end.toDate().getTime()) 
												|| $scope.checkIsTimeExist(second.start.toDate().getTime(), second.end.toDate().getTime(), Exist.second.start.toDate().getTime(), Exist.second.end.toDate().getTime())
												|| $scope.checkIsTimeExist(first.start.toDate().getTime(), first.end.toDate().getTime(), Exist.second.start.toDate().getTime(), Exist.second.end.toDate().getTime()) 
												|| $scope.checkIsTimeExist(second.start.toDate().getTime(), second.end.toDate().getTime(), Exist.first.start.toDate().getTime(), Exist.first.end.toDate().getTime())){
												return true;
											}
										}
										else if(current && !exist){
											const {first,second} = $scope.splitDates(startTimeStamp, endTimeStamp);
											if($scope.checkIsTimeExist(first.start.toDate().getTime(), first.end.toDate().getTime(), timesheetStartDateTime.getTime(), timesheeEndDateTime.getTime()) 
												|| $scope.checkIsTimeExist(second.start.toDate().getTime(), second.end.toDate().getTime(), timesheetStartDateTime.getTime(), timesheeEndDateTime.getTime())){
												return true;
											}
										}
										else if(!current && exist){
											const {first,second} =	$scope.splitDates(timesheetStartDateTime, timesheeEndDateTime);
											if($scope.checkIsTimeExist(startTimeStamp.getTime(), endTimeStamp.getTime(), first.start.toDate().getTime(), first.end.toDate().getTime())
												|| $scope.checkIsTimeExist(startTimeStamp.getTime(), endTimeStamp.getTime(), second.start.toDate().getTime(), second.end.toDate().getTime())){
												return true;
											}
										}
										else{
											if($scope.checkIsTimeExist(startTimeStamp.getTime(), endTimeStamp.getTime(), timesheetStartDateTime.getTime(), timesheeEndDateTime.getTime())){
												return true;
											}
										}

										// if((startTimeStamp.getTime()) <  (timesheeEndDateTime.getTime()) && (timesheetStartDateTime.getTime()) < (endTimeStamp.getTime())){
										// 	console.log("old Overlap timings ====>",timesheetStartDateTime,"<-->",timesheeEndDateTime);
										// 	console.log("current Overlap timings ====>",startTimeStamp,"<-->",endTimeStamp);
										// 	$scope.msgOnError("Duplicate", "You already have a timesheet for the same timings");
										// 	return true;
										// }
										
									};
								};
								
							};
							
						};
					};
				}
				catch(err){
					console.log("error occured in checkOverlapTimes ",err);
				};
			};


			$scope.getTimesheetsOfDaily = (param, specificDate)=>{
				try{
					$scope.getWeekendingDate();
					$scope.selectedDate = moment(specificDate).format("DD/MM/YYYY");
					let WEEkENDdate = new Date($scope.rawOutputWEDate).getTime();
					WEEkENDdate = "/Date(" + WEEkENDdate.toString() + ")/";
					let index = $scope.checkIfWeekendingExists(WEEkENDdate);

					let totalmins = 0;
					let totalHours = 0;
					$scope.standardTimesheetExist = false;
					if(index != -1){
						for(let y = 0; y < $scope.timesheets[index].LineItems.length; y++) {
							if($scope.selectedDate == $scope.timesheets[index].LineItems[y].ListDate){
								if($scope.timesheets[index].LineItems[y].ActivityType != 'Disbursement' && $scope.timesheets[index].LineItems[y].ActivityType != 'TravelFWTD' && $scope.timesheets[index].LineItems[y].ActivityType != 'TravelFDTW' && $scope.editTAG != $scope.timesheets[index].LineItems[y].TAG){
									if($scope.timesheets[index].LineItems[y].STATE=="Rejected"){
										continue;
									};
									var mins = 0;
									let splitAT = ":";
									let LTQuantity;
									if($scope.timesheets[index].LineItems[y].STATE=="Saved"){
										LTQuantity = $scope.timesheets[index].LineItems[y].Quantity;
									}else{
										LTQuantity = $scope.convertQuantity($scope.timesheets[index].LineItems[y].Quantity);
									};
									
									if (typeof (LTQuantity) == 'string') {
										if (LTQuantity.length === 2) {						
											LTQuantity += ":00";
										};
									
										if (LTQuantity.indexOf(":") > -1) {
											splitAT = ":";
										};
										let timearr = LTQuantity.split(splitAT);
								
										/*Remove anything that is isnt a number from the individual fields*/
										
										timearr[0] = $scope.stripNonDigits(timearr[0]);
										timearr[1] = $scope.stripNonDigits(timearr[1]);
										
										mins = parseInt(timearr[0]) * 60 + parseInt(timearr[1]);
										totalmins += mins;
									};
								}
							}
						};
					}

					let hours = parseInt(totalmins / 60).toString();
					mins = (totalmins % 60).toString();
					var totHours  = (hours + ":" + ("0" + mins).slice(-2)).replace(':','.')
					$scope.StandardDayHours = "08:00";
					let standardDayHours = $scope.StandardDayHours.replace(':','.');
					if(parseFloat(standardDayHours) < parseFloat(totHours)){
						$scope.standardTimesheetExist = true;
						return;
					}

					return totalHours = hours + ":" + ("0" + mins).slice(-2);
				}
				catch(err){
					console.log("error occured in checkDayTotalHours ",err);
				};
			};

			$scope.splitDates = (startTime,endTime)=>{
				return ({first:{'start':moment(startTime), end: moment(startTime).endOf('day')}, second:{start: moment(startTime).startOf('day'), end :moment(endTime) }})
			}

			$scope.checkStartTimeEndTime = (startTimeStamp, endTimeStamp)=>{
				try{
					return startTimeStamp > endTimeStamp;
				}
				catch(err){
					
				}
			};
			$scope.checkIsTimeExist = (startTimeStamp, endTimeStamp, timesheetStartDateTime, timesheeEndDateTime)=>{
				try{
					const start = moment(timesheetStartDateTime);
					const end = moment(timesheeEndDateTime);
					if((moment(startTimeStamp) > start && moment(startTimeStamp) < end ) || (moment(endTimeStamp) > start && moment(endTimeStamp) < end ) || (moment(endTimeStamp) >= end && moment(startTimeStamp) <= start )){
						console.log("old Overlap timings ====>",moment(timesheetStartDateTime),"<-->",moment(timesheeEndDateTime));
						console.log("current Overlap timings ====>",moment(startTimeStamp),"<-->",moment(endTimeStamp));
						return true;
					};
					return false;
				}
				catch(err){
					
				};
			};

			$scope.CalFinishTime = function (startTime, qty){
				var startObj = new Date("1970-01-01T" + startTime  +".000+08:00");
				var finishObj  = startObj;
				finishObj.setTime(startObj.getTime() + (qty*60 * 60 * 1000));
				return finishObj.toTimeString().split(' ')[0];
			};
			$scope.checkMailAddress = function (email) {
    			var re = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;
    			return re.test(String(email).toLowerCase());
			};

			$scope.checkExternalMailAddresses = function(){
				if ($scope.externalemail != "") {
					try {
						/* split the string by comma in case of multiple addresses */
						$scope.externalemail = $scope.externalemail.replace(/\s/g, '');
						$scope.externalemail = $scope.externalemail.replace(/[:;]/g, ',');
						
						var _recList = $scope.externalemail.split(",");
						var _uniqueItems = Array.from(new Set(_recList));
						for (x = 0; x < _uniqueItems.length; x++) {
							var addto = {};
							if (!$scope.checkMailAddress(_uniqueItems[x])){
								return false;
							};
						};
						return true;
					}
					catch (err) {
						return false;
					};
				};
				return true;
			};
			$scope.checkSupervisorEmailAddresses = function(){
				if ($scope.supervisorEmail != "") {
					try {
						/* split the string by comma in case of multiple addresses */
						if (!$scope.checkMailAddress(angular.copy($scope.supervisorEmail))){
							return false;
						};						
						return true;
					}
					catch (err) {
						return false;
					};
				};
				return true;
			};
			$scope.checkIfWeekendingExists = function (WEdate) {
				var index = -1;
				var date2 = new Date(Number(WEdate.substring(6, 19)));
				for (var i = 0; i < $scope.timesheets.length; i++) {
					if($scope.timesheets[i].WeekEndingDate.includes("/")){
						var date1 = new Date(Number(angular.copy($scope.timesheets[i].WeekEndingDate.substring(6, 19))));
					}else{
						var date1 = new Date(angular.copy($scope.timesheets[i].WeekEndingDate));
					};

					if ($scope.getddmmyyyy(date1) === $scope.getddmmyyyy(date2)) {
						index = i;
						break;
					};
				};

				return index;
			};

			$scope.resetTimesheetsIndexes = function () {

				for (var x = 0; x < $scope.timesheets.length; x++) {
					$scope.timesheets[x].tsIndex = x;
				};

			};

			$scope.resetchkforKMS = function ( value){
				$scope.chkforKMS = value;
			};

			$scope.getLeaveRequestData = (timesheetType, selectedDate)=>{
				console.log("User Code ==>",$scope.user.Code, selectedDate);
				try{
					var link = {};
					link.Instr = "DataFetch";
					link.App = $scope.appName;
					link.Object = "LeaveRequestData";
					link.Seq = "1";
					link.FunctionOnReturn = "setLeaveRequestData";
					if(timesheetType == "Daily")
						link.URLAdd = "?person="+$scope.user.Code+"&fromDate="+selectedDate;
					else if(timesheetType == "Weekly")
						link.URLAdd = "?person="+$scope.user.Code+"&fromDate="+moment(selectedDate).subtract(7,"days").format("YYYY-MM-DD") +"&toDate="+selectedDate;
					link.InsertOnReturn = "Y";
					link = "MiTokn" + JSON.stringify(link);
					link = encodeURI(link);
					console.log("leaveRequestData link=>"+link);

                    var _frameRefresh = document.createElement('iframe');
                    _frameRefresh.width = 0; _frameRefresh.height = 0; _frameRefresh.frameBorder = 0;
                    document.body.appendChild(_frameRefresh);
                    if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
                        window.HtmlCommunicator.getDataFromHTML(link);
                    } else {
                        _frameRefresh.src = link;
                    };
                    setTimeout(function () { document.body.removeChild(_frameRefresh); }, 5000);
				}
				catch(err){
					$scope.log("getLeaveRequestData:"+err.message);
				};
			};

			$scope.checkWithCurrentTimings = (date, startTimeStamp, endTimeStamp, timesheetStartDateTime, timesheeEndDateTime)=>{
				try{

					date = moment(date).format("DD/MM/YYYY");
					var selectedDateSplit = angular.copy(date.split('/'));
					startTimeStamp.setYear(selectedDateSplit[2]);
					startTimeStamp.setMonth(parseInt(selectedDateSplit[1])-1);
					startTimeStamp.setDate(selectedDateSplit[0]);
					startTimeStamp.setSeconds(0);
					startTimeStamp.setMilliseconds(0);

					endTimeStamp.setYear(selectedDateSplit[2]);
					endTimeStamp.setMonth(parseInt(selectedDateSplit[1])-1);
					endTimeStamp.setDate(selectedDateSplit[0]);
					endTimeStamp.setSeconds(0);
					endTimeStamp.setMilliseconds(0);
					
					timesheetStartDateTime.setYear(selectedDateSplit[2]);
					timesheetStartDateTime.setMonth(parseInt(selectedDateSplit[1])-1);
					timesheetStartDateTime.setDate(selectedDateSplit[0]);
					timesheetStartDateTime.setSeconds(0);
					timesheetStartDateTime.setMilliseconds(0);

					timesheeEndDateTime.setYear(selectedDateSplit[2]);
					timesheeEndDateTime.setMonth(parseInt(selectedDateSplit[1])-1);
					timesheeEndDateTime.setDate(selectedDateSplit[0]);
					timesheeEndDateTime.setSeconds(0);
					timesheeEndDateTime.setMilliseconds(0);

					const current = $scope.checkStartTimeEndTime(startTimeStamp.getTime(), endTimeStamp.getTime());
					const exist = $scope.checkStartTimeEndTime(timesheetStartDateTime.getTime(), timesheeEndDateTime.getTime())
					
					if(current && exist){
						const {first,second} = $scope.splitDates(startTimeStamp, endTimeStamp);
						const Exist = $scope.splitDates(timesheetStartDateTime, timesheeEndDateTime);
						if($scope.checkIsTimeExist(first.start.toDate().getTime(), first.end.toDate().getTime(), Exist.first.start.toDate().getTime(), Exist.first.end.toDate().getTime()) 
							|| $scope.checkIsTimeExist(second.start.toDate().getTime(), second.end.toDate().getTime(), Exist.second.start.toDate().getTime(), Exist.second.end.toDate().getTime())
							|| $scope.checkIsTimeExist(first.start.toDate().getTime(), first.end.toDate().getTime(), Exist.second.start.toDate().getTime(), Exist.second.end.toDate().getTime()) 
							|| $scope.checkIsTimeExist(second.start.toDate().getTime(), second.end.toDate().getTime(), Exist.first.start.toDate().getTime(), Exist.first.end.toDate().getTime())){
							return true;
						}
					}
					else if(current && !exist){
						const {first,second} = $scope.splitDates(startTimeStamp, endTimeStamp);
						if($scope.checkIsTimeExist(first.start.toDate().getTime(), first.end.toDate().getTime(), timesheetStartDateTime.getTime(), timesheeEndDateTime.getTime()) 
							|| $scope.checkIsTimeExist(second.start.toDate().getTime(), second.end.toDate().getTime(), timesheetStartDateTime.getTime(), timesheeEndDateTime.getTime())){
							return true;
						}
					}
					else if(!current && exist){
						const {first,second} =	$scope.splitDates(timesheetStartDateTime, timesheeEndDateTime);
						if($scope.checkIsTimeExist(startTimeStamp.getTime(), endTimeStamp.getTime(), first.start.toDate().getTime(), first.end.toDate().getTime())
							|| $scope.checkIsTimeExist(startTimeStamp.getTime(), endTimeStamp.getTime(), second.start.toDate().getTime(), second.end.toDate().getTime())){
							return true;
						}
					}
					else{
						if($scope.checkIsTimeExist(startTimeStamp.getTime(), endTimeStamp.getTime(), timesheetStartDateTime.getTime(), timesheeEndDateTime.getTime())){
							return true;
						}
					}
					return false;
				}
				catch(err){}
			};

			$scope.checkOverlapTimesOnDaily = (param)=>{
				try{
					if($scope.time.hoursWorked != "0.00" && $scope.time.hoursWorked != "00:00"){
						if($scope.checkOverlapTimes(param, $scope.selectDate, $scope.time.startTime, $scope.time.endTime)){
							$scope.msgOnError("Duplicate timesheet", "You already have a timesheet for the same timings on "+moment($scope.selectDate).format("DD/MM/YYYY"));
							return true;
						};
					}
					return false;
				}
				catch(err){};
			};
			$scope.checkOverlapTimesOnWeekly = (param)=>{
				try{
					if($scope.dayEntry.Hours != 0 && $scope.dayEntry.Hours != "00:00" && $scope.dayEntry.Hours != "0:00"){
						if($scope.checkOverlapTimes(param, moment($scope.dayEntry.Date, "DD/MM/YYYY").toDate(), $scope.dayEntry.startTime, $scope.dayEntry.endTime)){
							$scope.msgOnError("Duplicate timesheet", "You already have a timesheet for the same timings on "+$scope.dayEntry.Date);
							$scope.pickerDayEndTime = $scope.pickerDayStartTime;
							$scope.pickerDayEnd.date = $scope.pickerDayStart.date;
							$scope.adjustDayTime();
							return true;
						};
					}
					return false;
				}
				catch(err){};
			};

			$scope.getSignatureCapture = function (param) {
				if ($scope.jobname ==""){
					$scope.msgOnError('Timesheet', 'Please enter job number before signing.');
					return;
				};
				if ((param == 'Daily') && ($scope.time.startTime == $scope.time.endTime ||$scope.time.hoursWorked === '0.00') && ($scope.travelHr ==0 || $scope.travelHr =="" ||$scope.travelHr==null)){
					$scope.msgOnError('Timesheet', 'Please enter worked time or travel time before signing.');
					return;
				};

				// if(param == 'Daily'){
				// 	if($scope.travel){
				// 		if($scope.travelHr===0||$scope.travelHr ==null ||$scope.travelHr =="" ){
				// 			$scope.msgOnError('Travel details required', 'Please enter Travel Hours and Travel Kms');
				// 			return;
				// 		};
				// 	};
				// };

				if (param == 'Weekly'){
					var totalTravel =0;
					for (var k = 0; k < $scope.hoursperday.length; k++) {
						if ($scope.hoursperday[k].travelHr !="" && $scope.hoursperday[k].travelHr !=0) {
							totalTravel += $scope.hoursperday[k].travelHr;
						};
					};

					if(($scope.hoursperday[7].Hours == 0||$scope.hoursperday[7].Hours =="0:00")  && totalTravel ==0){
						$scope.msgOnError('Timesheet', 'Please enter worked time or travel time before signing.');
						return;
					};

					// if($scope.travel){
					// 	if($scope.hoursperday[7].travelHr == 0 ||$scope.hoursperday[7].travelHr == undefined ){
					// 		$scope.msgOnError('Travel details missing', '');
					// 		return;
					// 	};
					// 	var countInvalidTraveled = 0;
					// 	for(var i =0; i< $scope.hoursperday.length;i++){

					// 		if( $scope.hoursperday[i].Day !="Total"){
					// 			if(($scope.hoursperday[i].travelHr !=0&& $scope.hoursperday[i].travelHr!=null)
					// 			||($scope.hoursperday[i].travelHr ==0 || $scope.hoursperday[i].travelHr==null)
					// 			){
					// 				countInvalidTraveled++;
					// 			};
					// 		};
					// 	};
					// 	/*if(countInvalidTraveled >0){
					// 		$scope.msgOnError('Travel details missing', 'Please enter Travel hours if you traveled');
					// 		return;
					// 	};*/
					// };
				};
				var uri = 'MiTokn{"Instr":"Signature","FunctionOnReturn":"signResponseCapture"}';
				var link = encodeURI(uri);
				window.location = link;
			};

			$scope.setSignatureCapture = function (data) {
				$scope.signatureName = data.Name;
				$scope.signature = "data:image/png;base64," + data.Signature;
				$scope.checkSignature();
			};

			$scope.createTimesheet = function (param, submit) {
				

				if (!$scope.checkDataEntry(param)) {
					return;
				};

				/*Deal with undefined user issue in payload - John nidoy issue in Jira
				if the user is undefined, then set it to &{user}& and the server will replace it
				with the userid on the connection*/
				if (!$scope.toknUser.userID){
					$scope.toknUser.userID = '&{user}&';
				};

				/* Checks if there is a duplicate in known timesheets, requires the TS Type  */

				if(param=='Daily' && $scope.checkOverlapTimesOnDaily(param)){
					return;
				};

				if($scope.checkDuplicateOnSubmitOrSave(param)) {
					return;
				};

				try{
					var test=$scope.selectDate.getMinutes();
				}catch(err){
					$scope.msgOnError("Timesheet", 'Please select the Date from date picker again!');
					return;
				};		
			
				// if ($scope.user.Code == undefined){
				// 	$scope.msgOnError("Timesheet", 'Please set Employee parameters in console');
				// 	return;
				// };
				if ($scope.showEmail&&$scope.signature == "" && $scope.supervisorEmail=="" && submit == true) {
					$scope.msgOnError("Signature", 'Supervisor Signature or email is required!');
					return;
				};
				
				if ($scope.signature != "" && submit == false) {
					$scope.msgOnError("Timesheet", 'Please submit as Supervisor has signed the Timesheet!');
					return;
				};
				try {
					$scope.jobname = $scope.jobname.toUpperCase();
				}
				catch (err){

				};
				if ((param == 'Daily') && ($scope.time.startTime == $scope.time.endTime)){
					$scope.msgOnError('Timesheet', 'No daily time entered.');
					return;
				};
				if ((param == 'Daily') && ($scope.TravelDataDaily.travelHr == "" || $scope.TravelDataDaily.travelHr == undefined)){
					$scope.msgOnError('Travel Hours is required', 'Please enter the travel hours');
					return;
				};
				

				try {
					if(param == 'Daily'){
						if (submit == false) {
							LineItem.selectedUserNameList = $scope.selectedUserNameList;
							LineItem.selectedUserList = $scope.selectedUserList;
                    	};
						if($scope.travel){

						};
					};
					if (param == 'Weekly'){
						if (submit == false) {
							LineItem.selectedUserNameList = $scope.selectedUserNameList;
							LineItem.selectedUserList = $scope.selectedUserList;
                    	};
						if($scope.travel){
						};
					};
				}
				catch (err){
					console.log("Error in createTimesheet => " + err.message);
				};

				/*if (submit == true) {
					// If not employee selected, set the selected employee to be the tokn user logged in
					if($scope.selectedEmployee.name == undefined ||$scope.selectedEmployee.name =="" ){
						for(var a=0; a< $scope.ToknUserList.length ;a++){
							if($scope.toknUser.name != "Universal" && $scope.ToknUserList[a].userID ==$scope.toknUser.userID){
								$scope.setSelectedEmployee($scope.ToknUserList[a]);
							};
						};
					};

				};*/

				try {					
					if(!$scope.travel){
						if((param == 'Weekly') && ($scope.hoursperday[14].Hours == 0 || $scope.hoursperday[14].Hours == "0:00")){
							$scope.msgOnError('Timesheet', 'No daily time entered.');
							return;
						}
					}
				}
				catch (err){

				};



				$scope.postTimesheetEntry ={};
				var newNotes ="";
				var genDataNewNotes ="";
				if($scope.MakeModel!=""){
					var mm = angular.copy($scope.MakeModel);
					var rf = angular.copy($scope.RegoFleet);					
					var sv = angular.copy($scope.SerialVIN);
					var kh = angular.copy($scope.KMHrS);
					if(mm.includes("\r\n")){						
						mm=mm.replace("\r\n","");
					};
					if(rf.includes("\r\n")){				
						rf=rf.replace("\r\n","");
					};
					if(sv.includes("\r\n")){
						sv=sv.replace("\r\n","");
					};
					if(kh.includes("\r\n")){
						kh=kh.replace("\r\n","");
					};
					
					newNotes = "Make/Model:"+ mm+
						"%5Cr%5CnRego/Fleet:"+rf +
						"%5Cr%5CnSerial/VIN:"+sv +
						"%5Cr%5CnKms/Hours:"+kh + 
						"%5Cr%5Cn"+ $scope.NotesLeft;
					genDataNewNotes = "Make/Model:"+ mm+
						"%5Cr%5CnRego/Fleet:"+rf +
						"%5Cr%5CnSerial/VIN:"+sv +
						"%5Cr%5CnKms/Hours:"+kh + 
						"  "+ $scope.NotesLeft;	
				};
				
				var dat = new Date();
				if (param === 'Weekly') {
					$scope.lockWeekly = true;			
					dat = new Date($scope.selectDate).getTime();
					$scope.rawOutputWEDate = $scope.selectDate;
				};
				if (param === 'Daily') {
					$scope.lockDaily = true;
					$scope.externalLock =true;
					$scope.getWeekendingDate();
					dat = new Date($scope.rawOutputWEDate).getTime();
				};

				var newTimeEntry = {};
				var timeNow=new Date().getTime();
				// $scope.uniqueTimesheetno = $scope.user.Code + "-" + timeNow;
				newTimeEntry.PDFNo= $scope.uniqueTimesheetno;
				newTimeEntry.TYPE = param;
				/*newTimeEntry.STATE = 'new';*/

				/*generic replacement of userid in case not found so the */
				if ($scope.toknUser.userID == undefined){
					$scope.toknUser.userID = '&{user}&';
				};
				if ($scope.editTAG === "None") {
					if($scope.toknUser.name == "Universal")
						newTimeEntry.TAG = $scope.selectedEmployee.obj.userID+"-"+param + "-" + new moment().format("YYYYMMDDTHHmmss");
					else
						newTimeEntry.TAG = $scope.toknUser.userID+"-"+param + "-" + new moment().format("YYYYMMDDTHHmmss");
				} else {
					newTimeEntry.TAG = $scope.editTAG;
				};

				var WEDate;
				WEDate = new Date(dat);
				WEDate = $scope.getddmmyyyy(WEDate);

				var timesheetSelectDate;
				var selectDay = new Date($scope.selectDate).getTime();
				timesheetSelectDate = new Date(selectDay);
				timesheetSelectDate = $scope.getddmmyyyy(timesheetSelectDate);

				newTimeEntry.WeekEndingDate = "/Date(" + dat.toString() + ")/";
				newTimeEntry.ListDate = WEDate;
				newTimeEntry.TimesheetSelectDate = timesheetSelectDate;
				newTimeEntry.Employee = $scope.user.UsualName;
				if($scope.toknUser.name == "Universal")
				{
					newTimeEntry.USER=$scope.selectedEmployee.obj.userID;
					newTimeEntry.ToknUser =$scope.selectedEmployee.obj.userID;
				}
				else
				{
					newTimeEntry.USER=$scope.toknUser.userID;
					newTimeEntry.ToknUser =$scope.toknUser.userID;
				};
				
				newTimeEntry.supervisorEmail =$scope.supervisorEmail;
				newTimeEntry.TimesheetType ="JCTimesheet";
				newTimeEntry.rejectReason = "";
				newTimeEntry.MakeModel = $scope.MakeModel;
				newTimeEntry.RegoFleet = $scope.RegoFleet;
				newTimeEntry.SerialVIN = $scope.SerialVIN;
				newTimeEntry.KMHrS = $scope.KMHrS;
				newTimeEntry.NotesLeft = $scope.NotesLeft;

				if ($scope.signature === "" ){
					newTimeEntry.Level1="Approved";
				}else{
					newTimeEntry.Level1="Approved";
				};
				newTimeEntry.Level2="Pending";
				newTimeEntry.LineItems = [];
				
				var state = "Saved";
				if (submit == true) {
					state = "Pending";
				};
				if (param == 'Daily') {
					if($scope.time.hoursWorked != "0.00" && $scope.time.hoursWorked != "00:00"){
						var LineItem = {};		
						dat = new Date($scope.selectDate);
						LineItem.ShowNotes =true;
						LineItem.HideTravel =true;
						LineItem.HideDisbursement =true;
						LineItem.GTCompanyCode = $scope.GTCompanyCode;	
						if($scope.toknUser.name == "Universal")
							LineItem.USER =$scope.selectedEmployee.obj.userID;
						else
						LineItem.USER =$scope.toknUser.userID;
						// LineItem.EmployeeCode = $scope.user.Code;
						LineItem.EmployeeName = $scope.user.UsualName;
						if($scope.toknUser.name=='Universal' && $scope.selectedEmployee.name !="" && state == "Saved")
						{
							LineItem.selectedEmployee = {};
							LineItem.selectedEmployee.name = $scope.selectedEmployee.name;
							LineItem.selectedEmployee.code = $scope.selectedEmployee.code;
							LineItem.selectedEmployee.obj = $scope.selectedEmployee.obj;
						};
						LineItem.TYPE = 'Daily';
						LineItem.STATE = state;
						LineItem.TAG = newTimeEntry.TAG;
						LineItem.Job = $scope.jobcode;
						LineItem.PayGroup = $scope.PayGroup;
						LineItem.JobFullName = $scope.jobname;
						LineItem.JobDesc = $scope.jobDesc;
						// LineItem.ActivityCode =  $scope.selectedUser.Code;
						LineItem.HRTransTypePay =  $scope.selectedUser.Code;
						// LineItem.ActivityFullName = $scope.selectedSite.FullName;
						LineItem.SiteFullName = $scope.selectedSite.FullName;
						LineItem.WorkCentre =$scope.defaultWCCode;
						LineItem.WorkCentreWithDisc = $scope.defaultWC;
						LineItem.Travel = $scope.travel;
						// if($scope.travel){
						// 	LineItem.TravelTime = $scope.travelHr;
						// 	LineItem.TravelTimeAC = "LSTRVL";
						// 	LineItem.TravelTimeWC = "LAB";
						// 	LineItem.TravelTimeWCDisc = "LABOUR";
						// }

						try{
							if($scope.jobManagerUsualName!=undefined || $scope.jobManagerUsualName!=""){
								LineItem.JobManagerUsualName = $scope.jobManagerUsualName;
								LineItem.JobManagerCode = $scope.jobManagerCode;
							};
						}
						catch(err){
							console.log("error at getting employee data ",err);
						};

						LineItem.DailyUlb= $scope.DailyUlb;

						if ($scope.signature === ""){
							LineItem.Level1="Approved";
						}else{
							LineItem.Level1="Approved";
						};

						LineItem.Level2="Pending";				
						
						/*LineItem.WorkCentre = $scope.selectedActivity.DefaultWorkCentre;*/

						LineItem.StartTime = $scope.time.startTime.toTimeString().split(' ')[0];
						LineItem.FinishTime = $scope.time.endTime.toTimeString().split(' ')[0];
						LineItem.Quantity = $scope.time.hoursWorked;
						LineItem.TimeLineDate = $scope.getyyyy_mm_dd(dat);					
						console.log("LineItem.Quantity in dailyyy ===>",LineItem.Quantity);
						LineItem.TimeLineDate = $scope.getyyyy_mm_dd(dat);
						/*LineItem.StandardText = genDataNewNotes.replaceAll("%5Cr%5Cn","\r\n\r\n").replaceAll(":" , ": ") + "\r\n\r\n" + "Timesheet notes: " + $scope.StandardText;*/
						LineItem.StandardText = genDataNewNotes.replace(/%5Cr%5Cn/gm,"\r\n\r\n").replace(/:/gm , ": ") + $scope.StandardText;
						LineItem.OverTime ='';
						if($scope.overTimeHours != "0.00" && $scope.overTimeHours != "00:00"){
							LineItem.OverTime = $scope.overTimeHours;
							if($scope.selectDate.getDay()==6 || $scope.selectDate.getDay()==0){
								// LineItem.Quantity = "00:00";
							}
							if (submit == true) {
								LineItem.OverTime = $scope.fractionMinsNew(LineItem.OverTime);
							};
						};
						$scope.totalHoursOnSelectedDate = $scope.getTimesheetsOfDaily("Daily", $scope.selectDate);
						if(!$scope.StandardTimesheetExist && $scope.totalHoursOnSelectedDate){
							LineItem.OverTime ='';
							if($scope.totalHoursOnSelectedDate == "0:00"){
								let dayHours = $scope.time.hoursWorked.replace(':','.');
								console.log("totalDayHours ===>",dayHours);
								if(8 < parseFloat(dayHours)){
									let overtimeHours = $scope.subHoursTotal($scope.time.hoursWorked, "08:00");
									LineItem.OverTime = overtimeHours;
									LineItem.Quantity = $scope.subHoursTotal($scope.time.hoursWorked, overtimeHours);
								}
								else{
									LineItem.OverTime ='';
									LineItem.Quantity = $scope.time.hoursWorked;
								}
							}
							else if($scope.totalHoursOnSelectedDate != "0:00"){
								var totalDayHours = $scope.addHoursTotal($scope.totalHoursOnSelectedDate, $scope.time.hoursWorked).substr(0,5);
								let dayHours = totalDayHours.replace(':','.');
								console.log("totalDayHours ===>",totalDayHours);
								if(8 < parseFloat(dayHours)){
									let overtimeHours = $scope.subHoursTotal(totalDayHours, "08:00");
									LineItem.OverTime = overtimeHours;
									LineItem.Quantity = $scope.subHoursTotal($scope.time.hoursWorked, overtimeHours);
								}
							}
						}	
						else if($scope.StandardTimesheetExist){
							LineItem.Quantity = "00:00";
							LineItem.OverTime = $scope.time.hoursWorked;
						};
						if($scope.selectDate.getDay()==6 || $scope.selectDate.getDay()==0){
							LineItem.Quantity = "00:00";
							LineItem.OverTime = $scope.time.hoursWorked;
						}
						LineItem.supervisorEmail = $scope.supervisorEmail;
						LineItem.email = $scope.email;
						LineItem.rejectReason ="";
						LineItem.replaceSVEmail =false;
						if (submit == true) {
							LineItem.Quantity = $scope.fractionMinsNew(LineItem.Quantity);
							if (LineItem.OverTime != '') {
								LineItem.OverTime = $scope.fractionMinsNew(LineItem.OverTime);
							};
						};
						if (submit == false) {
							LineItem.JobObj = $scope.selectedJobObj;	
						};				 
						LineItem.WEListDate=WEDate;
						LineItem.ExportTimeStamp = "";
						LineItem.ApprovedBy = "";
						LineItem.ApprovedTimestamp = "";
						LineItem.ProfitCentre =$scope.selectedJobObj.ProfitCentre;
						LineItem.GroupFilterCode = $scope.GroupFilterCode;
						LineItem.imageAttachments=[];
						for(var m =0; m<$scope.imageAttachments.length;m++ ){
							var TempImgAttachment1 ={};
							TempImgAttachment1.BinaryData={};
							if ((!TempImgAttachment1.BinaryData.Base64) && ($scope.imageAttachments[m].src)){
								TempImgAttachment1.BinaryData.Base64=$scope.imageAttachments[m].src;
							};
							var extensionT=$scope.imageAttachments[m].src.substring("data:image/".length, $scope.imageAttachments[m].src.indexOf(";base64"));
							TempImgAttachment1.BinaryData.FileName="Attach"+m.toString()+newTimeEntry.TAG+"."+extensionT;
							
							LineItem.imageAttachments.push(TempImgAttachment1);
						};
						LineItem.signatureName=$scope.signatureName;
						LineItem.signature={};
						if($scope.signature != ""){
							LineItem.signature.BinaryData={};
							LineItem.signature.BinaryData.Base64=$scope.signature;
							var extension=$scope.signature.substring("data:image/".length, $scope.signature.indexOf(";base64"));
							LineItem.signature.BinaryData.FileName=newTimeEntry.TAG+"."+extension;
						}else{
							/*LineItem.signature.BinaryData={};
							LineItem.signature.BinaryData.Base64=$scope.blankBase64PNG;	
							LineItem.signature.BinaryData.FileName=newTimeEntry.TAG+".png";*/
						};
						
					
						newTimeEntry.LineItems.push(LineItem);
					};
					 
					 /*Add Disbursment activities*/
					 for(var m =0; m<$scope.newLineItems.length;m++){
							var newLineItem = {};
							dat = new Date($scope.selectDate);
							newLineItem.HideTravel =true;
							newLineItem.HideDisbursement =true;
							newLineItem.GTCompanyCode = $scope.GTCompanyCode;
							if($scope.toknUser.name == "Universal")
								newLineItem.USER =$scope.selectedEmployee.obj.userID;
							else
								newLineItem.USER =$scope.toknUser.userID;
							// newLineItem.EmployeeCode = $scope.user.Code;
							newLineItem.EmployeeName = $scope.user.UsualName;
							if($scope.toknUser.name=='Universal' && $scope.selectedEmployee.name !="" && state == "Saved"){
								newLineItem.selectedEmployee = {};
								newLineItem.selectedEmployee.name = $scope.selectedEmployee.name;
								newLineItem.selectedEmployee.code = $scope.selectedEmployee.code;
								newLineItem.selectedEmployee.obj = $scope.selectedEmployee.obj;
							};
							newLineItem.TYPE = 'Daily';
							newLineItem.ActivityType = 'Disbursement';
							newLineItem.STATE = state;
							newLineItem.TAG = newTimeEntry.TAG;
							newLineItem.Job = $scope.jobcode;
							newLineItem.JobFullName = $scope.jobname;
							newLineItem.PayGroup = $scope.PayGroup;
							newLineItem.MainActivityCode =  $scope.selectedActivity.Code;
							newLineItem.MainActivityFullName = $scope.selectedActivity.FullName;
							newLineItem.ActivityFullName = $scope.newLineItems[m].ActivityFullName;
							newLineItem.Travel = $scope.travel;
							if (submit == false) {
								newLineItem.JobObj = $scope.selectedJobObj;	
							};
							
							try{
								if($scope.jobManagerUsualName!=undefined || $scope.jobManagerUsualName!=""){
									newLineItem.JobManagerUsualName = $scope.jobManagerUsualName;
									newLineItem.JobManagerCode = $scope.jobManagerCode;
								};
							}
							catch(err){
								console.log("error at getting employee data ",err);
							};
							newLineItem.ActivityCode = $scope.newLineItems[m].ActivityCode;
							newLineItem.HRTransTypePay =  $scope.newLineItems[m].ActivityCode;
							newLineItem.WorkCentre = $scope.defaultWCCode;
							newLineItem.WorkCentreWithDisc = $scope.defaultWC;						   
							newLineItem.TimeLineDate = $scope.getyyyy_mm_dd(dat);
							newLineItem.StandardText = $scope.newLineItems[m].StandardText;
							newLineItem.DailyUlb= $scope.DailyUlb;
							if ($scope.signature === ""){
								newLineItem.Level1="Approved";
							}else{
								newLineItem.Level1="Approved";
							};
							newLineItem.Level2="Pending";
							newLineItem.Quantity = $scope.newLineItems[m].Quantity;
							newLineItem.StartTime = "00:00";/* newTimeEntry.LineItems[0].StartTime;*/
							newLineItem.FinishTime = "00:00";/*$scope.CalFinishTime(newLineItem.StartTime, newLineItem.Quantity);*/
							newLineItem.Quantity = $scope.ConvertDisQty(newLineItem.Quantity);
							newLineItem.supervisorEmail = "";
							newLineItem.email = $scope.email;
							newLineItem.rejectReason ="";
							newLineItem.replaceSVEmail =false;
							newLineItem.WEListDate=WEDate;
							newLineItem.ExportTimeStamp = "";
							newLineItem.ApprovedBy = "";
							newLineItem.ApprovedTimestamp = "";
							newLineItem.ProfitCentre =$scope.selectedJobObj.ProfitCentre;
							newLineItem.GroupFilterCode = $scope.GroupFilterCode;
							newLineItem.imageAttachments=[];
							newLineItem.signatureName="";
							newLineItem.signature={};
							
							newTimeEntry.LineItems.push(newLineItem);
					};

					console.log("Daily newTimeEntry ",newTimeEntry);
					
				};

				if (param == 'Weekly') {
				
					for (var i = 0; i < $scope.hoursperday.length - 1; i++) {
						if (($scope.hoursperday[i].Hours != 0 && $scope.hoursperday[i].Hours != "00:00")) {
							LineItem = {};
							LineItem.GTCompanyCode = $scope.GTCompanyCode;
							LineItem.HideTravel =true;
							LineItem.HideDisbursement =true;
							if($scope.toknUser.name == "Universal")
								LineItem.USER =$scope.selectedEmployee.obj.userID;
							else
								LineItem.USER =$scope.toknUser.userID;
							
							// LineItem.EmployeeCode = $scope.user.Code;
							LineItem.EmployeeName = $scope.user.UsualName;
							if($scope.toknUser.name=='Universal' && $scope.selectedEmployee.name !="" && state == "Saved")
							{
								LineItem.selectedEmployee = {};
								LineItem.selectedEmployee.name = $scope.selectedEmployee.name;
								LineItem.selectedEmployee.code = $scope.selectedEmployee.code;
								LineItem.selectedEmployee.obj = $scope.selectedEmployee.obj;
							};
							LineItem.TYPE = 'Weekly';
							LineItem.STATE = state;
							LineItem.TAG = newTimeEntry.TAG;
							LineItem.Job = $scope.jobcode;
							LineItem.JobFullName = $scope.jobname;
							LineItem.JobDesc = $scope.jobDesc;
							// LineItem.ActivityCode =  $scope.selectedUser.Code;
							LineItem.HRTransTypePay =  $scope.selectedUser.Code;
							// LineItem.ActivityFullName = $scope.selectedUser.FullName;
							LineItem.SiteFullName = $scope.selectedSite.FullName;
							LineItem.PayGroup = $scope.PayGroup;
							LineItem.WorkCentre =$scope.defaultWCCode;
							LineItem.WorkCentreWithDisc = $scope.defaultWC;
							LineItem.Travel = $scope.travel;
							try{
								if($scope.jobManagerUsualName!=undefined || $scope.jobManagerUsualName!=""){
									LineItem.JobManagerUsualName = $scope.jobManagerUsualName;
									LineItem.JobManagerCode = $scope.jobManagerCode;
								};
							}
							catch(err){
								console.log("error at getting employee data ",err);
							};
							LineItem.DailyUlb= $scope.DailyUlb;		
							var date = $scope.hoursperday[i].Date.split('/');
							var _month = parseInt(date[1]);
							_month = _month - 1;
							LineItem.TimeLineDate = new Date(date[2],_month, date[0], 08, 00,0 );
							LineItem.TimeLineDate = $scope.getyyyy_mm_dd(LineItem.TimeLineDate);
							LineItem.Day = $scope.hoursperday[i].Day;							
						
							if ($scope.signature === ""){
								LineItem.Level1="Approved";
							}else{
								LineItem.Level1="Approved";
							};

							LineItem.Level2="Pending";	
							if (typeof ($scope.hoursperday[i].startTime) == 'string' || typeof ($scope.hoursperday[i].endTime) == 'string') {
								LineItem.StartTime = $scope.hoursperday[i].startTime;
								LineItem.FinishTime = $scope.hoursperday[i].endTime;
							} else {
								LineItem.StartTime = $scope.hoursperday[i].startTime.toTimeString().split(' ')[0];
								LineItem.FinishTime = $scope.hoursperday[i].endTime.toTimeString().split(' ')[0];
							};
							LineItem.Quantity = $scope.hoursperday[i].Hours;
							if($scope.hoursperday[i].Hours.includes(":")){
								LineItem.OverTime ='';
								if($scope.hoursperday[i].Day !="Sat" && $scope.hoursperday[i].Day !="Sun" &&  $scope.minuteConverter($scope.hoursperday[i].Hours) > 8){
									LineItem.OverTime = $scope.subHours($scope.hoursperday[i].Hours, "08:00");
									if (submit == true) {
										LineItem.OverTime = $scope.fractionMinsNew(LineItem.OverTime);
									};	
								}
								else if($scope.hoursperday[i].Day =="Sat" || $scope.hoursperday[i].Day =="Sun"){
									LineItem.OverTime = $scope.hoursperday[i].Hours;
									// LineItem.Quantity = "00:00";
									if (submit == true) {
										LineItem.OverTime = $scope.fractionMinsNew(LineItem.OverTime);
									};
								};
							};
							$scope.totalHoursOnSelectedDate = $scope.getTimesheetsOfDaily("Weekly", moment($scope.hoursperday[i].Date, "DD/MM/YYYY").toDate());
							if(!$scope.StandardTimesheetExist && $scope.totalHoursOnSelectedDate){
								LineItem.OverTime ='';
								if($scope.totalHoursOnSelectedDate == "0:00"){
									let dayHours = $scope.hoursperday[i].Hours.replace(':','.');
									console.log("totalDayHours ===>",dayHours);
									if(8 < parseFloat(dayHours)){
										let overtimeHours = $scope.subHoursTotal($scope.hoursperday[i].Hours, "08:00");
										LineItem.OverTime = overtimeHours;
										LineItem.Quantity = $scope.subHoursTotal($scope.hoursperday[i].Hours, overtimeHours);
									}
									else{
										LineItem.OverTime ='';
										LineItem.Quantity = $scope.hoursperday[i].Hours;
									}
								}
								else if($scope.totalHoursOnSelectedDate != "0:00"){
									var totalDayHours = $scope.addHoursTotal($scope.totalHoursOnSelectedDate, $scope.hoursperday[i].Hours).substr(0,5);
									let dayHours = totalDayHours.replace(':','.');
									console.log("totalDayHours ===>",totalDayHours);
									if(8 < parseFloat(dayHours)){
										let overtimeHours = $scope.subHoursTotal(totalDayHours, "08:00");
										LineItem.OverTime = overtimeHours;
										LineItem.Quantity = $scope.subHoursTotal($scope.hoursperday[i].Hours, overtimeHours);
									}
								}
							}	
							else if($scope.StandardTimesheetExist){
								LineItem.Quantity = "00:00";
								LineItem.OverTime = $scope.hoursperday[i].Hours;
							};
							if($scope.hoursperday[i].Day =="Sat" || $scope.hoursperday[i].Day =="Sun"){
								LineItem.OverTime = $scope.hoursperday[i].Hours;
								LineItem.Quantity = "00:00";
							};
							LineItem.StandardText = $scope.StandardText;
							LineItem.supervisorEmail = $scope.supervisorEmail;
							LineItem.email = $scope.email;
							LineItem.replaceSVEmail =false;
							LineItem.rejectReason ="";
							if (submit == true) {
								LineItem.Quantity = $scope.fractionMinsNew(LineItem.Quantity);
								if (LineItem.OverTime != '') {
									LineItem.OverTime = $scope.fractionMinsNew(LineItem.OverTime);
								};
							};
							if (submit == false) {
								LineItem.JobObj = $scope.selectedJobObj;	
							};
                            LineItem.WEListDate=WEDate;
							LineItem.ScreenStartTime = $scope.time.startTime.toTimeString().split(' ')[0];/*"00:00";*/
							LineItem.ScreenFinishTime = $scope.time.endTime.toTimeString().split(' ')[0];/*"00:00";*/
							LineItem.ScreenTotalHours = $scope.time.hoursWorked;
							LineItem.ExportTimeStamp = "";
							LineItem.ApprovedBy = "";
							LineItem.ApprovedTimestamp = "";
							LineItem.ProfitCentre = $scope.selectedJobObj.ProfitCentre;
							LineItem.GroupFilterCode = $scope.GroupFilterCode;
							LineItem.imageAttachments=[];
							for(var m =0; m<$scope.imageAttachments.length;m++ ){
								var TempImgAttachment1 ={};
								TempImgAttachment1.BinaryData={};
								if ((!TempImgAttachment1.BinaryData.Base64) && ($scope.imageAttachments[m].src)){
									TempImgAttachment1.BinaryData.Base64=$scope.imageAttachments[m].src;
								};
								var extensionT=$scope.imageAttachments[m].src.substring("data:image/".length, $scope.imageAttachments[m].src.indexOf(";base64"));
								TempImgAttachment1.BinaryData.FileName="Attach"+m.toString()+newTimeEntry.TAG+"."+extensionT;
								
								LineItem.imageAttachments.push(TempImgAttachment1);
							};
							LineItem.signatureName=$scope.signatureName;
							LineItem.signature={};
							if($scope.signature != ""){
								LineItem.signature.BinaryData={};
								LineItem.signature.BinaryData.Base64=$scope.signature;
								var extension=$scope.signature.substring("data:image/".length, $scope.signature.indexOf(";base64"));
								LineItem.signature.BinaryData.FileName=newTimeEntry.TAG+"."+extension;
							}else{
								/*LineItem.signature.BinaryData={};
								LineItem.signature.BinaryData.Base64=$scope.blankBase64PNG;	
								LineItem.signature.BinaryData.FileName=newTimeEntry.TAG+".png";*/
							};

							newTimeEntry.LineItems.push(LineItem);

							console.log("Weekly newTimeEntry: ",newTimeEntry);
						};

					};
				};

				if($scope.editTAG !== "None"){
					if(param === 'Weekly' && $scope.editTimeSheetDate !== $scope.selectDate){
						$scope.deleteEditTimesheet();
					};
					if(param === 'Daily' && $scope.editTimeSheetDate !== $scope.selectDate){
						$scope.deleteEditTimesheet();
					};
				};

				var index = $scope.checkIfWeekendingExists(newTimeEntry.WeekEndingDate);

				if (index == -1) {
					newTimeEntry.WEEXISTS = false;
					newTimeEntry.tsIndex = $scope.timesheets.length;

					if(newTimeEntry.WeekEndingDate.includes("/")){
						newTimeEntry.SortWeekEndingDate = new Date(Number(angular.copy(newTimeEntry.WeekEndingDate.substring(6, 19))));
					}else{
						newTimeEntry.SortWeekEndingDate = new Date(newTimeEntry.WeekEndingDate);
					};

					$scope.selectedWeekEnding = $scope.timesheets.length;
					$scope.timesheets.push(newTimeEntry);
				} else {
					
					
					
					var tempTSLineTimes =[];
					tempTSLineTimes =$scope.timesheets[index].LineItems;
					for (var i = 0; i < tempTSLineTimes.length; i++) {
						if (tempTSLineTimes[i].TAG === $scope.editTAG) {
							tempTSLineTimes[i] = 0;
						};
					};
					$scope.timesheets[index].LineItems =[];
					for(var k =0; k < tempTSLineTimes.length; k++){
						if(tempTSLineTimes[k] !=0){
							$scope.timesheets[index].LineItems.push(tempTSLineTimes[k]);
						};
					};
										
					
					for (var i = 0; i < newTimeEntry.LineItems.length; i++) {
						$scope.timesheets[index].LineItems.push(newTimeEntry.LineItems[i]);
					};
					$scope.selectedWeekEnding = index;
				};
				
				$scope.updateListStatus();
				
				if (newTimeEntry.LineItems.length === 0) {
					$scope.msgOnError('Timesheet', 'No daily time entered.');
					$scope.lockWeekly = false;
					return;
				} else {
					if (submit == true) {
						$scope.msgInfo('Timesheet', 'Submitting timesheet.');
					}else{
						$scope.msgInfo('Timesheet', 'New timesheet is saved to your device');
					};				
				};

				$scope.formatDates();
				$scope.captureClose();
				$scope.saveLocal(newTimeEntry);

				if (submit == true) {
					if ($scope.sendTStoGT == true) {
						$scope.submitTimeSheet(newTimeEntry,param);
					};
					$scope.tempNewEntry ={};
					$scope.tempNewEntry = newTimeEntry;		
					$scope.postTimeSheet2Tokn(newTimeEntry);
					
					/*update job notes*/
					if(newTimeEntry.MakeModel!=undefined && newTimeEntry.MakeModel!="" && param == 'Daily'){
						$scope.postNotes2Job($scope.selectedJobObj,newNotes);	
					};	
				};
				setTimeout(function () { $scope.closepopup(); }, 500);
			};

			$scope.setACWorkCentreList = function () {
				var ACList =[];
				for(var x= 0; x<$scope.activitylist.length; x++){
					for(var i=0; i< $scope.jobACList.length;i++){
                        if($scope.activitylist[x].Code ==$scope.jobACList[i].Code ){
							ACList.push($scope.jobACList[i]);
						};
					};
				};
				$scope.Activities = ACList;				
			};
			$scope.setActivities = function (data) {
				$scope.Activities = data;
			};

			$scope.setWCandUserActivities = function (data) {
				$scope.Activities = data.filter(function(x) {
					for(var i=0; i < $scope.Useractivitylist.length; i++){
						if(x.Code == $scope.Useractivitylist[i].Code){
							return true;
						}
					}
					return false;
				});
				// $scope.setDisbursementsTypeActivities($scope.Activities);
				console.log("Common Activities of WorkCentre activityGroup and User activityGroup ",$scope.Activities);
			};

			$scope.setJobandUserActivities = function (data) {
				$scope.Activities = data.filter(function(x) {
					for(var i=0; i < $scope.Useractivitylist.length; i++){
						if(x.Code == $scope.Useractivitylist[i].Code){ //&& x.Type == 'Time' && $scope.Useractivitylist[i].Type == 'Time'){
							return true;
						}
					}
					return false;
				});
				// $scope.fetchData('Demo-01-JCActivity','?type=Disbursements','setDisbursementActivities');
				// $scope.setDisbursementsTypeActivities($scope.Activities);
				console.log("Common Activities of Job activityGroup and User activityGroup ",$scope.Activities);
			};

			$scope.setDisbursementsTypeActivities = function (data) {
				$scope.ListManagersDisbursType = data.filter(function(x) {
					if(x.Type == 'Disbursements'){
						return true;
					}
					return false;
				});
				console.log("Disbursement Type Activities ",$scope.ListManagersDisbursType);
			};

			$scope.setWC = function (data) {
              	$scope.WCS = data;
			};

			$scope.setJobs = function (data) {
				$scope.Jobs = data;
			};

			$scope.setUser = function (data) {
				try{
					if(data[0].Employee!=undefined)
					{
						$scope.user = data[0].Employee;
						$scope.empActivityCode = $scope.user.DefaultActivity;
						$scope.empActivityGroup = data[0].Employee.ActivityGroup;
						$scope.activityGroup= data[0].Employee.ActivityGroup;
						/*$scope.user.Trees.every(item => {
							if(item.Name === "Organisation Unit"){
								$scope.OrganisationUnit = item.Value;
								return false;
							}
							return true;
						});
						$scope.disbursementOption = $scope.getUserUDFData('Disbursement Options') === 'true';*/
						$scope.getActivityCodesForUser();
						$scope.getUserDefaultWorkCentre();
						console.log("User Code ====>",$scope.user);
						$scope.saveLocally_Jobs_WCs_ACs($scope.user,"JCEmployee");
					}
					else if(data[1] && data[1].Employee!=undefined)
					{
						$scope.user = data[0].Employee;
						$scope.empActivityCode = $scope.user.DefaultActivity;
						$scope.empActivityGroup = data[0].Employee.ActivityGroup;
						$scope.activityGroup= data[0].Employee.ActivityGroup;
						/*$scope.user.Trees.every(item => {
							if(item.Name === "Organisation Unit"){
								$scope.OrganisationUnit = item.Value;
								return false;
							}
							return true;
						});
						$scope.disbursementOption = $scope.getUserUDFData('Disbursement Options') === 'true';*/
						$scope.getActivityCodesForUser();
						$scope.getUserDefaultWorkCentre();
						console.log("User Code ====>",$scope.user);
						$scope.saveLocally_Jobs_WCs_ACs($scope.user,"JCEmployee");
					}
					else{
						if($scope.toknUser && $scope.toknUser.Parameters != undefined ){
							var timesheetParamsCount = 0;
							if($scope.toknUser.Parameters.UserExtracts.length != 0){
								for(var b =0; b<$scope.toknUser.Parameters.UserExtracts.length; b++){
									if($scope.toknUser.Parameters.UserExtracts[b].appName == 'Timesheet' && ($scope.toknUser.Parameters.UserExtracts[b].objectName == 'Demo-01-GetEmployee')){
											timesheetParamsCount += 1;
									};
								};
							};

							if(timesheetParamsCount < 1){
								$scope.loadingMessage = "No timesheet parameter, Please contact admin";
							};
						}
					};
				}catch(err){
					console.log("Error in setUser =>", err.message);
				};	
			};

			$scope.setLocalTimesheets = function (data) {
				$scope.localTimeSheets =data;
				for(var i=0; i<data.length;i++){
					for(var j=0; j<data[i].LineItems.length;j++){
						
						for(var n=0; n<$scope.failedTimeSheets.length;n++){
							if($scope.failedTimeSheets[n].data=="Failed" &&$scope.failedTimeSheets[n].key === $scope.localTimeSheets[i].LineItems[j].TAG){
								$scope.localTimeSheets[i].LineItems[j].STATE = "Failed";
								for(var x =0; x<$scope.failedMessageList.length;x++){
									if($scope.failedMessageList[x].key == $scope.localTimeSheets[i].LineItems[j].TAG){
										$scope.localTimeSheets[i].LineItems[j].FailedMessage = $scope.failedMessageList[x].data;
									};
								};	
							};
						};
						/*replace space with plus for image attachment*/
						if($scope.localTimeSheets[i].LineItems[j].imageAttachments){
							for(var q=0; q< $scope.localTimeSheets[i].LineItems[j].imageAttachments.length; q++){							
								$scope.localTimeSheets[i].LineItems[j].imageAttachments[q].src = $scope.localTimeSheets[i].LineItems[j].imageAttachments[q].src.replace(/\s/g,'+');					
							};
						};
					};
				};
			};

			$scope.saveToLocal=function(DATA, Key,objectName){ 
				var instr = {};
				instr.Instr = "Insert";
				instr.App =$scope.appName;
				instr.Object = objectName;
				instr.Key =  Key;
				instr.Data = DATA;  
												
				instr = "MiTokn" + JSON.stringify(instr);

				var _frameSD = document.createElement('iframe');
				_frameSD.width = 0; _frameSD.height = 0; _frameSD.frameBorder = 0;
				document.body.appendChild(_frameSD);

				try {
					if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
						try { 
							window.HtmlCommunicator.getDataFromHTML(instr); 
						} 
						catch (err) { 
							console.log("Error on windows" + err.message());
						};
					}else{
						_frameSD.src = instr;
					};
				}catch (err){
					console.log("windows hack " + err.message());
				};         
				setTimeout(function () { document.body.removeChild(_frameSD); }, 300);

			};
			
			$scope.setTimeSheets = function (data) {
				$scope.timesheets = [];
				if ($scope.testdata == false) {
					if(data!==undefined && data.length>0){
						var timesheetlist=[];
                       /*decode the data blob*/
                        for(var x=0; x<data.length ;x++){	
							var temp =base64.decode(data[x].data);
							var ts = JSON.parse(temp);
							timesheetlist.push(ts.TimeSheet);                         
                        };
						$scope.timesheets = timesheetlist;
					}else{
						$scope.loading=false;
					};
				} else {
					$scope.user = EMP[0];
					$scope.timesheets = TS;
					$scope.Activities = AC;
					$scope.WCS = WC;
				};
				$scope.deleteDuplicateTimesheet($scope.localTimeSheets, angular.copy($scope.timesheets));
				console.log("Timesheets data ===>",$scope.timesheets);
				for (var x = 0; x < $scope.timesheets.length; x++) {
					$scope.timesheets[x].ListDate =$scope.timesheets[x].LineItems[0].WEListDate;
					$scope.timesheets[x].tsIndex = x;
					$scope.timesheets[x].WEEXISTS = true;
					$scope.timesheets[x].STATE = "Submitted";
					$scope.timesheets[x].TAG = new moment().format("YYYYMMDDTHHmmss");
					$scope.timesheets[x].TYPE = "Daily";
					for (var y = 0; y < $scope.timesheets[x].LineItems.length; y++) {
						if($scope.timesheets[x].LineItems[y].Level2 =="Approved"){
							$scope.timesheets[x].LineItems[y].STATE = "Approved";
						}else{
							$scope.timesheets[x].LineItems[y].STATE ="Submitted";
						};	
						if($scope.timesheets[x].LineItems[y].isRejected =="Rejected"){
							$scope.timesheets[x].LineItems[y].STATE ="Rejected";
						};			
						$scope.timesheets[x].LineItems[y].TAG = $scope.timesheets[x].TAG;
						$scope.timesheets[x].LineItems[y].TYPE = "Daily";
						$scope.timesheets[x].LineItems[y].ListDate = moment($scope.timesheets[x].LineItems[y].ListDate).format("DD/MM/YYYY");
					};
				};


				$scope.addLocalTimesheets($scope.localTimeSheets);
				/*$scope.formatDates();*/
				$scope.reFormatDates();



				/*Combine the original timesheets which have the same weekending date*/
				var combinedTSList =[];
				var index=-1;
				for (var n = 0; n < $scope.timesheets.length; n++) {
					index =$scope.weExists($scope.timesheets[n],combinedTSList);
					if(index !=-1){
						for(var a =0; a<$scope.timesheets[n].LineItems.length; a++ ){
							combinedTSList[index].LineItems.push($scope.timesheets[n].LineItems[a]);
						};
					}else{
						combinedTSList.push($scope.timesheets[n]);
					};										
				};
				$scope.timesheets = combinedTSList;
				/*Add SortWeekEndingDate to sort in app historylist*/
				for(var p=0; p< $scope.timesheets.length;p++){
					if($scope.timesheets[p].WeekEndingDate.includes("/")){
						$scope.timesheets[p].SortWeekEndingDate = new Date(Number(angular.copy($scope.timesheets[p].WeekEndingDate.substring(6, 19))));
					}else{
						$scope.timesheets[p].SortWeekEndingDate = new Date($scope.timesheets[p].WeekEndingDate);
					};
					
				};

				$scope.updateListStatus();
				$scope.thisWeekEndingDate = $scope.getddmmyyyy($scope.thisWeekEndingDate);
				for (var x = 0; x < $scope.timesheets.length; x++) {
					if ($scope.timesheets[x].ListDate === $scope.thisWeekEndingDate) {
						$scope.selectedWeekEnding = x;
						break;
					};
				};

				if ($scope.selectedWeekEnding === 0) {
					/*$scope.selectedWeekEnding = $scope.timesheets.length - 1;*/
				};

				$scope.resetTimesheetsIndexes();
				$scope.loading=false;
			};

			$scope.weExists = function (timesheet, combinedTSList){				
				for(var x= 0; x< combinedTSList.length; x++){
					if(timesheet.ListDate == combinedTSList[x].ListDate){
						
						return x;
					};
				};
				return -1;
			};


			$scope.updateListStatus = function (){
				/*Set combined timesheet status*/
				for(var t =0; t< $scope.timesheets.length;t++){
					var countFail = 0;
					var countSave = 0;
					var countSub = 0;
					var countApp= 0;
					var countSubmitting =0;
					var countRejected =0;
					for(var x=0; x< $scope.timesheets[t].LineItems.length;x++){
							if($scope.timesheets[t].LineItems[x].STATE =="Submitting" || $scope.timesheets[t].LineItems[x].STATE =="Pending" ){
								countSubmitting++;								
							};
							if($scope.timesheets[t].LineItems[x].STATE =="Failed"){
								countFail++;								
							};
							if($scope.timesheets[t].LineItems[x].STATE =="Saved"){
								countSave++;								
							};
							if($scope.timesheets[t].LineItems[x].STATE =="Submitted"){
								countSub++;
							};
							if($scope.timesheets[t].LineItems[x].STATE =="Approved"){
								countApp++;
							};	
							if($scope.timesheets[t].LineItems[x].STATE =="Rejected"){
								countRejected++;
							};
					};
					if(countSubmitting>0){
						$scope.timesheets[t].STATE = "Submitting";								
					}else 
					if(countFail>0){
						$scope.timesheets[t].STATE = "Failed";								
					}else 
					if(countRejected>0){
						$scope.timesheets[t].STATE = "Rejected";								
					}else
					if(countSave>0){
						$scope.timesheets[t].STATE = "Saved";								
					}else
					if(countSub>0){
						$scope.timesheets[t].STATE = "Submitted";
					}else
					if(countApp>0){
						$scope.timesheets[t].STATE = "Approved";
					};
				};			
			};
			$scope.reFormatDates = function () {
				try {
					for (var x = 0; x < $scope.timesheets.length; x++) {
						var dat;
						try {
							if($scope.timesheets[x].WeekEndingDate.startsWith('/')){
								dat = new Date(Number($scope.timesheets[x].WeekEndingDate.substring(6, 19)));
							}else{
								dat = new Date($scope.timesheets[x].WeekEndingDate);
							};
							
						}
						catch (err) {
							dat = new Date(Number($scope.timesheets[x].WeekEndingDate));
						};

						$scope.timesheets[x].ListDate = $scope.getddmmyyyy(dat);
						$scope.timesheets[x].WEDateDate = dat;
						$scope.timesheets[x].WEDateDate.setHours(00);
						$scope.timesheets[x].WEDateDate.setMinutes(00);
						$scope.timesheets[x].WEDateDate.setSeconds(00);

						for (var y = 0; y < $scope.timesheets[x].LineItems.length; y++) {
							var listdate;
							
							listdate = new Date($scope.timesheets[x].LineItems[y].TimeLineDate);
							$scope.timesheets[x].LineItems[y].ListDate = $scope.getddmmyyyy(listdate);
						};

					};
				} catch (err) {

				};
			};
			$scope.formatDateForGenData =  function (dateString){
				/*To post to Gendata, change 23/01/2020 to 2020-01-23*/
				var date = dateString.split('/');
				var newDate ="";
				newDate = date[2] +"-" +date[1] +"-" +date[0];
				return newDate;
			};
			$scope.formatDates = function () {
				try {
					for (var x = 0; x < $scope.timesheets.length; x++) {
						var dat;
						try {
							if($scope.timesheets[x].WeekEndingDate.startsWith('/')){
								dat = new Date(Number($scope.timesheets[x].WeekEndingDate.substring(6, 19)));
							}else{
								dat = new Date($scope.timesheets[x].WeekEndingDate);
							};
							
						}
						catch (err) {
							dat = new Date(Number($scope.timesheets[x].WeekEndingDate));
						};

						$scope.timesheets[x].ListDate = $scope.getddmmyyyy(dat);
						$scope.timesheets[x].WEDateDate = dat;
						$scope.timesheets[x].WEDateDate.setHours(00);
						$scope.timesheets[x].WEDateDate.setMinutes(00);
						$scope.timesheets[x].WEDateDate.setSeconds(00);

						for (var y = 0; y < $scope.timesheets[x].LineItems.length; y++) {
							var listdate;
							try {
								listdate = new Date($scope.timesheets[x].LineItems[y].TimeLineDate);
								

							}
							catch (err) {
								listdate = new Date(Number($scope.timesheets[x].LineItems[y].TimeLineDate));
							};
							$scope.timesheets[x].LineItems[y].ListDate = $scope.getddmmyyyy(listdate);
						};

					};
				} catch (err) {

				};
			};
	

			$scope.unlockDailyTimesheet = function () {	
				$scope.lockDaily = false;			
				$scope.getWeekendingDate();
			};
			$scope.unlockDailyOnBlur = function(){
				$scope.lockDaily = false;			
				$scope.getWeekendingDate();
			};
			$scope.unlockWeeklyOnBlur = function(date){	
				$scope.getWeekendingDate();
				$scope.lockWeekly = false;
			};
			$scope.getddmmyyyy = function (dat) {
				try {
					var day = $scope.zeroPrefix(dat.getDate().toString());
					var month = $scope.zeroPrefix((dat.getMonth() + 1).toString());
					return day + "/" + month + "/" + dat.getFullYear();
				}
				catch (err) {

				};
			};

			$scope.getyyyy_mm_dd = function (dat) {
				try {
					var day = $scope.zeroPrefix(dat.getDate().toString());
					var month = $scope.zeroPrefix((dat.getMonth() + 1).toString());
					return dat.getFullYear() + "-" + month + "-" + day;
				}
				catch (err) {

				};
			};

			$scope.getyyyymmdd = function (dat) {
				try {
					var day = $scope.zeroPrefix(dat.getDate().toString());
					var month = $scope.zeroPrefix((dat.getMonth() + 1).toString());
					return dat.getFullYear() + month + day;
				}
				catch (err) {

				};
			};

			$scope.fractionMins = function(inQty){
				try {
					var _qtyComp = inQty.split(":");
					if (_qtyComp.length > 1){
						var _hour = _qtyComp[0];
						if ((_hour.length > 1) && (_hour.slice(0,1)=="0")){
							_hour = _hour.slice(1,2);
						};
						var _mins = (parseFloat(_qtyComp[1]) / 60) * 100;
						_mins = _mins.toString();
						if ((_mins.length > 1) && (_mins.slice(0,1)!="0")){
							if(_mins.length===2){
								_mins = _mins.slice(0,2);
							}else{
								_mins = _mins.slice(0,1);
							};
							
						};
						return _hour + "." + _mins;
					}
					else {
						return inQty;
					}
				}
				catch (err){
					return inQty;	
				};
			};
			$scope.ConvertDisQty = function(qty){
				var qtyString = qty.toString();
				if(qtyString.includes(".")){
					var qtyArray = qtyString.split(".");
					if(qtyArray[0].length ==1){
						qtyArray[0] = "0"+qtyArray[0];
					};
					if(qtyArray[1].length ==1){
						qtyArray[1] = qtyArray[1] + "0";
					};
					return qtyArray[0] + ":" +qtyArray[1];
				}else{
					if(qtyString.length ==1){
						return "0" + qtyString + ":00";
					} else{
						return qtyString + ":00";
					};
				};
			};

			/*$scope.ConvertDisQty = function(qty){
				var timearr = qty.split(":");
					timearr[0] = $scope.stripNonDigits(timearr[0]);
					timearr[1] = ((((parseInt($scope.stripNonDigits(timearr[1]))/60).toFixed(2))+"").split("."))[1];
					var hoursWorked = timearr[0] +":"+ timearr[1];
					return hoursWorked;
			};*/

			$scope.fractionMinsNew = function(inQty){
				try {
					var _qtyComp = inQty.split(":");
					if (_qtyComp.length > 1){
						var _hour = _qtyComp[0];
						if ((_hour.length > 1) && (_hour.slice(0,1)=="0")){
							_hour = _hour.slice(1,2);
						};
						var _mins = (parseFloat(_qtyComp[1]) / 60) * 100;
						_mins = _mins.toString();
						if ((_mins.length > 1) && (_mins.slice(0,1)!="0")){
							if(_mins.length===2){
								_mins = _mins.slice(0,2);
							}else{
								_mins = _mins.slice(0,1);
							};
							
						};

						if(_mins=="0"){
							_mins="00";
						};
						if(_hour<10){
							return "0"+_hour + ":" + _mins;
						}else{
							return _hour + ":" + _mins;
						};
						
					}
					else {
						return inQty;
					}
				}
				catch (err){
					return inQty;	
				};
			};
			$scope.convertQuantity = function(quanty){
				try {
					var _qtyComp = quanty.split(":");
					var hour = _qtyComp[0];	
					var min =	_qtyComp[1];
					if(min =="00"){
						return hour + ":" +min;
					}else{
						min =	parseInt(_qtyComp[1])*0.01*60;
						return hour + ":" +min.toString();
					};				
				}
				catch (err){
					return quanty;	
				};
			};
			$scope.convertDISQuantity = function(quanty){
				try {
					var _qtyComp = quanty.split(":");
					var hour = _qtyComp[0];	
					var min =	_qtyComp[1];
					
					return 	(parseInt(hour)+parseFloat(min/60)).toFixed(2);
				}
				catch (err){
					return quanty;	
				};
			};
			$scope.postTimeSheet2Tokn = function (thisTimeSheet){
                try{
								
                    var link = {};
                    var currentDate=new moment().format("YYYYMMDDTHHmmss");
					link.Instr = "synch";
					link.Screen= $scope.screenName;				
                    link.Method = $scope.genDataStoreUpdMethod;
                    link.SynchMessage = "Sending TimeSheet to TOKN" ;
					link.Data = {};
					
                    link.Data.company=$scope.company;
                    link.Data.appName=$scope.genDataStoreAppName;
					link.Data.objectName=$scope.genDataStoreObjName;
					/*Created user here is the selected Employee,Index 7 is the actual created user*/
					/*Only in this way it works in console widget*/
                    link.Data.createdUser=thisTimeSheet.USER;
					link.Data.keyID=thisTimeSheet.TAG;
					link.Data.data={};
					/*place this in properties file and read URL from there*/
					/*this url is executed immediately when the record has been saved */
					link.Data.data["WebHook"]= $scope.WebHook;
					link.Data.data["emailTemplate"]=$scope.emailTemplate;
					/* this is required to actually activate the hook, even if its blank, without it specified, hook wont fire*/
					link.Data.data["sendPostToConnect"]=$scope.sendPostToConnect;
					link.Data.data["WebHookExecuted"]= '';
					link.Data.data["approveURL"]= $scope.approveURL;

					
					link.Data.WebHook =$scope.WebHook;
					link.Data.emailTemplate=$scope.emailTemplate;
					link.Data.sendPostToConnect=$scope.sendPostToConnect;
					link.Data.WebHookExecuted= '';
					link.Data.approveURL= $scope.approveURL;
					
					link.Data.data["User"]=thisTimeSheet.USER;
					link.Data.data["TimeSheet"]=thisTimeSheet;
					link.Data.index1=thisTimeSheet.ListDate;
					link.Data.index2 =thisTimeSheet.LineItems[0].ActivityCode;
					link.Data.index3 =thisTimeSheet.LineItems[0].WorkCentre;
					link.Data.index4 =thisTimeSheet.LineItems[0].ProfitCentre;
					link.Data.index5=$scope.formatDateForGenData(thisTimeSheet.TimesheetSelectDate);
					/*Index 7 is the actual created user*/
					link.Data.index7 =$scope.toknUser.userID;
					/*link.Data.index8 =thisTimeSheet.LineItems[0].GroupFilterCode;*/
					link.Data.index11 = $scope.PayGroup;
					link.Data.index12 =thisTimeSheet.LineItems[0].Job;

					link.SynchMessage = "Timesheet W/E:" + thisTimeSheet.ListDate ;
					$scope.syncMethodText=link.SynchMessage;
					link.Index1 = thisTimeSheet.TAG;
			
					/*link.Data.PreWebHook = [];
					var prewebHook = {};
					prewebHook.url = $scope.prewebHook + "?job=" + thisTimeSheet.LineItems[0].Job +"&workcentre="+ thisTimeSheet.LineItems[0].WorkCentre +"&activitycode="+thisTimeSheet.LineItems[0].ActivityCode;
					prewebHook.headers = [];
					var headerUrl ={
						url: $scope.headerUrl
					};
					var headers = {
						headers: [
							{
								key:"User-Agent",
								value:"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:25.0) Gecko/20100101 Firefox/25.0"
							},
							{
								key:"ApiKey",
								value:$scope.prewebHook_ApiKey
							},
							{
								key:"Authorization",
								value:$scope.prewebHook_Authorization
							},
							{
								key:"Accept",
								value:"application/json"
							},
							{
								key:"Content-Type",
								value:"application/json"
							},
							{
								key:"TOKNAuthorization",
								value:"Bearer kw58IsaGZz266ac0R3110nJ8kz2FlpJJ"
							}
						]
					};
					prewebHook.headers.push(headerUrl);
					prewebHook.headers.push(headers);
					link.Data.PreWebHook.push(prewebHook);
					*/
										
					link.SynchKey=thisTimeSheet.TAG;

					/*console.log(JSON.stringify(link));*/
                    link.Response = [];

                    entry = {};
                    entry.Result = "true";
					entry.Toast = 'Timesheet entered successfully';
					entry.Screen = $scope.screenName;
					entry.FunctionOnReturn = 'PostGenDataOK';
					entry.SynchKey=thisTimeSheet.TAG;
					/*entry.Query = "delete from tblJSONData where  appName = '"+
									$scope.appName+"'  and objectName='"+
									$scope.LocalSyncObject+"' and key='" + thisTimeSheet.TAG + "';";*/
					entry.Query = entry.Query +  "Insert or replace into tblJSONData values ('"+
									$scope.appName+"','"+$scope.LocalSyncStatusObject+"','" + thisTimeSheet.TAG + "','Submitted'); ";
					/*Delete the failed record in tblSynch*/	
					entry.Query+= "delete from tblSynch where index1='" + thisTimeSheet.TAG + "' and method ='SendTimesheetToTokn' and status=='3';";
					/*Delete the failed message in tblJson*/
					entry.Query+= "delete from tblJSONData where  appName = '"+
									$scope.appName+"'  and objectName='FailedMessage' and key='" + thisTimeSheet.TAG + "';";
					/*entry.Query+= "delete from tblSynch where index1='" + thisTimeSheet.TAG  + "' and method='SendEmail' and status='1';";*/
					link.Response.push(entry);

                    entry = {};
                    entry.Result = "false";
					entry.Toast = 'Timesheet entry failed';
					entry.Screen = $scope.screenName;
					entry.FunctionOnReturn = 'PostGenDataFail';
					entry.SynchKey=thisTimeSheet.TAG;
					entry.Query = "Insert or replace into tblJSONData values ('"+
									$scope.appName+"','"+$scope.LocalSyncStatusObject+"','" + thisTimeSheet.TAG + "','Failed'); ";
					/*If post failed, delete the previous chain sync generate PDF*/
					entry.Query+= "delete from tblSynch where index1='" + thisTimeSheet.TAG  + "' and method='SendEmail' and status='1';";
					/*entry.Query+= "delete from tblSynch where index1='" + thisTimeSheet.TAG  + "' and status='3';";*/
					/*Delete the failed message in tblJson*/
					/*entry.Query+= "delete from tblJSONData where  appName = '"+
								$scope.appName+"'  and objectName='FailedMessage' and key='" + thisTimeSheet.TAG + "';";*/
					link.Response.push(entry);

					link.FunctionOnReturn="chkPostGenDataResponse";

					link = "MiTokn" + JSON.stringify(link);
					link = encodeURI(link);

					var _frame = document.createElement('iframe');
					_frame.width = 0; _frame.height = 0; _frame.frameBorder = 0;
					document.body.appendChild(_frame);
					
					try {
							if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
									window.HtmlCommunicator.getDataFromHTML(link); 
							}else{
								_frame.src = link;
							};
					}
					catch (err){
					    console.log("windows changes for sync " + err.message());
					};
					setTimeout(function () { document.body.removeChild(_frame); }, 5000);

                }catch(err){
                    console.log("Error in postTimeSheet2Tokn => " + err.message);
                };
			};
			$scope.postNotes2Job = function (selectedJob,notes) {
				try {

					var link = {};
					link.Instr = "Synch";
					link.Method = "UpdateJobNotes";
					link.SynchMessage = "Update Job Notes";
					link.URLAdd = "/" + selectedJob.Code;
					link.Data = {};
					link.Data.JCJob = {};
					link.Data.JCJob.Code = selectedJob.Code;
					link.Data.JCJob.Notes = notes;
					link.Data.JCJob.CreateDate =  $scope.getddmmyyyy(new Date(Number(selectedJob.CreateDate.substring(6, 19))));
					if(selectedJob.CompleteDate!=undefined){
						link.Data.JCJob.CompleteDate = $scope.getddmmyyyy(new Date(Number(selectedJob.CompleteDate.substring(6, 19))));
					};
					
					link.Response = [];
					entry = {};
					entry.Result = "true";
					entry.Screen = $scope.screenName;
					entry.FunctionOnReturn = 'PostJobOK';
					entry.SynchKey=new moment().format("YYYYMMDDTHHmmss");
					entry.Toast = "Job notes successfully updated";
					
					link.Response.push(entry);


					entry = {};
					entry.Result = "false";
					entry.Toast = "Job notes update failed";
					
					link.Response.push(entry);

					link = 'MiTokn' + JSON.stringify(link);

					if ($scope.testdata != true) {
						var _frame = document.createElement('iframe');
						_frame.width = 0; _frame.height = 0; _frame.frameBorder = 0;
						document.body.appendChild(_frame);

						try {
                     		if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
                        		try { 
                      		        window.HtmlCommunicator.getDataFromHTML(link); 
                        		} 
                        		catch (err) { 
                         		   console.log("$scope.concatlocal->" + err.message());
                        		};
                    		}else{
                        		_frame.src = link;
                    		};
                		}
                		catch (err){
                    		console.log("windows hack " + err.message());
            			};
						setTimeout(function () { document.body.removeChild(_frame); }, 1000);
					};

					$scope.msgOnSuccess('Job Notes', 'Updating Job Notes');

				} catch (err) {

					console.log("Failed in updating Job Notes");
				};
			};
			/*submitTimeSheet no in use now. This is the method to post to GT*/
			$scope.checkWeekExistInGT = function (thisTimeSheet) {
				var dat;

				dat = new Date(Number(thisTimeSheet.WeekEndingDate.substring(6, 19)));

				var month = (dat.getMonth() + 1).toString();
				if (month.length === 1) {
					month = "0".concat(month);
				};
				var day = dat.getDate().toString();
				if (day.length === 1) {
					day = "0".concat(day);
				};

				try {
					   
					   var link = {};
					   link.Instr = "DataFetch";
					   link.App = $scope.appName;
					   link.Object = "CheckWeekExist";
					   link.Seq = "1";
					   link.FunctionOnReturn = "checkWeekExist";
					   link.URLAdd = "/"+ thisTimeSheet.LineItems[0].EmployeeCode+"/" +$scope.getyyyy_mm_dd(dat);
					   link.InsertOnReturn = "Y";
					   link = "MiTokn" + JSON.stringify(link);
   
					   /*$scope.log("Getting pre work data"+link);*/
   
					   var _frameCW = document.createElement('iframe');
					   _frameCW.width = 0; _frameCW.height = 0; _frameCW.frameBorder = 0;
					   document.body.appendChild(_frameCW);
					   try {
						   if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
								   window.HtmlCommunicator.getDataFromHTML(link); 
						   }else{
							_frameCW.src = link;
						   };
					   }
					   catch (err){
						   $scope.log("windows changes for sync " + err.message());
					   };
   
					   setTimeout(function () { document.body.removeChild(_frameCW); }, 5000);
				   }
				   catch (err) {
					   alert("Error checkWeekExistInGT data:"+err.message);
				};
			};
			/*submitTimeSheet no in use now. This is the method to post to GT*/
			$scope.submitDisbTimeSheet = function (thisTimeSheet,disburseLines,weekExists) {
				try {

					var dat;

					dat = new Date(Number(thisTimeSheet.WeekEndingDate.substring(6, 19)));

					var month = (dat.getMonth() + 1).toString();
					if (month.length === 1) {
						month = "0".concat(month);
					};
					var day = dat.getDate().toString();
					if (day.length === 1) {
						day = "0".concat(day);
					};
					var timesheetdate = dat.getFullYear() + "-" + month + "-" + day;
					var link = {};
					link.Instr = "Synch";
					link.Method = "GTPostTimeSheet";
					link.SynchMessage = "Create Disbursement W/E:" + $scope.getyyyy_mm_dd(dat);
					link.URLAdd = "/" + thisTimeSheet.LineItems[0].EmployeeCode;
					link.Data = {};
					link.Data.JCTimesheet = {};
					link.Data.JCTimesheet.WeekEndingDate = $scope.getyyyy_mm_dd(dat);
					link.Data.JCTimesheet.Employee = thisTimeSheet.LineItems[0].EmployeeCode;
				
					link.Data.JCTimesheet.LineItems = [];

					for (x = 0; x < disburseLines.length; x++) {
						var lineItem = {};
						lineItem.TimeLineDate = thisTimeSheet.LineItems[0].TimeLineDate;
						lineItem.Job = thisTimeSheet.LineItems[0].Job.toUpperCase();
						lineItem.WorkCentre = $scope.defaultWCCode;
						lineItem.ActivityCode = disburseLines[x].ActivityCode.toUpperCase();
						lineItem.Quantity = $scope.fractionMins(disburseLines[x].Quantity);
						if (typeof (disburseLines[x].StandardText) != 'undefined' && disburseLines[x].StandardText != "") {
							lineItem.StandardText = disburseLines[x].StandardText;
						};
						
						link.Data.JCTimesheet.LineItems.push(lineItem);
					};


					link.Response = [];
					entry = {};
					entry.Result = "true";
					entry.Toast = "Disbursement timesheet successfully created";
					entry.Query = "delete from tblJSONData where objectName = 'LocalTimeSheets' and key ='" + thisTimeSheet.TAG + "'";
					link.Response.push(entry);


					entry = {};
					entry.Result = "false";
					entry.Toast = "Disbursement timesheet creation failed";
					entry.Query = "Insert into tblJSONData values ('Timesheet','SyncStatus','" + thisTimeSheet.TAG + "','Failed')";
					link.Response.push(entry);


					if (weekExists == true) {
						link.Method = "GTPostTimeSheet";
						link.SynchMessage = "Update Timesheet W/E:" + $scope.getyyyy_mm_dd(dat);
						link.URLAdd = "/" + thisTimeSheet.LineItems[0].EmployeeCode + '/' + timesheetdate;
						link.Response = [];
						entry = {};
						entry.Result = "true";
						entry.Toast = "Disbursement timesheet successfully updated";
						entry.Query = "delete from tblJSONData where objectName = 'LocalTimeSheets' and key ='" + thisTimeSheet.TAG + "'";

						link.Response.push(entry);


						entry = {};
						entry.Result = "false";
						entry.Toast = "Disbursement timesheet could not be updated";
						entry.Query = "Insert into tblJSONData values ('Timesheet','SyncStatus','" + thisTimeSheet.TAG + "','Failed')";
						link.Response.push(entry);
					};


					link = 'MiTokn' + JSON.stringify(link);

					if ($scope.testdata != true) {
						var _frame = document.createElement('iframe');
						_frame.width = 0; _frame.height = 0; _frame.frameBorder = 0;
						document.body.appendChild(_frame);

						try {
                     		if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
                        		try { 
                      		        window.HtmlCommunicator.getDataFromHTML(link); 
                        		} 
                        		catch (err) { 
                         		   console.log("$scope.concatlocal->" + err.message());
                        		};
                    		}else{
                        		_frame.src = link;
                    		};
                		}
                		catch (err){
                    		console.log("windows hack " + err.message());
            			};
						setTimeout(function () { document.body.removeChild(_frame); }, 1000);
					};

					$scope.msgOnSuccess('disbursement', 'Creating disbursement timesheets');

				} catch (err) {

					console.log("Failed in Submit Disbursement Timesheet");
				};
			};
			/*submitTimeSheet no in use now. This is the method to post to GT*/
			$scope.submitTimeSheet = function (thisTimeSheet,param) {
				try {

					if (!$scope.checkDataEntry(param)) {
						return;
					};

					if (!$scope.signature && $scope.testdata !== true && !$scope.email) {
						$scope.msgOnError('Signature or Email required', 'A supervisor signature or alternate email is required before submiting');
						return;
					};

					var dat;

					dat = new Date(Number(thisTimeSheet.WeekEndingDate.substring(6, 19)));

					var month = (dat.getMonth() + 1).toString();
					if (month.length === 1) {
						month = "0".concat(month);
					};
					var day = dat.getDate().toString();
					if (day.length === 1) {
						day = "0".concat(day);
					};
					var timesheetdate = dat.getFullYear() + "-" + month + "-" + day;
					var link = {};
					link.Instr = "Synch";
					link.Method = "CreateTimesheet";
					link.SynchMessage = "Create Timesheet W/E:" + $scope.getyyyy_mm_dd(dat);
					link.URLAdd = "/" + thisTimeSheet.Employee;
					link.Data = {};
					link.Data.JCTimesheet = {};
					link.Data.JCTimesheet.WeekEndingDate = $scope.getyyyy_mm_dd(dat);
					link.Data.JCTimesheet.Employee = thisTimeSheet.Employee;
					if (typeof ($scope.StandardText) != 'undefined' && $scope.StandardText != "") {
						link.Data.JCTimesheet.StandardText = $scope.StandardText;
					};
					link.Data.JCTimesheet.LineItems = [];

					for (x = 0; x < thisTimeSheet.LineItems.length; x++) {
						var lineItem = {};
						lineItem.TimeLineDate = thisTimeSheet.LineItems[x].TimeLineDate;
						lineItem.Job = thisTimeSheet.LineItems[x].Job.toUpperCase();
						lineItem.WorkCentre = thisTimeSheet.LineItems[x].WorkCentre.toUpperCase();
						lineItem.ActivityCode = thisTimeSheet.LineItems[x].ActivityCode.toUpperCase();
						lineItem.Quantity = $scope.fractionMins(thisTimeSheet.LineItems[x].Quantity);
						if (typeof ($scope.StandardText) != 'undefined' && $scope.StandardText != "") {
							lineItem.StandardText = $scope.StandardText;
						};
						if (typeof (thisTimeSheet.LineItems[x].StartTime) != 'undefined' && thisTimeSheet.LineItems[x].StartTime != "") {
							lineItem.StartTime = thisTimeSheet.LineItems[x].StartTime;
						};
						if (typeof (thisTimeSheet.LineItems[x].FinishTime) != 'undefined' && thisTimeSheet.LineItems[x].FinishTime != "") {
							lineItem.FinishTime = thisTimeSheet.LineItems[x].FinishTime;
						};
						thisTimeSheet.LineItems[x].sent = "X";
						link.Data.JCTimesheet.LineItems.push(lineItem);
					};

					var weekExists = false;
					for (var x = 0; x < $scope.timesheets.length; x++) {
						for (var y = 0; y < $scope.timesheets[x].LineItems.length; y++) {
							if ($scope.timesheets[x].LineItems[y].STATE === "Submitted" && $scope.timesheets[x].ListDate == thisTimeSheet.ListDate) {
								weekExists = true;
								break;
							};
						};
					};



					link.Response = [];
					entry = {};
					entry.Result = "true";
					entry.Toast = "Timesheet successfully created";
					entry.Query = "delete from tblJSONData where objectName = 'LocalTimeSheets' and key ='" + thisTimeSheet.TAG + "'";
					link.Response.push(entry);


					entry = {};
					entry.Result = "false";
					entry.Toast = "Timesheet creation failed";
					entry.Query = "Insert into tblJSONData values ('Timesheet','SyncStatus','" + thisTimeSheet.TAG + "','Failed')";
					link.Response.push(entry);


					if (weekExists == true) {
						link.Method = "UpdateTimesheet";
						link.SynchMessage = "Update Timesheet W/E:" + $scope.getyyyy_mm_dd(dat);
						link.URLAdd = "/" + thisTimeSheet.Employee + '/' + timesheetdate;
						link.Response = [];
						entry = {};
						entry.Result = "true";
						entry.Toast = "Timesheet successfully updated";
						entry.Query = "delete from tblJSONData where objectName = 'LocalTimeSheets' and key ='" + thisTimeSheet.TAG + "'";

						link.Response.push(entry);


						entry = {};
						entry.Result = "false";
						entry.Toast = "Timesheet could not be updated";
						entry.Query = "Insert into tblJSONData values ('Timesheet','SyncStatus','" + thisTimeSheet.TAG + "','Failed')";
						link.Response.push(entry);
					};


					link = 'MiTokn' + JSON.stringify(link);

					if ($scope.testdata != true) {
						var _frame = document.createElement('iframe');
						_frame.width = 0; _frame.height = 0; _frame.frameBorder = 0;
						document.body.appendChild(_frame);

						try {
                     		if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
                        		try { 
                      		        window.HtmlCommunicator.getDataFromHTML(link); 
                        		} 
                        		catch (err) { 
                         		   console.log("$scope.concatlocal->" + err.message());
                        		};
                    		}else{
                        		_frame.src = link;
                    		};
                		}
                		catch (err){
                    		console.log("windows hack " + err.message());
            			};
						setTimeout(function () { document.body.removeChild(_frame); }, 1000);
					};

					$scope.msgOnSuccess('Timesheet', 'Timesheet synch record created');

				} catch (err) {

					alert("Failed in Submit Timesheet");
				};
			};

			$scope.deleteTimesheet = function () {

				for (var i = 0; i < $scope.timesheets.length; i++) {
					for (var j = $scope.timesheets[i].LineItems.length - 1; j >= 0; j--) {
						if ($scope.timesheets[i].LineItems[j].TAG === $scope.editTAG) {
							$scope.timesheets[i].LineItems.splice(j, 1);
						};
					};
				};

				for (var i = 0; i < $scope.timesheets.length; i++) {
					if ($scope.timesheets[i].LineItems.length === 0) {
						$scope.timesheets.splice(i, 1);
					};
				};

				$scope.resetTimesheetsIndexes();
				$scope.captureClose();
				$scope.closepopup("Delete");
				$scope.updateListStatus();
				try {
					var instr = {};
					instr.Instr = "Delete";
					instr.App = "Timesheet";
					instr.Object = $scope.LocalSyncObject;
					instr.Key = $scope.editTAG;
					instr.FunctionOnReturn = "deleteMessage()";
					instr = 'MiTokn' + JSON.stringify(instr);
					if ($scope.testdata != true) {
						var _frameprework = document.createElement('iframe');
						_frameprework.width = 0; _frameprework.height = 0; _frameprework.frameBorder = 0;
						document.body.appendChild(_frameprework);
						
						try {
                     		if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
                        		try { 
                      		        window.HtmlCommunicator.getDataFromHTML(instr); 
                        		} 
                        		catch (err) { 
                         		   console.log("$scope.concatlocal->" + err.message());
                        		};
                    		}else{
                        		_frameprework.src = instr;
                    		};
                		}
                		catch (err){
                    		console.log("windows hack " + err.message());
						};
						
						setTimeout(function () { document.body.removeChild(_frameprework); }, 500);
					};
				}
				catch (err) {
					$scope.msgOnError("System Alert", "Failed while deleting Timesheets to device");
				};
			};

			$scope.deleteEditTimesheet = function () {

				for (var i = 0; i < $scope.timesheets.length; i++) {
					for (var j = $scope.timesheets[i].LineItems.length - 1; j >= 0; j--) {
						if ($scope.timesheets[i].LineItems[j].TAG === $scope.editTAG) {
							$scope.timesheets[i].LineItems.splice(j, 1);
						};
					};
				};

				for (var i = 0; i < $scope.timesheets.length; i++) {
					if ($scope.timesheets[i].LineItems.length === 0) {
						$scope.timesheets.splice(i, 1);
					};
				};
				try {
					var instr = {};
					instr.Instr = "Delete";
					instr.App = "Timesheet";
					instr.Object = $scope.LocalSyncObject;
					instr.Key = $scope.editTAG;
					instr.FunctionOnReturn = "";
					instr = 'MiTokn' + JSON.stringify(instr);
					if ($scope.testdata != true) {
						var _frameprework = document.createElement('iframe');
						_frameprework.width = 0; _frameprework.height = 0; _frameprework.frameBorder = 0;
						document.body.appendChild(_frameprework);
						
						try {
							if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
								try { 
									window.HtmlCommunicator.getDataFromHTML(instr); 
								} 
								catch (err) { 
									console.log("$scope.concatlocal->" + err.message());
								};
							}else{
								_frameprework.src = instr;
							};
						}
						catch (err){
							console.log("windows hack " + err.message());
						};
						
						setTimeout(function () { document.body.removeChild(_frameprework); }, 500);
					};
				}
				catch (err) {
					$scope.msgOnError("System Alert", "Failed while deleting Timesheets to device");
				};
			};

			$scope.editTimeSheet = function (type, tag) {
				
				try {
					$scope.checkAppOnlineOrOffline();
					$scope.editTAG = tag;
					$scope.resetHoursPerDay();
					$scope.typeOfTimeSheet = type;
					var editingFailed = false;
					$scope.lock.lockWeeklytime = false;
					$scope.lock.unlockJob = false;
					$scope.lockDate =false;
					$scope.signatureName = "";
					$scope.signature = "";
					$scope.supervisorEmail ="";
					$scope.newLineItems =[];
					$scope.today = new Date();
					$scope.today.setSeconds(0, 0);
					$scope.time.hoursWorked = '0.00';
					$scope.travel = false;
					$scope.DailyUlb = false;
					$scope.travelLocal = false;
					$scope.travelRemote = false;
					if (type === 'Daily') {
						for (var i = 0; i < $scope.timesheets.length; i++) {
							for (var j = 0; j < $scope.timesheets[i].LineItems.length; j++) {
								
								if ($scope.timesheets[i].LineItems[j].TAG === tag) {
									try{
										$scope.jobname = $scope.timesheets[i].LineItems[j].JobFullName;
										$scope.jobcode =$scope.timesheets[i].LineItems[j].Job;
										$scope.jobDesc = $scope.timesheets[i].LineItems[j].JobDesc;
										$scope.selectedJobObj = $scope.timesheets[i].LineItems[j].JobObj;
										$scope.defaultWCCode = $scope.timesheets[i].LineItems[j].WorkCentre;
										$scope.defaultWC = $scope.timesheets[i].LineItems[j].WorkCentreWithDisc;
										// $scope.selectedUser.Code = $scope.timesheets[i].LineItems[j].ActivityCode;
										$scope.selectedSite.FullName = $scope.timesheets[i].LineItems[j].SiteFullName;
										$scope.selectedUserNameList = $scope.timesheets[i].LineItems[j].selectedUserNameList;
										if($scope.connectionStatus == 'TRUE'){
											$scope.loadingInit = true;
											$scope.selectedJobACGroup = $scope.selectedJobObj.ActivityGroup;
											$scope.fetchData("Demo-01-JCActivity", "?group="+$scope.selectedJobACGroup.replace(/\s/g,'%20'), "editJobACList");
										}	
										// $scope.setSelectedJob($scope.selectedJobObj);
										if($scope.selectedJobObj == undefined && $scope.jobcode != undefined){
											$scope.allJobList.every(item =>{
												if(item.Code == $scope.jobcode){
													$scope.selectedJobObj = item;
													return false;
												}
												else{
													return true;
												}
											});
										};
									}
									catch(err){

									}

									if($scope.timesheets[i].LineItems[j].ActivityType =='Disbursement') {
										try{
											// $scope.selectedSite.Code = $scope.timesheets[i].LineItems[j].MainActivityCode;
											// $scope.selectedSite.FullName = $scope.timesheets[i].LineItems[j].MainActivityFullName;
											$scope.selectedSite.FullName = $scope.timesheets[i].LineItems[j].MainSiteFullName;
											if($scope.timesheets[i].LineItems[j].Quantity.includes(':')){
												$scope.timesheets[i].LineItems[j].Quantity = parseFloat($scope.timesheets[i].LineItems[j].Quantity.replace(':','.'));
											}
											else{
												$scope.timesheets[i].LineItems[j].Quantity = parseFloat($scope.timesheets[i].LineItems[j].Quantity);
											}
										}
										catch(err){
											$scope.timesheets[i].LineItems[j].Quantity = parseFloat($scope.timesheets[i].LineItems[j].Quantity);
										};
										
										$scope.newLineItems.push($scope.timesheets[i].LineItems[j]);
									}

									else{
										$scope.imageAttachments = angular.copy($scope.timesheets[i].LineItems[j].imageAttachments);
										for (ia = 0;ia<$scope.imageAttachments.length;ia++){
											if ((!$scope.imageAttachments[ia].src) && ($scope.imageAttachments[ia].BinaryData.Base64)){
												$scope.imageAttachments[ia].src = $scope.imageAttachments[ia].BinaryData.Base64.replace(/\s/g,'+');
											};
										};
										if($scope.imageAttachments.length < $scope.maxAttachments){
											$scope.addAttach=true;
										}else{
											$scope.addAttach=false;
										};
										$scope.travel = $scope.timesheets[i].LineItems[j].Travel;
										$scope.travelHr = $scope.timesheets[i].LineItems[j].TravelTime;
										$scope.jobname = $scope.timesheets[i].LineItems[j].JobFullName;
										$scope.jobDesc = $scope.timesheets[i].LineItems[j].JobDesc;
										$scope.jobcode =$scope.timesheets[i].LineItems[j].Job;
										$scope.selectedJobObj = $scope.timesheets[i].LineItems[j].JobObj;
										if($scope.connectionStatus == 'TRUE'){
											$scope.loadingInit = true;
											$scope.selectedJobACGroup = $scope.selectedJobObj.ActivityGroup;
											$scope.fetchData("Demo-01-JCActivity", "?group="+$scope.selectedJobACGroup.replace(/\s/g,'%20'), "editJobACList");
										}	
										// $scope.setSelectedJob($scope.selectedJobObj);
										if($scope.selectedJobObj == undefined && $scope.jobcode != undefined){
											$scope.allJobList.every(item =>{
												if(item.Code == $scope.jobcode){
													$scope.selectedJobObj = item;
													return false;
												}
												else{
													return true;
												}
											});
										};

			
										if ($scope.timesheets[i].LineItems[j].STATE == "Failed") {
											editingFailed = true;
											// $scope.signatureName = $scope.timesheets[i].LineItems[j].signatureName;
											// $scope.signature = $scope.timesheets[i].LineItems[j].signature.replace(/ /g, '+');
										};
										
										/*signature need to be cleared*/
										$scope.timesheets[i].LineItems[j].signature ="";
										$scope.timesheets[i].LineItems[j].signatureName ="";

										$scope.defaultWCCode = $scope.timesheets[i].LineItems[j].WorkCentre;
										$scope.defaultWC = $scope.timesheets[i].LineItems[j].WorkCentreWithDisc;
										// $scope.selectedUser.Code = $scope.timesheets[i].LineItems[j].ActivityCode;
										// $scope.selectedUser.FullName = $scope.timesheets[i].LineItems[j].ActivityFullName;
										$scope.selectedSite.FullName = $scope.timesheets[i].LineItems[j].SiteFullName;
										
										
										$scope.DailyUlb = $scope.timesheets[i].LineItems[j].DailyUlb;
										var date = angular.copy($scope.timesheets[i].LineItems[j].ListDate.split('/'));
										$scope.selectDate =angular.copy(new Date(date[2],(parseInt(date[1]) - 1), date[0] )) ;
										$scope.editTimeSheetDate = $scope.selectDate;
										var time = $scope.timesheets[i].LineItems[j].StartTime.split(':');
										$scope.time.startTime = new Date();
										$scope.time.startTime.setHours(time[0]);
										$scope.time.startTime.setMinutes(time[1]);
										$scope.time.startTime.setSeconds(0);
										$scope.time.startTime.setMilliseconds(0);
										var time1 = $scope.timesheets[i].LineItems[j].FinishTime.split(':');
										$scope.time.endTime = new Date();
										$scope.time.endTime.setHours(time1[0]);
										$scope.time.endTime.setMinutes(time1[1]);
										$scope.time.endTime.setSeconds(0);
										$scope.time.endTime.setMilliseconds(0);
										
										$scope.time.hoursWorked = $scope.timesheets[i].LineItems[j].OverTime !='' ? $scope.addHours($scope.timesheets[i].LineItems[j].Quantity, $scope.timesheets[i].LineItems[j].OverTime) : $scope.timesheets[i].LineItems[j].Quantity;
										$scope.pickerNumberOfHours = $scope.time.hoursWorked;
										$scope.StandardText = $scope.timesheets[i].LineItems[j].StandardText;
										$scope.supervisorEmail = $scope.timesheets[i].LineItems[j].supervisorEmail;
										/* round down and set text value for screen display */
								

										// if($scope.travel && $scope.timesheets[i].LineItems[j].StartTime == "00:00" && $scope.timesheets[i].LineItems[j].FinishTime == "00:00"){
										// 	$scope.time.hoursWorked = "0.00";
										// 	$scope.time.startTime = $scope.today;
											
										// 	/* round down and set text value for screen display */
										// 	let start = moment($scope.time.startTime);
										// 	let rem = (start.minute() % 15);
										// 	start = moment(start).subtract(rem, "minutes");
										// 	$scope.time.startTime = start.toDate();
										// 	$scope.time.endTime = $scope.time.startTime;
										// }

										var start = moment($scope.time.startTime);
										var end = moment($scope.time.endTime);
										
										let rem = (start.minute() % 15);
										let remEnd = (end.minute() % 15);

										start = moment(start).subtract(rem, "minutes");
										end = moment(end).subtract(remEnd, "minutes");

										$scope.time.startTime = start.toDate();
										$scope.time.endTime = end.toDate();

								
										$scope.pickerStartTime = start.format('HH:mm');
										$scope.pickerEndTime = end.format('HH:mm');
										$scope.DailyHours = start.format('HH:mm');
									};
								};
							};
						};
					};
					if (type === 'Weekly') {
						$scope.rawOutputWEDate = $scope.selectDate;
						$scope.travel = false;
						let countTS = 0;
						for (var i = 0; i < $scope.timesheets.length; i++) {
							for (var j = 0; j < $scope.timesheets[i].LineItems.length; j++) {
								if ($scope.timesheets[i].LineItems[j].TAG === tag) {

									$scope.DailyUlb = $scope.timesheets[i].LineItems[j].DailyUlb;
									$scope.travel = $scope.timesheets[i].LineItems[j].Travel;
									$scope.jobname = $scope.timesheets[i].LineItems[j].JobFullName;
									$scope.jobDesc = $scope.timesheets[i].LineItems[j].JobDesc;
									$scope.jobcode =$scope.timesheets[i].LineItems[j].Job;
									$scope.selectedJobObj = $scope.timesheets[i].LineItems[j].JobObj;
									if(countTS <= 1 && $scope.connectionStatus == 'TRUE'){
										$scope.loadingInit = true;
										$scope.selectedJobACGroup = $scope.selectedJobObj.ActivityGroup;
										$scope.fetchData("Demo-01-JCActivity", "?group="+$scope.selectedJobACGroup.replace(/\s/g,'%20'), "editJobACList");
										countTS += 1;
									}
									// $scope.setSelectedJob($scope.selectedJobObj);
									if($scope.selectedJobObj == undefined && $scope.jobcode != undefined){
										$scope.allJobList.every(item =>{
											if(item.Code == $scope.jobcode){
												$scope.selectedJobObj = item;
												return false;
											}
											else{
												return true;
											}
										});
									}

									$scope.defaultWCCode = $scope.timesheets[i].LineItems[j].WorkCentre;
									$scope.defaultWC = $scope.timesheets[i].LineItems[j].WorkCentreWithDisc;
									// $scope.selectedUser.Code = $scope.timesheets[i].LineItems[j].ActivityCode;
									// $scope.selectedUser.FullName = $scope.timesheets[i].LineItems[j].ActivityFullName;
									$scope.selectedSite.FullName = $scope.timesheets[i].LineItems[j].SiteFullName;
									
									/*signature need to be cleared*/
									$scope.timesheets[i].LineItems[j].signature ="";
									$scope.timesheets[i].LineItems[j].signatureName ="";
									var date = $scope.timesheets[i].ListDate.split('/');
									$scope.selectDate = new Date();
									var _month = parseInt(date[1]);
									_month = _month - 1;

									$scope.selectDate = new Date(date[2],_month, date[0], 08, 00,0 );
									$scope.rawOutputWEDate = $scope.selectDate;
									$scope.editTimeSheetDate = $scope.selectDate;
					
									for (var k = 0; k < $scope.hoursperday.length; k++) {
										if ($scope.hoursperday[k].Day === $scope.timesheets[i].LineItems[j].Day) {

											$scope.hoursperday[k].Hours = $scope.timesheets[i].LineItems[j].OverTime !='' ? $scope.addHours($scope.timesheets[i].LineItems[j].Quantity, $scope.timesheets[i].LineItems[j].OverTime) : $scope.timesheets[i].LineItems[j].Quantity;
											$scope.hoursperday[k].startTime = $scope.timesheets[i].LineItems[j].StartTime;
											$scope.hoursperday[k].endTime = $scope.timesheets[i].LineItems[j].FinishTime;
										};
									};
									$scope.calcDatePerDay();
									$scope.calcTotalHours();

									$scope.time = {};
									$scope.time.hoursWorked = "0.00";
									$scope.time.startTime = $scope.today;
									var time = $scope.timesheets[i].LineItems[j].ScreenStartTime.split(':');
									$scope.time.startTime = new Date();
									$scope.time.startTime.setHours(time[0]);
									$scope.time.startTime.setMinutes(time[1]);
									$scope.time.startTime.setSeconds(0);
									$scope.time.startTime.setMilliseconds(0);
									var time1 = $scope.timesheets[i].LineItems[j].ScreenFinishTime.split(':');
									$scope.time.endTime = new Date();
									$scope.time.endTime.setHours(time1[0]);
									$scope.time.endTime.setMinutes(time1[1]);
									$scope.time.endTime.setSeconds(0);
									$scope.time.endTime.setMilliseconds(0);
									/* round down and set text value for screen display */

									// if($scope.travel && $scope.timesheets[i].LineItems[j].ScreenStartTime == "00:00" && $scope.timesheets[i].LineItems[j].ScreenFinishTime == "00:00"){
									// 	$scope.time.startTime = $scope.today;
									// 	/* round down and set text value for screen display */
									// 	let start = moment($scope.time.startTime);
									// 	let rem = (start.minute() % 15);
									// 	start = moment(start).subtract(rem, "minutes");
									// 	$scope.time.startTime = start.toDate();
									// 	$scope.time.endTime = $scope.time.startTime;
									// }

									var start = moment($scope.time.startTime );								
									var end = moment($scope.time.endTime );																
									
									let rem = (start.minute() % 15);
									let remEnd = (end.minute() % 15);

									start = moment(start).subtract(rem, "minutes");
									end = moment(end).subtract(remEnd, "minutes");

									$scope.time.startTime = start.toDate();
									$scope.time.endTime = end.toDate();
									

									$scope.pickerStartTime = start.format('HH:mm');
									$scope.pickerEndTime = end.format('HH:mm');
									$scope.time.hoursWorked =  $scope.timesheets[i].LineItems[j].ScreenTotalHours;
									$scope.pickerNumberOfHours = $scope.time.hoursWorked;
									$scope.StandardText = $scope.timesheets[i].LineItems[j].StandardText;
									$scope.supervisorEmail = $scope.timesheets[i].LineItems[j].supervisorEmail;
								    $scope.imageAttachments = angular.copy($scope.timesheets[i].LineItems[j].imageAttachments);
									for (ia = 0;ia<$scope.imageAttachments.length;ia++){
										if ((!$scope.imageAttachments[ia].src) && ($scope.imageAttachments[ia].BinaryData.Base64)){
											$scope.imageAttachments[ia].src = $scope.imageAttachments[ia].BinaryData.Base64.replace(/\s/g,'+');
										};
									};
									if($scope.imageAttachments.length < $scope.maxAttachments){
										$scope.addAttach=true;
									}else{
										$scope.addAttach=false;
									};

								
									
								};
							};
						};
					};

					$scope.createDatePickers();
					if(!$scope.first){
						try{
							if(!$scope.time.startTime || !$scope.time.endTime){
								$scope.time.startTime = $scope.resetStartTimeMinutes($scope.today);
								$scope.time.startTime.setHours(8,0,0);

								$scope.time.endTime  = $scope.resetEndTimeMinutes($scope.today);
								$scope.time.endTime.setHours(8,0,0);
								
								$scope.pickerStartTime = moment($scope.time.startTime).format('HH:mm');
								$scope.pickerEndTime = $scope.pickerStartTime;
							}
							$scope.pickerDailyStart.setDate($scope.time.startTime);
							$scope.pickerDailyEnd.setDate($scope.time.endTime);
							$scope.pickerWeeklyStart.setDate($scope.time.startTime);
							$scope.pickerWeeklyEnd.setDate($scope.time.endTime);
						}
						catch(err){
							console.log(" error at set datepicker iat editTimesheet ",err)
						}
					}
					$scope.getWeekendingDate();	
					for (x = 0; x < $scope.Activities.length; x++) {

						if ($scope.Activities[x] !== undefined) {
							if ($scope.Activities[x].Code === $scope.lineItem.ActivityCode) {
								$scope.selectedActivity = $scope.Activities[x];
								break;
							};
						};
					};
					for (x = 0; x < $scope.WCS.length; x++) {
						if ($scope.WCS[x] !== undefined) {
							if ($scope.WCS[x].Code === $scope.lineItem.WorkCentre) {
								$scope.selectedWorkcentre = $scope.WCS[x];
								break;
							};
						};
					};
					if ($scope.imageAttachments.length < $scope.maxAttachments){
						$scope.addAttach=true;
					}else{
						$scope.addAttach=false;
					};

				} catch (err) {

					console.log("Error in editTimeSheet=> " +err.message);

				};


				if (type === 'Weekly') {
					$scope.lockWeekly = false;
					
					$('.pw-weekly').toggleClass('active');
				} else {
					$scope.lockDaily = false;
					
					$('.pw-edit').toggleClass('active');

				};
			};

			$scope.resetStartTimeMinutes = (startDateObj)=>{
				var start = moment(startDateObj);
				var rem = (start.minute() % 15);
				start = moment(start).subtract(rem, "minutes");
				return start.toDate();
			};

			$scope.resetEndTimeMinutes = (endDateObj)=>{
				var end = moment(endDateObj);
				var remEnd = (end.minute() % 15);
				end = moment(end).subtract(remEnd, "minutes");
				return end.toDate();
			};

			$scope.createDateTime = (date, hms)=>{
				const newDateTime = new Date(date[2],(parseInt(date[1]) - 1), date[0]);
				newDateTime.setHours(hms[0]);
				newDateTime.setMinutes(hms[1]);
				newDateTime.setSeconds(0);
				newDateTime.setMilliseconds(0);
				return newDateTime;
			};

			$scope.toggleExpand = function (index) {
				var item = '#expand-' + index;
				var btn_item = '#btn-expand-' + index;

				var ex = index;

				$(item).toggleClass('expand');
				$(btn_item).toggleClass('expand');

				$scope.expanded = !$scope.expanded;
			};

			$scope.filterJobs = function (job) {
				for (x = 0; x < $scope.Jobs.length; x++) {
					if ($scope.Jobs[x] !== undefined) {
						if ($scope.Jobs[x].Code !== undefined) {
							if ($scope.Jobs[x].Code === job) {
								$scope.selectedJob = $scope.Jobs[x];
								break;
							};
						};
					};
				};
			};
			
          	$scope.showErrorIfNotSelectedJob = function (param) {
              if($scope.jobcode===undefined || $scope.jobcode===""){
                  $scope.msgOnError('Timesheet', 'Please enter job code');                
                  return;                
              };              
          };
          
          	$scope.showErrorIfNotSelectedWCActivityGroup = function () {
                if($scope.selectedWCActivityGrp===""){
                    $scope.msgOnError('Timesheet', 'Please enter work centre!');
                    return;
                };
            };

			$scope.resetJobs = function () {
				$scope.selectedJob = {};
			};

			$scope.closeEdit = function () {
				$scope.updateTimesheet();
				$scope.captureClose();
			};

			$scope.imgDelete = function (index) {
				$scope.imageAttachments.splice(index, 1);
				if ($scope.imageAttachments.length < $scope.maxAttachments){
					$scope.addAttach=true;
				};
    		};

			
			$scope.setSelectedJob = function (jobItem){
				if(jobItem===undefined || jobItem===''){
					$scope.jobname='';
					$scope.selectedJobACGroup='';
					$scope.selectedWCActivityGrp='';
				}else{
					if($scope.connectionStatus == 'TRUE'){
						$scope.WCS = [];
						$scope.defaultWC="";
						$scope.selectedActivity= {};
						$scope.Activities= []
					
						$scope.MakeModel="";
						$scope.RegoFleet="";
						$scope.SerialVIN ="";
						$scope.KMHrS="";
						$scope.NotesLeft="";

						$scope.supervisorEmail ="";
						$scope.showEmail =false;
						$scope.selectedJobObj = jobItem;
						$scope.jobDesc = jobItem.Name;
						$scope.jobname =jobItem.Code + "-"+jobItem.Name;
						$scope.jobcode =jobItem.Code;
						$scope.selectedJobACGroup=jobItem.ActivityGroup;

						$scope.jobManagerCode = jobItem.JobManager;
						$scope.fetchData('GetTheEmployee','/'+jobItem.JobManager, 'setJobManager');
						/*Read notes from Job*/
						var notes =  jobItem.Notes;
						/*if(notes!=undefined&& notes!=""){
							if(notes.includes("Make/Model")){
								var mmIndex = jobItem.Notes.indexOf("Make/Model:");
								var rfIndex = jobItem.Notes.indexOf("Rego/Fleet:");
								$scope.MakeModel = jobItem.Notes.substring(mmIndex+11,rfIndex);
								var vinIndex = jobItem.Notes.indexOf("Serial/VIN:");
								$scope.RegoFleet = jobItem.Notes.substring(rfIndex+11,vinIndex);
								var khIndex = jobItem.Notes.indexOf("Kms/Hours:");
								$scope.SerialVIN = jobItem.Notes.substring(vinIndex+11,khIndex);
								if(notes.includes("Technician")){
									var tIndex = jobItem.Notes.indexOf("Technician:");
									$scope.KMHrS = jobItem.Notes.substring(khIndex+10,tIndex);
									$scope.NotesLeft = jobItem.Notes.substring(tIndex);
									$scope.NotesLeft =$scope.NotesLeft.replace(/\\r\\n/gm,"%5Cr%5Cn");
								}else{
									$scope.KMHrS = jobItem.Notes.substring(khIndex+10);
									$scope.NotesLeft="";
								};
								$scope.oldNotes="Previous: " + " Make/Model:" + angular.copy($scope.MakeModel).replaceAll("\r\n" ," ")+
												", Rego/Fleet:" + angular.copy($scope.RegoFleet).replace(/\\r\\n/gm ," ") +
												", Serial/VIN:"+ angular.copy($scope.SerialVIN).replace(/\\r\\n/gm ," ") +
												", Kms/Hours:"+ angular.copy($scope.KMHrS) + 
												"  " + angular.copy($scope.NotesLeft) ;
							};
						};

						// Show or not show email box depend on profit centre
						if($scope.selectedJobObj.ProfitCentre!=undefined){
							for(var m= 0; m<$scope.ListManagers.length; m++){
								if($scope.ListManagers[m].Title == $scope.selectedJobObj.ProfitCentre && $scope.ListManagers[m].Value3 =='Yes' ){
									$scope.showEmail =true;
									$scope.supervisorEmail = $scope.selectedJobObj.SiteAddress.Contact;
								};
							};
						};*/

						$scope.IsleaveJobTrue = false;
						$scope.selectedJobObj.UserDefinedFields.every(item => {
							if(item.Name=='Leave Job' && item.Value==true){
								$scope.IsleaveJobTrue = true;
								return false;
							}
							else return true;
						});
						$scope.currentStatus = "Fetching Activity Code";
						$scope.loadingAC = true;
						$scope.getActivityCodesForJob();
					}
					if($scope.connectionStatus == 'FALSE'){
						$scope.msgOnErrorConn("Your Offline","Please connect to Online");
					}
				
				};

			};
			$scope.setSelectedActivity = function (ActivityItem){
				if(ActivityItem===undefined || ActivityItem===''){
					$scope.selectedActivity = {};
				}else{
					$scope.selectedActivity = ActivityItem;
					$scope.selectedActivity.FullName = ActivityItem.Code+" - "+ActivityItem.Description;
					if($scope.connectionStatus == 'TRUE'){
						if(ActivityItem.DefaultWorkCentre != $scope.defaultWCCode){
							$scope.currentStatus = "Loading default workcentre of AC";
							$scope.loadingWC= true;
							$scope.getDefualtWCBasedOnSelectedActivity(ActivityItem.DefaultWorkCentre);
						}
					}
					else if($scope.connectionStatus == 'FALSE'){
						$scope.msgOnErrorConn("Your Offline","Please connect to Online");
					}
				};

			};
			$scope.setSelectedDisActivity = function (ActivityItem, index){
				if(ActivityItem===undefined || ActivityItem===''){
					$scope.selectedActivity = {};
				}else{
					$scope.newLineItems[index].ActivityCode = ActivityItem.Value1;
					/*$scope.newLineItems[index].Quantity = 1;*/
					$scope.newLineItems[index].ActivityFullName = ActivityItem.Title;				};
			};

			$scope.setSelectedPlantJob = function (JobItem, index){
				if(JobItem===undefined || JobItem===''){
					return;
				}else{
					$scope.newPlantLineItems[index].PlantJob = JobItem.Code;
					$scope.getPlantJobDefaultActivity(JobItem.PlantActivityCode);
					$scope.newPlantLineItems[index].ActivityCode = JobItem.PlantActivityCode;
					$scope.PlantActivities = angular.copy($scope.Activities);
				};
			};

			$scope.setSelectedPlantActivity = function (ActivityItem, index){
				if(ActivityItem===undefined || ActivityItem===''){
					return;
				}else{
					$scope.newPlantLineItems[index].ActivityCode = ActivityItem.Code;
					$scope.newPlantLineItems[index].WorkCentre = ActivityItem.DefaultWorkCentre;
				};
			};
			/*$scope.setSelectedEmployee = function (employee){
				if(employee===undefined || employee===''){
					$scope.selectedEmployee = {};
				}else{
					var paramExist =false;
					for(var a=0; a<employee.Parameters.UserExtracts.length;a++){
						if(employee.Parameters.UserExtracts[a].objectName==="Demo-01-GetEmployee" && employee.Parameters.UserExtracts[a].parmName==="Employee"){
							var paramExist =true;

							$scope.selectedEmployee.name = employee.name +" " + employee.surname;
							$scope.selectedEmployee.code = employee.Parameters.UserExtracts[a].parmVal;
							if($scope.connectionStatus=='TRUE'){
								$scope.loadingInit = true;
							}
							$scope.getEmployeeDetails($scope.selectedEmployee.code);
							$scope.selectedEmployee.obj = employee;	
						};
					};
					if(!paramExist){
						$scope.msgOnError("Employee Parameter not set!","Please contact admin");
					};		
							
				};
			};*/
			$scope.resetWCAndActivity = function (){
				if($scope.testdata===true ){
					return;
				};
				$scope.jobWCPlan="";
				$scope.workcentreList=[];
              	$scope.defaultWC="";
              	$scope.WCS = [];
              	$scope.Activities= []
				$scope.selectedActivity= {};
			};
			$scope.resetActivity = function () {
				$scope.selectedActivity = {};
				
			};

			$scope.resetSite = function () {
				$scope.selectedSite = {};
			};

			$scope.resetWorkCentre = function () {
				$scope.selectedWorkcentre = {};
			};


			
			$scope.sleep = function(ms){
				/* wait for ms */
				return new Promise(resolve => setTimeout(resolve, ms));
			};

			$scope.createHeaderObject = function(key, value){
				var header = {};
				header.key = key;
				header.value = value;
				return header;
			};
			
			$scope.createDatePickers = function (){
				if ($scope.first) {
					try {
						var _startPick = document.getElementById('dailystart');
						$scope.pickerDailyStart = new Picker(_startPick, {
							format: 'HH:mm',
							date: $scope.time.startTime,
							increment: { minute: 15 },
							headers: true,
							text: {
								title: "Time selection to set time",
							},
						});
						var _endPick = document.getElementById('dailyend');
						$scope.pickerDailyEnd = new Picker(_endPick, {
							format: 'HH:mm',
							date: $scope.time.endTime,
							increment: { minute: 15 },
							headers: true,
							text: {
								title: "Time selection to set time",
							},
						});

						var _startWeeklyPick = document.getElementById('weeklystart');
						$scope.pickerWeeklyStart = new Picker(_startWeeklyPick, {
							format: 'HH:mm',
							date: $scope.time.startTime,
							increment: { minute: 15 },
							headers: true,
							text: {
								title: "Time selection to set time",
							},
						});
						var _endWeeklyPick = document.getElementById('weeklyend');
						$scope.pickerWeeklyEnd = new Picker(_endWeeklyPick, {
							format: 'HH:mm',
							date: $scope.time.endTime,
							increment: { minute: 15 },
							headers: true,
							text: {
								title: "Time selection to set time",
							},
						});

						var _startDayPick = document.getElementById('weeklydaystart');
						$scope.pickerDayStart = new Picker(_startDayPick, {
							format: 'HH:mm',
							date: $scope.dayEntry.startTime,
							increment: { minute: 15 },
							headers: true,
							text: {
								title: "Time selection to set time",
							},
						});
						var _endDayPick = document.getElementById('weeklydayend');
						$scope.pickerDayEnd = new Picker(_endDayPick, {
							format: 'HH:mm',
							date: $scope.dayEntry.endTime,
							increment: { minute: 15 },
							headers: true,
							text: {
								title: "Time selection to set time",
							},
						});
					}
					catch (err) {
						console.log("Error in createDatePickers: " + err.message);
					};
					$scope.first = false;
				};
			};

			$scope.clearSelections = function(){
				$scope.resetJobs();
				$scope.jobcode = "";
				$scope.resetWorkCentre();
				$scope.defaultWCCode = "";
				$scope.defaultWC = "";
				$scope.jobWCPlan = "";
				$scope.resetSite();
				$scope.jobname = "";
				$scope.time = {};
				$scope.standardText = "";
				$scope.SearchJobText = "";
				$scope.SearchWCText = "";
				$scope.activityFilter = "";
				$scope.TravelDataDaily = {travelHr:"",standBy:"",delay:""}

			};


			$scope.popupWindow = function (param) {
				$scope.showEmail =true;
				$scope.lockDaily =true;
				$scope.lockWeekly =true;
				$scope.typeOfTimeSheet = param;
				for(let i=0; i<$scope.AllUserList.length; i++){
					$scope.AllUserList[i].check = false
				};
				$scope.selectedUserNameList = [];
				$scope.selectedUserList = [];

				$scope.showMoreEntry =false;
				$scope.MakeModel = "";
				$scope.RegoFleet = "";
				$scope.SerialVIN = "";
				$scope.KMHrS = "";
				$scope.oldNotes="";
	
				$scope.loadingAC =false;
				// $scope.jobcode ="";
				$scope.selectedJobObj ={};
				$scope.supervisorEmail ="";
				$scope.newLineItems =[];
				$scope.newPlantLineItems =[];
				// $scope.lockDaily =true;
				// $scope.lockWeekly =true;
				$scope.showSignatureNote =false;
				$scope.showSVList =false;
				$scope.lockDate =false;
				$scope.externalLock =true;	
				$scope.sendTStoTokn = false;

				$scope.totalHours = "0.00";
				$scope.selectDate = new Date();
				// $scope.jobname = "";
				$scope.StandardText = "";
				$scope.selectedJob = {};
				$scope.editTAG = "None";
				/*$scope.selectedActivity = {};*/
				$scope.selectedWorkcentre = {};
				$scope.time = {};
				$scope.time.hoursWorked = "0.00";
				$scope.pickerNumberOfHours = "0.00";
				$scope.time.startTime = $scope.today;
				$scope.time.endTime  = $scope.today;
				$scope.travel = true;

				$scope.DailyUlb = true;		
				$scope.imageAttachments = [];
				$scope.rawOutputWEDate ="";
				$scope.selectedEmployee={
					"name":"",
					"code":"",
					"obj":{}
				};
				if ($scope.imageAttachments.length < $scope.maxAttachments){
					$scope.addAttach=true;
				};
				if ($scope.testdata){
					for (x=0;x<4;x++){
						var obj = new Object();
						obj.src = $scope.getLogo();
						$scope.imageAttachments.push(obj);
					};
				};

				$scope.email = "";
				/*$scope.externalemail = "";*/

				/* round down and set text value for screen display */
				var start = moment($scope.time.startTime);
				//console.log("moment func with param startTime",start)
				var rem = (start.minute() % 15);
				start = moment(start).subtract(rem, "minutes");

				var end = moment($scope.time.endTime);
				var remEnd = (end.minute() % 15);
				end = moment(end).subtract(remEnd, "minutes");

				$scope.time.startTime = start.toDate();
				$scope.time.startTime.setHours(8,0,0);
				$scope.time.endTime = $scope.time.startTime;//end.toDate();

				$scope.pickerStartTime = start.format('HH:mm');
				$scope.pickerEndTime = start.format('HH:mm');
				$scope.pickerDayStartTime = start.format('HH:mm');
				$scope.pickerDayEndTime = start.format('HH:mm');

				$scope.DailyHours = start.format('HH:mm');

				$scope.createDatePickers();

				$scope.pickerDailyStart.setDate($scope.time.startTime);
				$scope.pickerDailyEnd.setDate($scope.time.endTime);
				$scope.pickerWeeklyStart.setDate($scope.time.startTime);
				$scope.pickerWeeklyEnd.setDate($scope.time.endTime);

				let startTime = $scope.pickerDailyStart.date;
				let endTime = $scope.pickerDailyEnd.date;
				$scope.time.hoursWorked = $scope.subtractTime(endTime, startTime);

				/* round down and set text value for screen display */

				$scope.signatureName = "";
				$scope.signature = "";

				$scope.numOfSyncs=0;
				$scope.syncMethodText='';

				$scope.getWeekendingDate();
				if (param == "weekly") {
					$scope.lockWeekly = true;
					$scope.selectDate = $scope.rawOutputWEDate;
					$scope.index.dayIndex = 0;
					$scope.resetHoursPerDay();
					$scope.calcDatePerDay();
					$(".pw-weekly").addClass("active");
				};
				if (param == "daily") {
					$scope.lockDaily = true;
					$(".pw-daily").addClass("active");
				};
			};



			$scope.closepopup = function (dlt) {
				if(dlt != "Delete" && $scope.editTAG != "None"){
					for(var x =0; x<$scope.newLineItems.length;x++){
						if (($scope.newLineItems[x].ActivityCode== "") || ($scope.newLineItems[x].Quantity== null || $scope.newLineItems[x].Quantity== undefined || $scope.newLineItems[x].Quantity== "" || $scope.newLineItems[x].Quantity== 0)) {
							$scope.msgOnError('Disbursements', 'Please select activity and enter hours for disbursements ');
							return false;
						};
					};
				};
				$scope.clearSelections();
                $('.popup-window').find('.expand').removeClass('expand');
				$('.popup-window').removeClass('active');

			};

			$scope.setSelectedSite = function (siteItem){
				if(siteItem===undefined || siteItem===''){
					$scope.selectedSite = {};
				}else{
					$scope.selectedSite = siteItem;
					$scope.selectedSite.FullName = siteItem.Title;
				};
			};

			$scope.dayEntryHoursClean = function(hours){
				var _components = hours.split(":");
				try {
					_components[0] = $scope.stripNonDigits(_components[0]);
					if (_components[0] == ""){
						_components[0] = "00";
					};
					_components[1] = $scope.stripNonDigits(_components[1]);
					_components[1] = _components[1].substr(0,2);
					if (_components[1] == ""){
						_components[1] = "00";
					};
					if (_components[1].length != 2){
						_components[1] = _components[1].concat("0");
					};
				}
				catch (err){
					_components[0] = $scope.stripNonDigits(hours.substr(0,2));
					if (_components[0] == ""){
						_components[0] = "00";
					};
					_components[1] = $scope.stripNonDigits(hours.substr(2,2));
					if (_components[1] == ""){
						_components[1] = "00";
					};

				};
				return _components[0] + ":" + _components[1];
			};

			$scope.windowHours = function (index, cancel) {
				try {
					console.log(index, cancel);
					if (!cancel) {
						if ($scope.testdata == false) {
							var _check_input = true;
							if ((typeof ($scope.signature) != 'undefined') && ($scope.signature != "")) {
								$scope.msgOnError('Supervisor already signed out', 'Please delete the signature before making any changes.');
								return;
							};

							if ($scope.jobname !== "") {

								if (($scope.time.StartTime == "") || ($scope.time.FinishTime == "")) {
									$scope.msgOnError('Start & End Time Required', 'Please enter Start and End Time as it is not defined');
								};
							};
						};
						/*Check if we have a local timesheet for this combination of day, job, starttime and end time*/
						if($scope.checkOverlapTimesOnWeekly('Weekly')){
							return;
						};
						if ($scope.checkDuplicate('Weekly')){
							$scope.msgOnError("Duplicate", "You already have a timesheet for the same day, job, and timing");
							$scope.pickerDayEndTime = $scope.pickerDayStartTime;
							$scope.pickerDayEnd.date = $scope.pickerDayStart.date;
							$scope.adjustDayTime();
							return;
						};
						if($scope.dayEntry.travelHr == '' || $scope.dayEntry.travelHr == undefined){
							$scope.msgOnError("Travel Hours is Required", "Please enter the travel hours");
							return;
						}

						if($scope.dayEntry.Hours != "0.00"  ||$scope.dayEntry.Hours !=0 ){
							$scope.dayEntry.Hours = $scope.dayEntryHoursClean($scope.dayEntry.Hours);
						};
						$scope.hoursperday[index] = $scope.dayEntry;
						$scope.calcDatePerDay();
						$scope.calcTotalHours();
					}
					else {
						$scope.dayEntry = {};
						$scope.dayEntry.Day = $scope.hoursperday[index].Day;
						$scope.dayEntry.Hours = $scope.hoursperday[index].Hours;
						$scope.dayEntry.Date = $scope.hoursperday[index].Date;
						$scope.dayEntry.startTime = $scope.hoursperday[index].startTime;
						$scope.dayEntry.endTime = $scope.hoursperday[index].endTime;
						$scope.dayEntry.travelHr =$scope.hoursperday[index].travelHr;
						$scope.dayEntry.standBy =$scope.hoursperday[index].standBy;
						$scope.dayEntry.delay =$scope.hoursperday[index].delay;

						if ($scope.dayEntry.startTime == "") {
							$scope.dayEntry.startTime = $scope.time.startTime;
						}
						else {
							$scope.dayEntry.startTime = $scope.createDateObject($scope.dayEntry.Date, $scope.dayEntry.startTime );
						};
						if ($scope.dayEntry.endTime == "") {
							$scope.dayEntry.endTime = $scope.time.endTime;
						}
						else {
							$scope.dayEntry.endTime = $scope.createDateObject($scope.dayEntry.Date, $scope.dayEntry.endTime);
						};
						if($scope.dayEntry.endTime == $scope.dayEntry.startTime && $scope.time.startTime != $scope.time.endTime){
							$scope.dayEntry.startTime = $scope.time.startTime;
							$scope.dayEntry.endTime = $scope.time.endTime;
						};

						$scope.pickerDayStart.setDate($scope.dayEntry.startTime);

						var start = moment($scope.dayEntry.startTime);
						$scope.pickerDayStartTime = start.format("HH:mm");

						$scope.pickerDayEnd.setDate($scope.dayEntry.endTime);
						var end = moment($scope.dayEntry.endTime);
						$scope.pickerDayEndTime = end.format("HH:mm");
						if($scope.time.hoursWorked !="0.00"){
							$scope.adjustDayTime();
						};
					};
					$('.pw-weeklyhours').toggleClass('active');
				} catch (err) {
				
					$scope.msgOnError("Error in Hours selection", "Please check your Hours entry formats");
				};

			};

			$scope.createDateObject = function (inDate, inTime){
				try {
					var dateComp = inDate.split("/");
					if ( Object.prototype.toString.call(inTime) === "[object Date]" ){ 
						return inTime;
					};
					var timeComp = inTime.split(":");
                    var beginDate = new Date(dateComp[2], dateComp[1] -1, dateComp[0], timeComp[0], timeComp[1], timeComp[2], 0);
					return beginDate;
				}
				catch (err){

				};
				return "";
			};

			$scope.captureClose = function () {
				$('.pw-weeklyhours').removeClass('active');
			};

			$scope.msgOnError = function (param, value) {
				iziToast.error({
					title: param,
					message: value,
					position: 'center',
					transitionIn: 'flipInX',
					transitionOut: 'flipOutX',
					timeout: 5000,
				});
			};

			$scope.msgOnErrorConn = function (param, value) {
				iziToast.error({
					title: param,
					message: value,
					position: 'topCenter',
					transitionIn: 'flipInX',
					transitionOut: 'flipOutX',
					timeout: 5000,
				});
			};

			$scope.msgOnSuccess = function (param, value) {
				iziToast.success({
					title: param,
					message: value,
					position: 'center',
					transitionIn: 'flipInX',
					transitionOut: 'flipOutX',
					timeout: 5000,
				});
			};

			$scope.msgOnWarning = function (param, value) {
				iziToast.warning({
					title: param,
					message: value,
					position: 'center',
					transitionIn: 'flipInX',
					transitionOut: 'flipOutX',
					timeout: 5000,
				});
			};

			$scope.msgInfo = function (param, value) {
				iziToast.info({
					title: param,
					message: value,
					position: 'center',
					displayMode : 2,
					transitionIn: 'flipInX',
					transitionOut: 'flipOutX',
					timeout: 5000,
				});
			};

			$scope.OkMessage = function () {
				iziToast.info({
					title: 'Timesheet',
					message: 'Timesheet saved for later',
					position: 'center',
					transitionIn: 'flipInX',
					transitionOut: 'flipOutX',
					timeout: 5000,
				});
			};

			$scope.incrementTime = function () {
				try {
					$scope.lineItem.Quantity = parseFloat($scope.lineItem.Quantity) + $scope.interval;
					$scope.lineItem.sent = "";
				}
				catch (err) {

				};
			};
			$scope.decrementTime = function () {
				try {
					$scope.lineItem.Quantity = parseFloat($scope.lineItem.Quantity) - $scope.interval;
					if ($scope.lineItem.Quantity < 0) {
						$scope.lineItem.Quantity = 0;
					};

					$scope.lineItem.sent = "";
				}
				catch (err) {

				};
			};

			$scope.calcTime = function () {

				$scope.captureTimesheet.StartTime = "";
				$scope.captureTimesheet.FinishTime = "";

				var finTime = new Date().getTime();
				var strTime = finTime - ($scope.captureTimesheet.Quantity * 3600000);
				$scope.captureTimesheet.FinishTime = new Date(finTime).toLocaleTimeString('it-IT');
				$scope.captureTimesheet.StartTime = new Date(strTime).toLocaleTimeString('it-IT');

			};

			$scope.adjustTime = function () {
				/* set the values */
				/*$scope.time.startTime = angular.copy($scope.pickerDailyStart.date);
				$scope.time.endTime = angular.copy($scope.pickerDailyEnd.date);
				$scope.time.DailyHours = angular.copy($scope.pickerDailyhours);*/

				$scope.time.startTime = $scope.pickerDailyStart.date;
				$scope.time.endTime = $scope.pickerDailyEnd.date;
				$scope.time.DailyHours = $scope.pickerDailyhours;
				$scope.overTimeHours = "0.00";
				if($scope.time.startTime.toString() == $scope.time.endTime.toString() ){
					$scope.time.hoursWorked="0.00";
					return;
				};

				if ($scope.time.endTime != "" && $scope.time.startTime != "") {
					$scope.time.hoursWorked = $scope.subtractTime($scope.time.endTime, $scope.time.startTime);

					if($scope.time.startTime.toString() != $scope.time.endTime.toString()){
						let validTime = $scope.subHours(moment($scope.time.endTime).format('HH:mm'), moment($scope.time.startTime).format('HH:mm')).split(':');
						if(parseInt(validTime[1]) < 30 && parseInt(validTime[0]) == 0 && $scope.DailyUlb){
							$scope.msgOnError('Required time', 'Please select minimum half an hour');
							$scope.time.endTime = $scope.time.startTime;
							$scope.pickerStartTime =  moment($scope.time.startTime).format('HH:mm');
							$scope.pickerEndTime = $scope.pickerStartTime;
							$scope.pickerDailyStart.setDate($scope.time.endTime);
							$scope.pickerDailyEnd.setDate($scope.time.endTime);
							$scope.time.hoursWorked = $scope.subtractTime($scope.time.endTime, $scope.time.startTime);
							return;
						};
					};

					if($scope.time.hoursWorked.includes(":")){
						if($scope.selectDate.getDay() !=6 && $scope.selectDate.getDay()!=0 &&  $scope.minuteConverter($scope.time.hoursWorked) > 8){
							$scope.overTimeHours = $scope.subHours($scope.time.hoursWorked, "08:00");	
						}
						else if($scope.selectDate.getDay()==6 || $scope.selectDate.getDay()==0){
							$scope.overTimeHours = $scope.time.hoursWorked;	
						};
					};
					/*Check if we have a local timesheet for this combination of day, job, starttime and end time*/
					if ($scope.checkDuplicate('Daily')){
                        $scope.msgOnError("Duplicate", "You already have a timesheet for the same day, job, and timing");
						$scope.pickerEndTime = $scope.pickerStartTime;
						$scope.time.endTime = $scope.time.startTime;
						$scope.time.hoursWorked = $scope.subtractTime($scope.time.endTime, $scope.time.startTime);
                        return;
                    };
				};

			};


			

			$scope.getUserUDFData = (fieldName)=>{
				try{
					let result = $scope.user.UserDefinedFields.filter(item=>{
						if(item.Name == fieldName){
							return true;
						}
					});
					if(result.length != 0){
						return result[0].Value;
					}
					return '';
				}
				catch(err){
					console.log(" error occured at getUserUDFData function ",err);
				}
			};

			$scope.convertDecimalValueToTime = (decimalValueTime)=>{
				try{
					let decimalTime = parseFloat((decimalValueTime));
					decimalTime = decimalTime * 60 * 60;
					var hours = Math.floor((decimalTime / (60 * 60)));
					decimalTime = decimalTime - (hours * 60 * 60);
					var minutes = Math.floor((decimalTime / 60));
					decimalTime = decimalTime - (minutes * 60);
					var seconds = Math.round(decimalTime);
					if(hours < 10){
						hours = "0" + hours;
					}
					if(minutes < 10){
						minutes = "0" + minutes;
					}
					if(seconds < 10){
						seconds = "0" + seconds;
					}
					return hours+":"+minutes;
				}
				catch(err){

				};
			};

			$scope.minuteConverter = (time) => {
				try{
					const [h, m] = time.split(':');
					const value = +h + +m / 60;
					return value.toFixed(2);
				}
				catch(err){
					console.log("error at minuteConverter function ",err);
				};
			};

			$scope.subHours = function (time1, time2) {
				try{
					var hours = parseFloat($scope.minuteConverter(time2));
					time1 = new moment(time1, 'HH:mm')
					return (moment(time1).subtract(hours, 'hours').format('HH:mm'));
				}
				catch(err){
					console.log("error at subHours function ",err);
				};

			};

			$scope.addHours = function (time1, time2) {
				try{
					var sumHours;
					var hours = parseFloat($scope.minuteConverter(time2));
					time1 = new moment(time1, 'HH:mm')
					sumHours =  (moment(time1).add(hours, 'hours').format('HH:mm'));
					return sumHours;
				}
				catch(err){
					console.log("error at addHours function ",err);
				};
			};

			$scope.addHoursTotal = function (time1, time2) {
				var totalmins = 0;
				totalmins = parseInt($scope.calcMins(time1)) + parseInt($scope.calcMins(time2));

				var hours = parseInt(totalmins / 60).toString();
				mins = (totalmins % 60).toString();
				return (("0" + hours).slice(-2)) + ":" + ("0" + mins).slice(-2)+":00";
			};

			$scope.subHoursTotal = function (time1, time2) {
				var totalmins = 0;
				totalmins = parseInt($scope.calcMins(time1)) - parseInt($scope.calcMins(time2));

				var hours = parseInt(totalmins / 60).toString();
				mins = (totalmins % 60).toString();
				return (("0" + hours).slice(-2)) + ":" + ("0" + mins).slice(-2);
			};

			$scope.calcMins = (hours)=>{
				try{
					let totalmins = 0;
					let mins = 0;
					let splitAT = ":";
					if (typeof (hours) == 'string') {
						if (hours.length === 2) {						
							hours += ":00";
						};
					
						if (hours.indexOf(":") > -1) {
							splitAT = ":";
						};
						var timearr = hours.split(splitAT);
				
						/*Remove anything that is isnt a number from the individual fields*/
						
						timearr[0] = $scope.stripNonDigits(timearr[0]);
						timearr[1] = $scope.stripNonDigits(timearr[1]);
						
						mins = parseInt(timearr[0]) * 60 + parseInt(timearr[1]);
						totalmins += mins;
					};
					return totalmins;
				}
				catch(err){

				};
			};

			$scope.reduceHours = function(type){
				if(type=='Daily' && $scope.time.hoursWorked =="0.00"){
					return;
				}
				if(type=='Daily' && $scope.time.startTime.toString() != $scope.time.endTime.toString()){
					let validTime = $scope.subHours(moment($scope.time.endTime).format('HH:mm'), moment($scope.time.startTime).format('HH:mm')).split(':');
					if(parseInt(validTime[1]) < 30 && parseInt(validTime[0]) == 0){
						if($scope.DailyUlb){
							$scope.msgOnError('Required time', 'Please select minimum half an hour');
							$scope.DailyUlb =false;
						}
						return;
					}
					else if($scope.time.hoursWorked != "0.00"){
						$scope.reduceHalfAnHour();
					};
				};
				if(type=='Weekly'){
					if($scope.time.startTime.toString() == $scope.time.endTime.toString() || $scope.time.hoursWorked == "0.00"){
						$scope.reduceHoursInWeekly();
					}
					else if($scope.time.startTime.toString() != $scope.time.endTime.toString()){
						let validTime = $scope.subHours(moment($scope.time.endTime).format('HH:mm'), moment($scope.time.startTime).format('HH:mm')).split(':');
						if(parseInt(validTime[1]) < 30 && parseInt(validTime[0]) == 0){
							if($scope.DailyUlb){
								$scope.msgOnError('Required time', 'Please select minimum half an hour');
								$scope.DailyUlb =false;
							}
							$scope.reduceHoursInWeekly();
							return;
						}
						else if($scope.time.hoursWorked != "0.00"){
							$scope.reduceHalfAnHour();
							$scope.reduceHoursInWeekly();
						};
					};
				}
			};

			$scope.reduceHoursInWeekly = ()=>{
				var count =0;
				for(var i =0; i< $scope.hoursperday.length;i++){
					let validTime = $scope.subHours(moment($scope.hoursperday[i].endTime).format('HH:mm'), moment($scope.hoursperday[i].startTime).format('HH:mm')).split(':');
					if(!(parseInt(validTime[1]) < 30 && parseInt(validTime[0]) == 0)){
						if($scope.hoursperday[i].Hours !=0 && $scope.hoursperday[i].Day !="Total"){
							var temp =$scope.hoursperday[i].Hours;
							$scope.hoursperday[i].Hours = $scope.reduceOrAddHalfHour(temp);
							count++;
						};
					}
				};
				for(var j =0; j< count; j++){
					var temp2 =$scope.hoursperday[7].Hours;
					$scope.hoursperday[7].Hours = $scope.reduceOrAddHalfHour(temp2);
				};
			};
	
			$scope.adjustWeeklyTime = function () {
				/* set the values */
				$scope.time.startTime = angular.copy($scope.pickerWeeklyStart.date);
				$scope.time.endTime = angular.copy($scope.pickerWeeklyEnd.date);

				if ($scope.time.endTime != "" && $scope.time.startTime != "") {
					$scope.time.hoursWorked = $scope.subtractTime($scope.time.endTime, $scope.time.startTime);

					if($scope.time.startTime.toString() != $scope.time.endTime.toString()){
						let validTime = $scope.subHours(moment($scope.time.endTime).format('HH:mm'), moment($scope.time.startTime).format('HH:mm')).split(':');
						if(parseInt(validTime[1]) < 30 && parseInt(validTime[0]) == 0 && $scope.DailyUlb){
							$scope.msgOnError('Required time', 'Please select minimum half an hour');
							$scope.time.endTime = $scope.time.startTime;
							$scope.pickerStartTime =  moment($scope.time.startTime).format('HH:mm');
							$scope.pickerEndTime = $scope.pickerStartTime;
							$scope.pickerWeeklyStart.setDate($scope.time.endTime);
							$scope.pickerWeeklyEnd.setDate($scope.time.endTime);
							$scope.time.hoursWorked = $scope.subtractTime($scope.time.endTime, $scope.time.startTime);
							return;
						};
					};
				};

				if($scope.time.startTime.toString() != $scope.time.endTime.toString() ){
					/* adjust everyday  values */
					for(var i =0; i< $scope.hoursperday.length;i++){
						if($scope.hoursperday[i].Hours !=0 && $scope.hoursperday[i].Day !="Total"){
							$scope.hoursperday[i].startTime = $scope.time.startTime;
							$scope.hoursperday[i].endTime = $scope.time.endTime;
							$scope.hoursperday[i].Hours = $scope.subtractTime($scope.hoursperday[i].endTime , $scope.hoursperday[i].startTime);
						};
					};
					$scope.calcTotalHours();
				}else{
					/* adjust everyday  values */
					for(var i =0; i< $scope.hoursperday.length;i++){
						$scope.hoursperday[i].Hours =0;
						$scope.hoursperday[i].startTime = $scope.pickerWeeklyStart.date;
						$scope.hoursperday[i].endTime = $scope.pickerWeeklyEnd.date;
					};
				};
			};


			$scope.checkDuplicate = function(TYPE){
				/*Scan locally saved timesheets for a match*/

				var checkObject = {};
				checkObject.WEDate =  $scope.outputWEDate;
				if (TYPE == 'Daily'){
						checkObject.Job = $scope.jobcode.toLowerCase();
						checkObject.StartTime = moment($scope.time.startTime).format('HH:mm:ss');
						checkObject.FinishTime = moment($scope.time.endTime).format('HH:mm:ss');
						checkObject.ListDate =  moment($scope.selectDate).format('DD/MM/YYYY');
				}
				else {
					checkObject.Job = $scope.jobcode.toLowerCase();
					checkObject.StartTime = moment($scope.dayEntry.startTime).format('HH:mm:ss');
					checkObject.FinishTime = moment($scope.dayEntry.endTime).format('HH:mm:ss');
					checkObject.ListDate =  $scope.dayEntry.Date;
				};
				var hasJob = checkObject.Job ? true : false;
				for(var i=0; i<$scope.timesheets.length;i++){
					/*Check the STATE
					if ($scope.timesheets[i].STATE != "Submitting"){
						continue;
					}
					else {*/
						/*Check if the dates match
					if ($scope.timesheets[i].ListDate != checkObject.WEDate){
						continue;
					}
					else {*/
						/*Check the line items for a match on Job, Date and Start-Finish times */
						for(var j=0; j<$scope.timesheets[i].LineItems.length;j++){
							var LineItem = $scope.timesheets[i].LineItems[j];
							if(LineItem.STATE=="Rejected"){
								continue;
							};
							if(TYPE == 'Daily'){
								if(hasJob){
									if (LineItem.Job.toLowerCase() == checkObject.Job &&
									LineItem.ListDate == checkObject.ListDate &&
									LineItem.StartTime == checkObject.StartTime &&
									LineItem.FinishTime == checkObject.FinishTime && $scope.editTAG != LineItem.TAG){
									/*we found one*/
									return true;
									}
								}else{ /* if no job ignore field from duplicate search use only day and times*/
									if (LineItem.ListDate == checkObject.ListDate &&
										LineItem.StartTime == checkObject.StartTime &&
										LineItem.FinishTime == checkObject.FinishTime && $scope.editTAG != LineItem.TAG){
										/*we found one*/
										return true;
									}
								}
							}
							else if(TYPE == 'Weekly'){
								if(hasJob){
									if (LineItem.Job.toLowerCase() == checkObject.Job &&
									LineItem.ListDate == checkObject.ListDate &&
									LineItem.StartTime == checkObject.StartTime &&
									LineItem.FinishTime == checkObject.FinishTime && $scope.editTAG != LineItem.TAG){
									/*we found one*/
									return true;
									}
								}else{ /* if no job ignore field from duplicate search use only day and times*/
									if (LineItem.ListDate == checkObject.ListDate &&
										LineItem.StartTime == checkObject.StartTime &&
										LineItem.FinishTime == checkObject.FinishTime && $scope.editTAG != LineItem.TAG){
										/*we found one*/
										return true;
									}
								}
							};
						}
				};
				/*if we get here we didnt find any duplicates*/
				return false;
			};

			$scope.checkDuplicateOnSubmitOrSave = function(TYPE){
				try{
					/*Scan locally saved timesheets for a match*/
					var checkObject = {};
					checkObject.WEDate =  $scope.outputWEDate;
					if (TYPE == 'Daily'){
						checkObject.Job = $scope.jobcode.toLowerCase();
						checkObject.StartTime = moment($scope.time.startTime).format('HH:mm:ss');
						checkObject.FinishTime = moment($scope.time.endTime).format('HH:mm:ss');
						checkObject.ListDate = moment($scope.selectDate).format('DD/MM/YYYY');
						checkObject.TAG = $scope.editTAG;
						var hasJob = checkObject.Job ? true : false;
						for (var i = 0; i < $scope.timesheets.length; i++) {
							for (var j = 0; j < $scope.timesheets[i].LineItems.length; j++) {
								var LineItem = $scope.timesheets[i].LineItems[j];
								if(LineItem.STATE=="Rejected"){
									continue;
								};
								if (hasJob) {
									if (LineItem.Job.toLowerCase() == checkObject.Job &&
										LineItem.ListDate == checkObject.ListDate &&
										(LineItem.StartTime == checkObject.StartTime) &&
										(LineItem.FinishTime == checkObject.FinishTime) &&
										LineItem.TAG !== checkObject.TAG) {
										/*we found one*/
										$scope.msgOnError("Duplicate", "You already have a timesheet for the job, timing and day "+checkObject.ListDate);
										return true;
									};
								} else { /* if no job ignore field from duplicate search use only day and times*/
									if (LineItem.ListDate == checkObject.ListDate &&
										(LineItem.StartTime == checkObject.StartTime) &&
										(LineItem.FinishTime == checkObject.FinishTime) &&
										LineItem.TAG !== checkObject.TAG) {
										/*we found one*/
										$scope.msgOnError("Duplicate", "You already have a timesheet for the job, timing and day "+checkObject.ListDate);
										return true;
									};
								};
							};
						};
						/*if we get here we didnt find any duplicates*/
						return false;
					} else {
						checkObject.Job = $scope.jobcode.toLowerCase();
						checkObject.TAG = $scope.editTAG;
						/* If weekly do check for every day item against rest of timesheets, except self (same tag all weeklies) */
						for(const item in $scope.hoursperday){
							var dayEntry = $scope.hoursperday[item];
							checkObject.StartTime = moment( dayEntry.startTime).format('HH:mm:ss');
							checkObject.FinishTime = moment( dayEntry.endTime).format('HH:mm:ss');
							/*checkObject.ListDate = moment(dayEntry.Date).format("DD/MM/YYYY");*/
							checkObject.ListDate = dayEntry.Date;
							/* If entry is already saved then it will be string instead of date value, account for this */
							if(checkObject.StartTime == "Invalid date")checkObject.StartTime = dayEntry.startTime;
							if(checkObject.FinishTime == "Invalid date") checkObject.FinishTime = dayEntry.endTime;
							if(checkObject.ListDate == "Invalid date") checkObject.ListDate = dayEntry.Date;
							var hasJob = checkObject.Job ? true : false;
							for(var i=0; i<$scope.timesheets.length;i++){
								for(var j=0; j<$scope.timesheets[i].LineItems.length;j++){
									var LineItem = $scope.timesheets[i].LineItems[j];
									if(LineItem.STATE=="Rejected"){
										continue;
									};
									if(hasJob){
										if (LineItem.Job.toLowerCase() == checkObject.Job &&
											LineItem.ListDate == checkObject.ListDate &&
											(LineItem.StartTime == checkObject.StartTime) &&
											(LineItem.FinishTime == checkObject.FinishTime) &&
											LineItem.TAG !== checkObject.TAG){
											/*we found one*/
											$scope.msgOnError("Duplicate", "You already have a timesheet for the job, timing and day "+checkObject.ListDate);
											return true;
										};
									}else{ /* if no job ignore field from duplicate search use only day and times*/
										if (LineItem.ListDate == checkObject.ListDate &&
											(LineItem.StartTime == checkObject.StartTime) &&
											(LineItem.FinishTime == checkObject.FinishTime) &&
											LineItem.TAG !== checkObject.TAG){
											/*we found one*/
											$scope.msgOnError("Duplicate", "You already have a timesheet for the job, timing and day "+checkObject.ListDate);
											return true;
										};
									};
								};
							};
						};
						/*if we get here we didnt find any duplicates*/
						return false;
					};
				} catch(err) {
					console.log("Error in checkDuplicate => " + err.message);
				};
			};


			$scope.adjustDayTime = function () {


				/* set the values */
				var time = $scope.pickerDayStartTime.split(':');
				var startTime = moment($scope.dayEntry.Date, "DD/MM/YYYY").toDate();
				startTime.setHours(time[0]);
				startTime.setMinutes(time[1]);
				startTime.setSeconds(0);
				startTime.setMilliseconds(0);

				var time1 = $scope.pickerDayEndTime.split(':');
				var endTime = moment($scope.dayEntry.Date, "DD/MM/YYYY").toDate();
				endTime.setHours(time1[0]);
				endTime.setMinutes(time1[1]);
				endTime.setSeconds(0);
				endTime.setMilliseconds(0);
				$scope.dayEntry.startTime = $scope.pickerDayStart.setDate($scope.createDateObject($scope.dayEntry.Date, startTime)).date;
				$scope.dayEntry.endTime = $scope.pickerDayEnd.setDate($scope.createDateObject($scope.dayEntry.Date, endTime )).date;

				// $scope.dayEntry.startTime = $scope.pickerDayStart.date;
				// $scope.dayEntry.endTime = $scope.pickerDayEnd.date;

				if($scope.dayEntry.startTime.toString() == $scope.dayEntry.endTime.toString() ){
					$scope.dayEntry.Hours=0;
					return;
				};
				/*$scope.setTimeTexts();*/
				if ($scope.dayEntry.endTime != "" && $scope.dayEntry.startTime != "") {
					$scope.dayEntry.Hours = $scope.subtractTime($scope.dayEntry.endTime, $scope.dayEntry.startTime);
					
					if($scope.dayEntry.startTime.toString() != $scope.dayEntry.endTime.toString()){
						let validTime = $scope.subHours(moment($scope.dayEntry.endTime).format('HH:mm'), moment($scope.dayEntry.startTime).format('HH:mm')).split(':');
						if(parseInt(validTime[1]) < 30 && parseInt(validTime[0]) == 0 && $scope.DailyUlb){
							$scope.msgOnError('Required time', 'Please select minimum half an hour');
							$scope.dayEntry.endTime = $scope.dayEntry.startTime;
							$scope.pickerDayStartTime =  moment($scope.dayEntry.startTime).format('HH:mm');
							$scope.pickerDayEndTime = $scope.pickerDayStartTime;
							$scope.pickerDayStart.setDate($scope.dayEntry.endTime);
							$scope.pickerDayEnd.setDate($scope.dayEntry.endTime);
							$scope.dayEntry.Hours = $scope.subtractTime($scope.dayEntry.endTime, $scope.dayEntry.startTime);
							return;
						};
					};
				};

				// $scope.dayEntry.Hours = $scope.pickerDayStartTime;
				// console.log("Hours Entry ===>",$scope.dayEntry.Hours);

			};


			$scope.reduceOrAddHalfHour = function(hours){
				if(hours =="0.00"){
					return;
				};
				var hoursDiff = parseInt(hours.split(':')[0]);
				var minDiff = 0;
				var temp = hours.split(':')[1];
				if(temp !="00"){
					minDiff = parseInt(temp);
				};
			  
				var hoursDiffStr = "";
				var minDiffStr = "";
				if($scope.DailyUlb){
					if(minDiff >=30){
						minDiff = minDiff -30;
					}else{
						minDiff =  60- (30-minDiff);
						hoursDiff =hoursDiff -1;
					};
				}else{
					if(minDiff <30){
						minDiff = minDiff + 30;
					}else{
						minDiff =  minDiff-30;
						hoursDiff =hoursDiff + 1;
					};
				};
				if(hoursDiff <10){
					hoursDiffStr = "0" + hoursDiff;
				}else{
					hoursDiffStr =hoursDiff.toString();
				};
				if(minDiff <10){
					minDiffStr = "0" + minDiff;
				}else{
					minDiffStr = minDiff.toString();
				};
				return hoursDiffStr + ":" + minDiffStr;	

			};

			$scope.reduceHalfAnHour = ()=>{
				try{
					var hoursDiff = parseInt($scope.time.hoursWorked.split(':')[0]);
					var minDiff = 0;
					var temp = $scope.time.hoursWorked.split(':')[1];
					if(temp !="00"){
						minDiff = parseInt(temp);
					};
					
					var hoursDiffStr = "";
					var minDiffStr = "";
					if($scope.DailyUlb){
						if(minDiff >=30){
							minDiff = minDiff -30;
						}else{
							minDiff =  60- (30-minDiff);
							hoursDiff =hoursDiff -1;
						};
					}else{
						if(minDiff <30){
							minDiff = minDiff + 30;
						}else{
							minDiff =  minDiff-30;
							hoursDiff =hoursDiff + 1;
						};
					};
					if(hoursDiff <10){
						hoursDiffStr = "0" + hoursDiff;
					}else{
						hoursDiffStr =hoursDiff.toString();
					};
					if(minDiff <10){
						minDiffStr = "0" + minDiff;
					}else{
						minDiffStr = minDiff.toString();
					};
					$scope.time.hoursWorked = hoursDiffStr + ":" + minDiffStr;
				}
				catch(err){

				}
			};
			$scope.checkMail = function () {
				var _pos = $scope.email.indexOf("@", 0);
				if (_pos > -1) {
					$scope.email = $scope.email.substring(0, _pos);
				};
			};
			$scope.checkExMail = function () {
				if ($scope.externalemail == undefined) {
					$scope.msgOnError("External mail format issue", "external email seems to be of invalid format");
				}
				else {
					var _pos = $scope.externalemail.indexOf("@", 0);
					if (_pos == -1) {
						$scope.msgOnError("External mail format issue", "external email seems to be of invalid format");
					};
				};
			};

			$scope.subtractTime = function (time1, time2) {

				if(time1.toString() == time2.toString()){
					return "0.00";
				};

				if($scope.DailyUlb == true){

				var time1InMins = time1.getHours() * 60 + time1.getMinutes() - 30;
				var time2InMins = time2.getHours() * 60 + time2.getMinutes();

				if (time1InMins < time2InMins) {
					time1InMins += 1440;
				};

				var timeDifferenceHours = (parseInt((time1InMins - time2InMins) / 60)).toString();
				var timeDifferenceMinutes = ((time1InMins - time2InMins) % 60).toString();
				var timedifference = "";


				timeDifferenceHours = ("0" + timeDifferenceHours).slice(-2);
				timeDifferenceMinutes = ("0" + timeDifferenceMinutes).slice(-2);

				return timedifference = timeDifferenceHours + ":" + timeDifferenceMinutes;

				} else{
				var time1InMins = time1.getHours() * 60 + time1.getMinutes();
				var time2InMins = time2.getHours() * 60 + time2.getMinutes();

				if (time1InMins < time2InMins) {
					time1InMins += 1440;
				};

				var timeDifferenceHours = (parseInt((time1InMins - time2InMins) / 60)).toString();
				var timeDifferenceMinutes = ((time1InMins - time2InMins) % 60).toString();
				var timedifference = "";


				timeDifferenceHours = ("0" + timeDifferenceHours).slice(-2);
				timeDifferenceMinutes = ("0" + timeDifferenceMinutes).slice(-2);

				return timedifference = timeDifferenceHours + ":" + timeDifferenceMinutes;
				};
				
			};

			$scope.incrementCaptureTime = function () {

				$scope.calcTime();

				try {
					$scope.captureTimesheet.Quantity = parseFloat($scope.captureTimesheet.Quantity) + $scope.interval;

					$scope.captureTimesheet.sent = "";
				}
				catch (err) {

				};
			};
			$scope.decrementCaptureTime = function () {

				$scope.calcTime();
				try {

					$scope.captureTimesheet.Quantity = parseFloat($scope.captureTimesheet.Quantity) - $scope.interval;

					if ($scope.captureTimesheet.Quantity < 0) {
						$scope.captureTimesheet.Quantity = 0;
					};

					$scope.captureTimesheet.sent = "";
				}
				catch (err) {

				};
			};

			$scope.saveLocal = function (newtimesheet) {
				/*console.log("inside save local" +JSON.stringify(newtimesheet));*/
				try {
					var instr = {};
					instr.Instr = "Insert";
					instr.App = $scope.appName;
					instr.Object = $scope.LocalSyncObject;
					instr.Key = newtimesheet.TAG;
					instr.Data = newtimesheet;
				
					$scope.closepopup();
				
					instr = 'MiTokn' + JSON.stringify(instr);
					if ($scope.testdata != true) {
						var _frameprework = document.createElement('iframe');
						_frameprework.width = 0; _frameprework.height = 0; _frameprework.frameBorder = 0;
						document.body.appendChild(_frameprework);
						
						try {
                     		if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
                        		try { 
                      		        window.HtmlCommunicator.getDataFromHTML(instr); 
                        		} 
                        		catch (err) { 
                         		   console.log("$scope.concatlocal->" + err.message());
                        		};
                    		}else{
                        		_frameprework.src = instr;
                    		};
                		}
                		catch (err){
                    		console.log("windows hack " + err.message());
						};
						
						setTimeout(function () { document.body.removeChild(_frameprework); }, 500);
					};
				}
				catch (err) {
					console.log("Error in saveLocal =>"+ err.message);
				};

			};

			$scope.saveLocally_Jobs_WCs_ACs = function (data, key) {
				console.log("saveLocally_Jobs_WCs_ACs ",key,data);
				try {
					var instr = {};
					var Data = {};
					Data.data = data;
					instr.Instr = "Insert";
					instr.App = $scope.appName;
					instr.Object = key;
					instr.Key = key;
					instr.Data = Data;
				
				
					instr = 'MiTokn' + JSON.stringify(instr);
					if ($scope.testdata != true) {
						var _frameprework = document.createElement('iframe');
						_frameprework.width = 0; _frameprework.height = 0; _frameprework.frameBorder = 0;
						document.body.appendChild(_frameprework);
						
						try {
                     		if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
                        		try { 
                      		        window.HtmlCommunicator.getDataFromHTML(instr); 
                        		} 
                        		catch (err) { 
                         		   console.log("$scope.concatlocal->" + err.message());
                        		};
                    		}else{
                        		_frameprework.src = instr;
                    		};
                		}
                		catch (err){
                    		console.log("windows hack " + err.message());
						};
						
						setTimeout(function () { document.body.removeChild(_frameprework); }, 500);
					};
				}
				catch (err) {
					console.log("Error in saveLocal =>"+ err.message);
				};

			};

			$scope.saveSVEmailLocal = function (email) {
				try {
					var instr = {};
					instr.Instr = "Insert";
					instr.App = $scope.appName;
					instr.Object = "LocalTimesheetSVemail";
					instr.Key = new moment().format("YYYYMMDDTHHmmss");
					instr.Data = {};
					instr.Data.data =email;
					instr = 'MiTokn' + JSON.stringify(instr);
					if ($scope.testdata != true) {
						var _frameSV = document.createElement('iframe');
						_frameSV.width = 0; _frameSV.height = 0; _frameSV.frameBorder = 0;
						document.body.appendChild(_frameSV);
						
						try {
                     		if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
                        		try { 
                      		        window.HtmlCommunicator.getDataFromHTML(instr); 
                        		} 
                        		catch (err) { 
                         		   console.log("$scope.concatlocal->" + err.message());
                        		};
                    		}else{
                        		_frameSV.src = instr;
                    		};
                		}
                		catch (err){
                    		console.log("windows hack " + err.message());
						};
						
						setTimeout(function () { document.body.removeChild(_frameSV); }, 500);
					};
				}
				catch (err) {
					console.log("Error in saveSVEmailLocal =>"+ err.message);
				};
			};
			$scope.saveTimeSheetSync = function (newtimesheet) {
				try {
					var instr = {};
					instr.Instr = "Insert";
					instr.App = $scope.appName;
					instr.Object = "TimeSheetSync";
					instr.Key = newtimesheet.TAG;
					instr.Data = {};
					instr.Data.emailJSON=newtimesheet.SendEmailData.Data;
					instr.Data.SynchMessage=newtimesheet.SendEmailData.SynchMessage;
					instr.Data.Response = newtimesheet.SendEmailData.Response;
					instr.Data.TAG = newtimesheet.TAG;				
					
					instr = 'MiTokn' + JSON.stringify(instr);
					if ($scope.testdata != true) {
						var _frames1 = document.createElement('iframe');
						_frames1.width = 0; _frames1.height = 0; _frames1.frameBorder = 0;
						document.body.appendChild(_frames1);
						
						try {
                     		if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
                        		try { 
                      		        window.HtmlCommunicator.getDataFromHTML(instr); 
                        		} 
                        		catch (err) { 
                         		   console.log("$scope.concatlocal->" + err.message());
                        		};
                    		}else{
                        		_frames1.src = instr;
                    		};
                		}
                		catch (err){
                    		console.log("windows hack " + err.message());
						};

						setTimeout(function () { document.body.removeChild(_frames1); }, 500);
					};
				}
				catch (err) {
					console.log("Error in saveTimeSheetSync =>"+ err.message);
				};

			};
		
			$scope.deleteLocalTimeSheetSync = function (thisTAG) {
				try {
					var link = {};
					link.Instr = "Select";
					link.App = $scope.appName;
					link.Object = "LocalTimeSheets";
					var entry = {};
					entry.Query = "delete from tblJSONData ";
					entry.Query += "where  appName = ' "+ $scope.appName+"' " + " and objectName='TimeSheetSync'";
					entry.Query += " and key='" + thisTAG +"';";
					entry.FunctionOnReturn = "doNothingResponse";
					link.Data = [];
					link.Data.push(entry);
					link = "MiTokn" + JSON.stringify(link);

					if ($scope.testdata != true) {
						var _frameprework = document.createElement('iframe');
						_frameprework.width = 0; _frameprework.height = 0; _frameprework.frameBorder = 0;
						document.body.appendChild(_frameprework);
						try {
                     		if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
                        		try { 
                      		        window.HtmlCommunicator.getDataFromHTML(link); 
                        		} 
                        		catch (err) { 
                         		   console.log("$scope.concatlocal->" + err.message());
                        		};
                    		}else{
                        		_frameprework.src = link;
                    		};
                		}
                		catch (err){
                    		console.log("windows hack " + err.message());
            			};
						setTimeout(function () { document.body.removeChild(_frameprework); }, 500);
					};
				}
				catch (err) {
					$scope.msgOnError("System Alert", "Failed in fetching Timesheets from device");
				};
			};
			$scope.refreshTimesheetList = function () {
				$scope.loadingData=false;
              	
				setTimeout(function () { 
					$scope.loading=true;
                  	/*if connected =>get local data =>get data from gendatastore*/
					$scope.connectionCheck();
                  
                    setTimeout(function () { 
                        $scope.loading=false;
                      	
                      	setTimeout(function () { 
                          $scope.loadingData=true;
                          $scope.$apply();
                     	}, 10);	
                      
                    }, 1500);
                  
				}, 450);	
             
				
			};
			$scope.getGenDataTimesheets = function () {
				try {
					
                    var currentDate=new moment().format("YYYYMMDDTHHmmss");
                    var link = {};
                    link.Instr = "DataFetch";
                    link.App = $scope.appName;
                    link.Object = "GetTimesheetData";
                    link.Seq = "1";
                    link.FunctionOnReturn = "getTimesheetFromGen";

                    link.InsertOnReturn = "Y";
                    link = "MiTokn" + JSON.stringify(link);

                    /*$scope.log("Getting pre work data"+link);*/

                    var _frameGA = document.createElement('iframe');
                    _frameGA.width = 0; _frameGA.height = 0; _frameGA.frameBorder = 0;
                    document.body.appendChild(_frameGA);
                    try {
                        if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
                                window.HtmlCommunicator.getDataFromHTML(link); 
                        }else{
                            _frameGA.src = link;
                        };
                    }
                    catch (err){
                        $scope.log("windows changes for sync " + err.message());
                    };

                    setTimeout(function () { document.body.removeChild(_frameGA); }, 5000);
                }
                catch (err) {
                    console.log("Error getting timesheet from Tokn genDataStore data:"+err.message);
                };
			};
			/*$scope.getEmployeeDetails = function (employeeCode) {
				try {
					   
                    var link = {};
                    link.Instr = "DataFetch";
                    link.App = $scope.appName;
                    link.Object = "GetTheEmployee";
                    link.Seq = "1";
                    link.FunctionOnReturn = "setEmployees";
					link.URLAdd = "/"+ employeeCode;
                    link.InsertOnReturn = "Y";
                    link = "MiTokn" + JSON.stringify(link);

                    // $scope.log("Getting pre work data"+link);

                    var _frameGA = document.createElement('iframe');
                    _frameGA.width = 0; _frameGA.height = 0; _frameGA.frameBorder = 0;
                    document.body.appendChild(_frameGA);
                    try {
                        if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
                                window.HtmlCommunicator.getDataFromHTML(link); 
                        }else{
                            _frameGA.src = link;
                        };
                    }
                    catch (err){
                        $scope.log("windows changes for sync " + err.message());
                    };

                    setTimeout(function () { document.body.removeChild(_frameGA); }, 5000);
                }
                catch (err) {
                    console.log("Error getEmployeeDetails data:"+err.message);
                };
			};*/
			$scope.getLocalTimesheets = function () {
				try {
					var link = {};
					link.Instr = "Select";
					link.App = $scope.appName;
					link.Object = $scope.LocalSyncObject;
					var entry = {};
					entry.Query = "select * from tblJSONData ";
					entry.Query += "where  appName = '"+$scope.appName+"' " + " and objectName='"+$scope.LocalSyncObject+"'";
					entry.Query += " order by key; ";
					entry.FunctionOnReturn = "getLocalTimeSheets";
					link.Data = [];
					link.Data.push(entry);
					link = "MiTokn" + JSON.stringify(link);

					if ($scope.testdata != true) {
						var _frameprework = document.createElement('iframe');
						_frameprework.width = 0; _frameprework.height = 0; _frameprework.frameBorder = 0;
						document.body.appendChild(_frameprework);
						try {
                     		if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
                        		try { 
                      		        window.HtmlCommunicator.getDataFromHTML(link); 
                        		} 
                        		catch (err) { 
                         		   console.log("$scope.concatlocal->" + err.message());
                        		};
                    		}else{
                        		_frameprework.src = link;
                    		};
                		}
                		catch (err){
                    		console.log("windows hack " + err.message());
            			};
						setTimeout(function () { document.body.removeChild(_frameprework); }, 500);
					};
				}
				catch (err) {
					$scope.msgOnError("System Alert", "Failed in fetching Timesheets from device");
				};
			};

			$scope.getLocalData = function (key) {
				try {
					var link = {};
					link.Instr = "Select";
					link.App = $scope.appName;
					link.Object = key;
					var entry = {};
					entry.Query = "select * from tblJSONData ";
					entry.Query += "where  appName = '"+$scope.appName+"' " + " and objectName='"+key+"'";
					entry.Query += " order by key; ";
					entry.FunctionOnReturn = "setLocalData";
					link.Data = [];
					link.Data.push(entry);
					link = "MiTokn" + JSON.stringify(link);

					if ($scope.testdata != true) {
						var _frameprework = document.createElement('iframe');
						_frameprework.width = 0; _frameprework.height = 0; _frameprework.frameBorder = 0;
						document.body.appendChild(_frameprework);
						try {
                     		if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
                        		try { 
                      		        window.HtmlCommunicator.getDataFromHTML(link); 
                        		} 
                        		catch (err) { 
                         		   console.log("$scope.concatlocal->" + err.message());
                        		};
                    		}else{
                        		_frameprework.src = link;
                    		};
                		}
                		catch (err){
                    		console.log("windows hack " + err.message());
            			};
						setTimeout(function () { document.body.removeChild(_frameprework); }, 500);
					};
				}
				catch (err) {
					$scope.msgOnError("System Alert", "Failed in fetching Timesheets from device");
				};
			};

			$scope.setLocalDataWhenOffline = (data)=>{
				try{
					//JCEmployee
					try{
						if(data[0].key === 'JCEmployee' && data[0].data){
							console.log("JCEmployee ",data[0].data);
							$scope.user = data[0].data;
							$scope.empActivityCode = $scope.user.DefaultActivity;
							$scope.empActivityGroup = $scope.user.ActivityGroup;
							$scope.activityGroup = $scope.user.ActivityGroup;
						}
					}
					catch(err){
						console.log("error while getting JCEmployee data in setLocalDataWhenOffline ",err.message());
					}

					//UserActivityCodes
					try{
						if(data[0].key === 'UserActivityCodes' && data[0].data){
							console.log("UserActivityCodes ",data[0].data);
							$scope.Activities = data[0].data;
							$scope.Useractivitylist = data[0].data;
						}
					}
					catch(err){
						console.log("error while getting UserActivityCodes in setLocalDataWhenOffline ",err.message());
					}
	
					//UserDefaultWorkCentre
					try{
						if(data[0].key === 'UserDefaultWorkCentre' && data[0].data){
							console.log("UserDefaultWorkCentre ",data[0].data);
							$scope.UserDefaultWorkCentre = data[0].data;
							$scope.loadingInit = false;
						}
					}
					catch(err){
						console.log("error while getting UserDefaultWorkCentre in setLocalDataWhenOffline ",err.message());
					}

					// JCWorkCentres
					if(data[0].key === 'JCWorkCentres' && data[0].data){
						console.log("JCWorkCentres ",data[0].data);
						$scope.WCS = data[0].data;
						$scope.loadingInit = false;
					}

				}
				catch(err){
					console.log("error in function setLocalDataWhenOffline ",err.message());
				}

			};

			$scope.setLocalUserData = (data)=>{
				try{
					//JCEmployee
					try{
						if(data[0].key === 'JCEmployee' && data[0].data){
							console.log("JCEmployee ",data[0].data);
							$scope.user = data[0].data;
							$scope.empActivityCode = $scope.user.DefaultActivity;
							$scope.empActivityGroup = $scope.user.ActivityGroup;
							$scope.activityGroup = $scope.user.ActivityGroup;
						}
					}
					catch(err){
						console.log("error while getting JCEmployee data ",err.message());
					}

					//UserActivityCodes
					try{
						if(data[0].key === 'UserActivityCodes' && data[0].data){
							console.log("UserActivityCodes ",data[0].data);
							$scope.Activities = data[0].data;
							$scope.Useractivitylist = data[0].data;
						}
					}
					catch(err){
						console.log("error while getting UserActivityCodes ",err.message());
					}
	
					//UserDefaultWorkCentre
					try{
						if(data[0].key === 'UserDefaultWorkCentre' && data[0].data){
							console.log("UserDefaultWorkCentre ",data[0].data);
							$scope.UserDefaultWorkCentre = data[0].data;
						}
					}
					catch(err){
						console.log("error while getting UserDefaultWorkCentre ",err.message());
					}
				}
				catch(err){
					console.log("error in function setLocalUserData ",err.message());
				}

			};

			$scope.deleteDuplicateTimesheet = function (localtimesheetobj,timesheetobj) {
				console.log("inside duplicate check local timesheet", localtimesheetobj);
				console.log("inside duplicate check ",timesheetobj);
				try {
					for (var i = 0; i < timesheetobj.length; i++) {
						for(var j = 0; j < localtimesheetobj.length; j++){
							if(timesheetobj[i].TAG == localtimesheetobj[j].TAG){
								console.log("Gen data timesheet here ", timesheetobj[i].TAG);
								console.log("do i go in here ", localtimesheetobj[j].TAG);								
								$scope.deleteLineItemtoTimesheets(localtimesheetobj[j]);
								localtimesheetobj.splice(j, 1);
								
							};						
						};						
					};
					$scope.localTimeSheets = localtimesheetobj;
					console.log("local timesheet after duplicate check - ", $scope.localTimeSheets);

				} catch (err) {
					alert("Error in deleteDuplicateTimesheet");
				};
			};

			$scope.deleteLineItemtoTimesheets = function(thisTimeSheet){         
				try{
					console.log("going to delete item, ", thisTimeSheet);
					var link = {};
					link.Instr = "Delete";
					link.App = $scope.appName;
					link.Screen= $scope.screenName;	
					link.Object = $scope.LocalSyncObject;
					link.Key = 	thisTimeSheet.TAG;
					
					link = "MiTokn" + JSON.stringify(link);
					link = encodeURI(link);

					var _frameD = document.createElement('iframe');
					_frameD.width = 0; _frameD.height = 0; _frameD.frameBorder = 0;
					document.body.appendChild(_frameD);
					
					try {
						if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
								window.HtmlCommunicator.getDataFromHTML(link); 
						}else{
							_frameD.src = link;
						};
					}
					catch (err){
						$scope.log("windows changes for sync " + err.message());
					};
					setTimeout(function () { document.body.removeChild(_frameD); }, 5000);
				}catch(err){
					$scope.log("Error deleteDuplicateTimesheete from tblJSONData & tblsynch table ?=> "+ err.message);
				};	
			};

			$scope.addLocalTimesheets = function (timesheetobj) {
				try {
					for (var i = 0; i < timesheetobj.length; i++) {
						$scope.addLineItemtoTimesheets(timesheetobj[i]);
					};

				} catch (err) {
					alert("Error in addLocalTimesheets");
				};
			};

			$scope.fixWeekEndingDate = function () {
				try {
					var today = new Date();
					var date = $scope.selectDate;
					if((date.getDate()===today.getDate()) && (date.getMonth()===today.getMonth()) && (date.getFullYear()===today.getFullYear())){
						$scope.selectDate=$scope.thisWeekEndingDate;		
					};
					$scope.calcDatePerDay();
					$scope.outputWEDate=$scope.selectDate;
					$scope.rawOutputWEDate=$scope.selectDate;

				} catch (err) {
					console.log("Error in fixWeekEndingDate function",err);
				};
			};

			$scope.addPhotoNew = function(object) {
				
			try {
				if (typeof object === 'string' || object instanceof String) {
					var object = JSON.parse(object);
				};

				var obj = new Object();
				obj.fileName = object.fileName;

				var _check = '&' + object.fileName + '&';
				if (object.contents !== _check){
					if (object.fileName.indexOf(".jpg") > -1){
						try {
							/*console.log("Before:" +object.contents);*/
							obj.src = "data:image/jpeg;base64,"+ object.contents.replace(/\s/g, '+');
							/*console.log("after:" +object.contents.replace(/\s/g, "+"));*/
						}
						catch (err){
							alert(err.message);
						};
					};
					if (object.fileName.indexOf(".jpeg") > -1){
							try {
								obj.src = "data:image/jpeg;base64,"+ object.contents.replace(/\s/g, '+');
							}
							catch (err){
								alert(err.message);
							};
					};
					if (object.fileName.indexOf(".png") > -1){
						try {
							/*console.log("Before:" +object.contents);*/
							obj.src = "data:image/png;base64,"+ object.contents.replace(/\s/g,'+');
							/*console.log("after:" +object.contents.replace(/\s/g, "+"));*/
						}
						catch (err){
							alert(err.message);
						};
					};
					if($scope.addAttach){
						$scope.imageAttachments.push(obj);
						/*console.log(JSON.stringify(obj));*/
					};
					
					if ($scope.imageAttachments.length == $scope.maxAttachments){
						$scope.addAttach=false;
					};		
					
				};
			}
			catch (err){
				alert('addPhotoError:' + err.message);
			};
		};


			$scope.setExternalMail = function () {
				if ($scope.externalemail != "") {
					try {
						/* split the string by comma in case of multiple addresses */
						$scope.externalemail = $scope.externalemail.replace(/\s/g, '');
						$scope.externalemail = $scope.externalemail.replace(/[:;]/g, ',');
						
						var _recList = $scope.externalemail.split(",");
						/*_recList.push($scope.emailJSON.personalizations[0].to[0].email);*/
						var _uniqueItems = Array.from(new Set(_recList));
						/*$scope.emailJSON.personalizations[0].to[0].email = _uniqueItems[0];*/
						for (x = 0; x < _uniqueItems.length; x++) {
							var addto = {};
							addto.email = _uniqueItems[x];
							$scope.emailJSON.personalizations[0].to.push(addto);
						};
					}
					catch (err) {

					};
				};
			};

			$scope.removeDuplicateMailAddresses = function(myArray){
				
				var newArray = [];
			
				angular.forEach(myArray, function(value, key) {
					var exists = false;
					angular.forEach(newArray, function(val2, key) {
						if(angular.equals(value.email.toLowerCase(), val2.email.toLowerCase()))
						{ 
							exists = true;
						}; 
					});
					if(exists == false && value.email != "") 
					{ 
						newArray.push(value); 
					};
				});
				return newArray;
			};

			$scope.setUserMail = function (){
				try {
					var addto = {};
					addto.email = $scope.user.Address.Email;
					$scope.emailJSON.personalizations[0].to.push(addto);
				}
				catch (err){

				};
			};
			$scope.btnUploader = function () {
				var link = {};
				link.Instr = "Photo";
				link.Width = $scope.attachWidth;
				link.Height = $scope.attachHeight;
				link.object = "CreateTimesheet";
				link.Seq = "1";
				link.Quality = "100";
				link.FunctionOnReturn = "addPhoto";
				link = "MiTokn" + JSON.stringify(link);
				window.location = link;
			};
			
			$scope.getLogo = function(){
				var logBase64=$scope.getPropertyValue('LogoBase64', $scope.appName);
				return logBase64;

			};

			$scope.checkUserDetails = function(){
				try{
					/* when greentree user details are not found , try using tokn user details */
					if($scope.user.UsualName===undefined || $scope.user.UsualName==='' || $scope.user.Code===undefined || $scope.user.Code===''){
						$scope.user.UsualName=$scope.toknUser.name + " " + $scope.toknUser.surname;
						$scope.user.Code=$scope.toknUser.name + "." + $scope.toknUser.surname;
						$scope.user.Address={};
						$scope.user.Address.Email=$scope.toknUser.userID;
					};

				}catch(err){
					console.log("Error while checking user details =>" + err.message);
				};

				try{
					/*check again and if we still do not have data , use the user name from the client*/
					if($scope.user.UsualName===undefined || $scope.user.UsualName==='' || $scope.user.Code===undefined || $scope.user.Code===''){
						$scope.user.UsualName=$scope.deviceUser.user;
						$scope.user.Code=$scope.deviceUser.user.substring(0,$scope.deviceUser.user.indexOf('@'));
						$scope.user.Address={};
						$scope.user.Address.Email=$scope.deviceUser.user;
					};
				}catch(err){
					console.log("Error while checking user details again =>" + err.message);
				};

			};
			$scope.dropdown_expand = function (param) {
				$(param).parents('.dropdown').toggleClass('expand');
			};
			$scope.getDisbursementsACListByJob = function (jobACGroup) {
				try{
						if(jobACGroup===""){
							$scope.msgOnError('Timesheet', 'This job does not have any activity group assigned!');
							return;
						};

						var link = {};
						link.Instr = "DataFetch";
						link.App = $scope.appName;
						link.Screen = $scope.screenName;
						link.Object = "Demo-01-JCActivityDisbursement";
						link.Seq = "1";
						link.FunctionOnReturn = "setDisJobACList";
						link.URLAdd = "&group="+jobACGroup;
						link.InsertOnReturn = "Y";
						link = "MiTokn" + JSON.stringify(link);
		
						var _frameACD= document.createElement('iframe');
						_frameACD.width = 0; _frameACD.height = 0; _frameACD.frameBorder = 0;
						document.body.appendChild(_frameACD);
						try {
							if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
									window.HtmlCommunicator.getDataFromHTML(link); 
							}else{
								_frameACD.src = link;
							};
						}
						catch (err){
							$scope.log("windows changes for sync " + err.message());
						};

						setTimeout(function () { document.body.removeChild(_frameACD); }, 5000);
				}catch(err){
					$scope.log("getDisbursementsACListByJob:"+err.message);
				};
			};
			$scope.getNumOfSynchs = function(){
				try{
					$scope.syncCreated = false;
					var link = {};
					link.Instr = "Select";
					link.App = $scope.appName;
					link.Object = $scope.LocalSyncObject;
					var entry = {};
					entry.Query = "select method , synchMessage, date, status from tblSynch;";
					entry.FunctionOnReturn = "setSyncCreated";
					link.Data = [];
					link.Data.push(entry);
					link = "MiTokn" + JSON.stringify(link);
					link = encodeURI(link);

					if ($scope.testdata != true) {
						var _framesync = document.createElement('iframe');
						_framesync.width = 0; _framesync.height = 0; _framesync.frameBorder = 0;
						document.body.appendChild(_framesync);
						_framesync.src = link;
						setTimeout(function () { document.body.removeChild(_framesync); }, 500);
					};

				}catch(err){
					$scope.msgOnError("System Alert ", "Unable to create sync , Please send email to support@tokntechnology.com");
				};
				
			};
			$scope.getJobACGroup = function () {
				try{

					if($scope.jobname===undefined || $scope.jobname===""){
						$scope.msgOnError('Timesheet', 'Please enter job code to get activity lists!');
						return;
					};

					if($scope.user.ActivityGroup===undefined || $scope.user.ActivityGroup===""){
						$scope.msgOnError('Timesheet', 'Please check with Greentree Admin as you have no activity group assigned!');
						return;
					};
				
				

					var link = {};
					link.Instr = "DataFetch";
					link.App = $scope.appName;
					link.Screen = $scope.screenName;
					link.Object = "Demo-01-getJCJob";
					link.Seq = "1";
					link.FunctionOnReturn = "setJobACGroup";
					link.URLAdd = "/"+ $scope.jobname;
					link.InsertOnReturn = "Y";
					link = "MiTokn" + JSON.stringify(link);
					/*window.location = link;
					console.log("getting job=>"+link);*/

					var _frameJCJob = document.createElement('iframe');
                    _frameJCJob.width = 0; _frameJCJob.height = 0; _frameJCJob.frameBorder = 0;
                    document.body.appendChild(_frameJCJob);
                    try {
                        if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
                                window.HtmlCommunicator.getDataFromHTML(link); 
                        }else{
                            _frameJCJob.src = link;
                        };
                    }
                    catch (err){
                        $scope.log("windows changes for sync " + err.message());
                    };

                    setTimeout(function () { document.body.removeChild(_frameJCJob); }, 5000);
              				}catch(err){
					$scope.log("getActivityByJob:"+err.message);
				};

			};
			$scope.getACListByJob = function (jobACGroup) {
				try{
						if(jobACGroup===""){
							$scope.msgOnError('JCTimesheet', 'This job does not have any activity group assigned!');
							return;
						};

						var link = {};
						link.Instr = "DataFetch";
						link.App = $scope.appName;
						link.Screen = $scope.screenName;
						link.Object = "Demo-01-JCActivity";
						link.Seq = "1";
						link.FunctionOnReturn = "setJobACList";
						link.URLAdd = "&group="+jobACGroup.replace(" ","%20");
						link.InsertOnReturn = "Y";
						link = "MiTokn" + JSON.stringify(link);
				
						var _frameAC= document.createElement('iframe');
						_frameAC.width = 0; _frameAC.height = 0; _frameAC.frameBorder = 0;
						document.body.appendChild(_frameAC);
						try {
							if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
									window.HtmlCommunicator.getDataFromHTML(link); 
							}else{
								_frameAC.src = link;
							};
						}
						catch (err){
							$scope.log("windows changes for sync " + err.message());
						};

						setTimeout(function () { document.body.removeChild(_frameAC); }, 5000);
				}catch(err){
					$scope.log("getACListByJob:"+err.message);
				};
			};
			$scope.getActivityCodesForUserActivitygroup = function () {
				try{    
						if($scope.empActivityGroup===""){
							$scope.msgOnError('Timesheet', 'Please check on Greentree as you are not assigned an activity group!');
							return;
						};

						var link = {};
						link.Instr = "DataFetch";
						link.App = $scope.appName;
						link.Screen = $scope.screenName;
						link.Object = "Demo-01-JCActivity";
						link.Seq = "1";
						link.FunctionOnReturn = "setActivityGrp";
						link.URLAdd = "?group="+$scope.empActivityGroup;
						link.InsertOnReturn = "Y";
						link = "MiTokn" + JSON.stringify(link);
                        
						var _frameAC= document.createElement('iframe');
						_frameAC.width = 0; _frameAC.height = 0; _frameAC.frameBorder = 0;
						document.body.appendChild(_frameAC);
						try {
							if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
									window.HtmlCommunicator.getDataFromHTML(link); 
							}else{
								_frameAC.src = link;
							};
						}
						catch (err){
							$scope.log("windows changes for sync " + err.message());
						};

						setTimeout(function () { document.body.removeChild(_frameAC); }, 5000);
				}catch(err){
					$scope.log("getActivityCodesForUserActivitygroup:"+err.message);
				};
			};


			$scope.getActivityCodesForUser = function () {
				try{    
						if($scope.empActivityGroup===""){
							$scope.msgOnError('Timesheet', 'Please check on Greentree as you are not assigned an activity group!');
							return;
						};

						var link = {};
						link.Instr = "DataFetch";
						link.App = $scope.appName;
						link.Screen = $scope.screenName;
						link.Object = "Demo-01-JCActivity";
						link.Seq = "1";
						link.FunctionOnReturn = "setUserActivityGrp";
						link.URLAdd = "?group="+$scope.empActivityGroup.replace(/\s/g,'%20');
						link.InsertOnReturn = "Y";
						link = "MiTokn" + JSON.stringify(link);
                        
						var _frameAC= document.createElement('iframe');
						_frameAC.width = 0; _frameAC.height = 0; _frameAC.frameBorder = 0;
						document.body.appendChild(_frameAC);
						try {
							if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
									window.HtmlCommunicator.getDataFromHTML(link); 
							}else{
								_frameAC.src = link;
							};
						}
						catch (err){
							$scope.log("windows changes for sync " + err.message());
						};

						setTimeout(function () { document.body.removeChild(_frameAC); }, 5000);
				}catch(err){
					$scope.log("getActivityCodesForUser:"+err.message);
				};
			};

			$scope.getActivityCodesForJob = function () {
				try{    
						if($scope.selectedJobACGroup===""){
							$scope.msgOnError('Timesheet', 'Please check on Greentree as you are not assigned an activity group!');
							return;
						};

						var link = {};
						link.Instr = "DataFetch";
						link.App = $scope.appName;
						link.Screen = $scope.screenName;
						link.Object = "Demo-01-JCActivity";
						link.Seq = "1";
						link.FunctionOnReturn = "setJobACList";
						link.URLAdd = "?group="+$scope.selectedJobACGroup.replace(/\s/g,'%20');
						link.InsertOnReturn = "Y";
						link = "MiTokn" + JSON.stringify(link);
                        
						var _frameAC= document.createElement('iframe');
						_frameAC.width = 0; _frameAC.height = 0; _frameAC.frameBorder = 0;
						document.body.appendChild(_frameAC);
						try {
							if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
									window.HtmlCommunicator.getDataFromHTML(link); 
							}else{
								_frameAC.src = link;
							};
						}
						catch (err){
							$scope.log("windows changes for sync " + err.message());
						};

						setTimeout(function () { document.body.removeChild(_frameAC); }, 5000);
				}catch(err){
					$scope.log("getActivityCodesForJob:"+err.message);
				};
			};

			$scope.getUserDefaultWorkCentre = function () {
				try{    
						if($scope.empActivityCode===""){
							$scope.msgOnError('Timesheet', 'Please check on Greentree as you are not assigned  default activity code!');
							return;
						};

						var link = {};
						link.Instr = "DataFetch";
						link.App = $scope.appName;
						link.Screen = $scope.screenName;
						link.Object = "Demo-01-JCActivity";
						link.Seq = "1";
						link.FunctionOnReturn = "setUserDefaultWorkCentre";
						link.URLAdd = "/"+$scope.empActivityCode;
						link.InsertOnReturn = "Y";
						link = "MiTokn" + JSON.stringify(link);
                        
						var _frameAC= document.createElement('iframe');
						_frameAC.width = 0; _frameAC.height = 0; _frameAC.frameBorder = 0;
						document.body.appendChild(_frameAC);
						try {
							if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
									window.HtmlCommunicator.getDataFromHTML(link); 
							}else{
								_frameAC.src = link;
							};
						}
						catch (err){
							$scope.log("windows changes for sync " + err.message());
						};

						setTimeout(function () { document.body.removeChild(_frameAC); }, 5000);
				}catch(err){
					$scope.log("getUserDefaultWorkCentre:"+err.message);
				};
			};

			if ($scope.testdata == true) {
				data = [];
				$scope.setTimeSheets(data);
			};

					
			$scope.twoDecRex = function(param){                
                $scope.travelHr = param.replace(/[^a-zA-Z0-9. ]/g, '');
			};
			$scope.regex = function(param){
                if($scope.travelKm == undefined){
					$scope.travelKm = 0;
				};
               
			};
			$scope.allowTwoDigit = function(id){
				
				var input = angular.element( document.querySelector( '#' +id ) );
				var oldVal = input.val();
				var regex = new RegExp(input.attr('pattern'), 'g');

				setTimeout(function(){
					var newVal = input.val();
					if(!regex.test(newVal)){
					input.val(parseFloat(oldVal)); 
					}
				}, 100);
			};
			$scope.allowTwoDigitWeekly = function(id, index){
				
				var input = angular.element( document.querySelector( '#' +id ) );
				var oldVal = input.val();
				var regex = new RegExp(input.attr('pattern'), 'g');

				setTimeout(function(){
					var newVal = input.val();
					if(!regex.test(newVal)){
						input.val(oldVal); 
						if(id =="WeeklyTravelHr"){
							$scope.perDayTravelHr[index] = parseFloat(oldVal);
						};
						if(id =="WeeklyTravelKm"){
							$scope.perDayTravelKm[index] = parseFloat(oldVal);
						};
					}
				}, 100);
			};

			$scope.clearTravelData = function(){				
			};
			$scope.checkSignature = function(){
				if ((typeof ($scope.signature) != 'undefined') && ($scope.signature != "")) {				
					$scope.lockDaily =true;			
					$scope.lockWeekly =true;
					$scope.showSignatureNote =true;		
					$scope.lockDate =true;
					$scope.externalLock =false;			
				}else{
					$scope.lockDaily =false;			
					$scope.lockWeekly =false;
					$scope.showSignatureNote =false;	
					$scope.lockDate =false;
					$scope.externalLock =false;	
				};
			};
			$scope.saveFailedMsgLocal = function(TAG, message){
         
				try{

					var instr = {};
					instr.Instr = "Insert";
					instr.App = $scope.appName;
					instr.Object = "FailedMessage";
					instr.Key = TAG;
					instr.Data = {};
					instr.Data.data =message;
					/*instr.FunctionOnReturn = "saveFailedMsgLocalResponse";*/
					instr = 'MiTokn' + JSON.stringify(instr);

					/* Rum MITOkn call in iframe in order to navigate around loading issue */
					var _frameSF = document.createElement('iframe');
					_frameSF.width = 0; _frameSF.height = 0; _frameSF.frameBorder = 0;
					document.body.appendChild(_frameSF);
					
					try {
						if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
								window.HtmlCommunicator.getDataFromHTML(instr); 
						}else{
							_frameSF.src = instr;
						};
					}
					catch (err){
						$scope.log("windows changes for sync " + err.message());
					};
					setTimeout(function () { document.body.removeChild(_frameSF); }, 5000);


				}catch(err){
					$scope.log("Error saving failed message from tblsynch table ?=> "+ err.message);
				};
			
			
			};
			$scope.deleteFailedMsg = function(TAG){
         
				try{
					var link = {};
					link.Instr = "Select";
					link.App = $scope.appName;
					link.Screen= $scope.screenName;			
					link.Seq = "1";
					link.Data = [];
					var entry = {};
					entry.Query= "delete from tblSynch where index1='" + TAG  + "' and method ='SendTimesheetToTokn' and status=='3';";				
					entry.FunctionOnReturn = "DeleteFailedMsgReturn";
					entry.InsertOnReturn = "Y";

					link.Data.push(entry);

					link = "MiTokn" + JSON.stringify(link);

					link = encodeURI(link);

					console.log(JSON.stringify(link));

					/* Rum MITOkn call in iframe in order to navigate around loading issue */
					var _frameF = document.createElement('iframe');
					_frameF.width = 0; _frameF.height = 0; _frameF.frameBorder = 0;
					document.body.appendChild(_frameF);
					
					try {
						if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
								window.HtmlCommunicator.getDataFromHTML(link); 
						}else{
							_frameF.src = link;
						};
					}
					catch (err){
						$scope.log("windows changes for sync " + err.message());
					};
					setTimeout(function () { document.body.removeChild(_frameF); }, 5000);


				}catch(err){
					$scope.log("Error deleting failed message from tblsynch table ?=> "+ err.message);
				};
			
			
			};
			$scope.deleteSyncChain= function(TAG){
         
			try{
				var link = {};
				link.Instr = "Select";
				link.App = $scope.appName;
				link.Screen= $scope.screenName;			
				link.Seq = "1";
				link.Data = [];
				var entry = {};
				entry.Query= "delete from tblSynch where index1='" + TAG  + "' and method ='SendEmail' and status ='1';";				
				entry.FunctionOnReturn = "DeleteSyncChainReturn";
				entry.InsertOnReturn = "Y";

				link.Data.push(entry);

				link = "MiTokn" + JSON.stringify(link);

				link = encodeURI(link);

				console.log(JSON.stringify(link));

				/* Rum MITOkn call in iframe in order to navigate around loading issue */
				var _frameSC = document.createElement('iframe');
				_frameSC.width = 0; _frameSC.height = 0; _frameSC.frameBorder = 0;
				document.body.appendChild(_frameSC);
				
				try {
					if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
							window.HtmlCommunicator.getDataFromHTML(link); 
					}else{
						_frameSC.src = link;
					};
				}
				catch (err){
					$scope.log("windows changes for sync " + err.message());
				};
				setTimeout(function () { document.body.removeChild(_frameSC); }, 5000);


			}catch(err){
				$scope.log("Error deleting failed message from tblsynch table ?=> "+ err.message);
			};
		
		
		};
            $scope.fetchFailedMsg = function(index){
         
                    try{
                    var link = {};
                    link.Instr = "Select";
                    link.App = $scope.appName;
                    link.Screen= $scope.screenName;
                    /*link.Medthod = "SendTimesheetToTokn"; */
                    link.Seq = "1";
                    link.Data = [];
                    var entry = {};
                    entry.Query = "select * from tblSynch where status = 3 and index1 = '" + index +"'";
                    entry.FunctionOnReturn = "SetFailedMsg";
                    entry.InsertOnReturn = "Y";

                    link.Data.push(entry);

                    link = "MiTokn" + JSON.stringify(link);

                    link = encodeURI(link);    

                    /* Run MITOkn call in iframe in order to navigate around loading issue */
                    var _frameEMP = document.createElement('iframe');
                    _frameEMP.width = 0; _frameEMP.height = 0; _frameEMP.frameBorder = 0;
                    document.body.appendChild(_frameEMP);
                    
                    try {
                        if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
                                window.HtmlCommunicator.getDataFromHTML(link); 
                        }else{
                            _frameEMP.src = link;
                        };
                    }
                    catch (err){
                        $scope.log("windows changes for sync " + err.message());
                    };
                    setTimeout(function () { document.body.removeChild(_frameEMP); }, 5000);


                }catch(err){
                    $scope.log("Error fetching failed message from tblsynch table ?=> "+ err.message);
                };
            
              
			};
		
			$scope.addPlantLineItem = ()=>{
				var entry = {};
				entry.PlantJob = "";
				entry.ActivityCode = "";
				entry.WorkCentre = "";
				entry.Quantity="";
				entry.StandardText = "";
				$scope.newPlantLineItems.push(entry);
			};
			$scope.removeNewPlantLineItem = function(index){   
				$scope.newPlantLineItems.splice(index,1);
			};

			$scope.addLineItem = function(){   

				var entry = {};
				entry.ActivityCode = "";
				entry.WorkCentre = "";
				entry.Quantity="";
				entry.StandardText = "";
				$scope.newLineItems.push(entry);

			};
			$scope.removeNewLineItem = function(index){   
				$scope.newLineItems.splice(index,1);
			};

			/* CHECK TO SEE IF CLIENT IS ONLINE  ========================= */
            $scope.connectionCheck = function(){

				var link = {};

				link.Instr = "connectionstatus"; 
				link.FunctionOnReturn = "connectSTAT";

				link = "MiTokn" + JSON.stringify(link); 
				link = encodeURI(link);
				console.log(link);

				var _frameCONNECT = document.createElement('iframe');
				_frameCONNECT.width = 0; _frameCONNECT.height = 0; _frameCONNECT.frameBorder = 0;
				document.body.appendChild(_frameCONNECT);

				try {
						if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
								window.HtmlCommunicator.getDataFromHTML(link); 
						}else{
							_frameCONNECT.src = link;
						};
				}
				catch (err){
					$scope.log("windows changes for sync " + err.message());
				};
				setTimeout(function () { document.body.removeChild(_frameCONNECT); }, 5000);

			};

			$scope.setScopeListManager = function (data) {
				$scope.ListManagers = [];
				if(data!==undefined && data.length>0){
					
					/*decode the data blob*/
					for(var x=0; x<data.length ;x++){	
						var temp =base64.decode(data[x].data);
						var listManager = JSON.parse(temp);
						$scope.ListManagers=listManager.listItem;                         
					};
				};
				
			};

			$scope.updateUserNameList = function(){   
                $scope.selectedUserNameList=[];
                for(var m =0 ; m< $scope.selectedUserList.length; m++){
                    $scope.selectedUserNameList.push($scope.selectedUserList[m].name +" "+$scope.selectedUserList[m].surname);
                };
            };

			$scope.checkToknUser = function (userID){
                var index =0;
                /*do not use index here, because it changes when searching*/
                for(var a=0; a<$scope.AllUserList.length;a++){
                    if($scope.AllUserList[a].userID == userID){
                        index = a;
                    };
                };

			
                if(!$scope.AllUserList[index].check){
                    $scope.AllUserList[index].totalHours = $scope.time.hoursWorked;
                    $scope.selectedUserList.push($scope.AllUserList[index]);
                    $scope.updateUserNameList();
                    // $scope.getEmployeeDetails($scope.AllUserList[index].Code);

                }else{
                    for(var m=0; m<$scope.selectedUserList.length;m++){
                        if($scope.selectedUserList[m].userID == $scope.AllUserList[index].userID){
                            $scope.selectedUserList.splice(m,1);
                        };
                    };
                    
                    $scope.updateUserNameList();
                };
            };


			$scope.navBack = function(option) {
             
				var link = {};
				link.Instr = "closescreen";
			
				link = "MiTokn" + JSON.stringify(link);
				link = encodeURI(link);
				console.log(link);
				
				var _frame1 = document.createElement('iframe');
				_frame1.width = 0; _frame1.height = 0; _frame1.frameBorder = 0;
				document.body.appendChild(_frame1);
				
				try {
					if (window.location.protocol == "ms-local-stream:" || window.location.protocol == "ms-appx-web:") {
							window.HtmlCommunicator.getDataFromHTML(link); 
					}else{
						_frame1.src = link;
					};
				}
				catch (err){
					$scope.log("windows changes for sync " + err.message());
				};
				setTimeout(function () { document.body.removeChild(_frame1); }, 300);
				
			};


			$scope.chkForTravelKM = function(param , submit){
				askForTravelKM(param , submit);
			};

		}]);

		app.directive('readonly',function(){
			return {
				restrict: 'EAC',
				link: function(scope, elem, attr) {
				document.querySelectorAll("#datePicker input")[0].setAttribute("readonly","readonly");
				angular.element(".md-datepicker-button").each(function(){
						var el = this;
						var ip = angular.element(el).parent().find("input").bind('click', function(e){
							angular.element(el).click();
						});
						angular.element(this).css('visibility', 'hidden');
					});
				}
			}
			
		});

		/*app.config(function($mdDateLocaleProvider) {
  			$mdDateLocaleProvider.firstDayOfWeek = 1;
		});*/

		app.config(function ($mdDateLocaleProvider) {
			$mdDateLocaleProvider.formatDate = function (date) {
				return get_weekday_mm_dd_yyyy(date);

			};
		});

		window.onerror = function (msg, url, lineNo, columnNo, error) {
			var string = msg.toLowerCase();
			var substring = "script error";
			if (string.indexOf(substring) > -1) {

			} else {
				var message = [
					'Message: ' + msg,
					'URL: ' + url,
					'Line: ' + lineNo,
					'Column: ' + columnNo,
					'Error object: ' + JSON.stringify(error)
				].join(' - ');
			};
			return;
		};

		function askForTravelKM(param , submit) {
			try {

				iziToast.question({
				timeout: 0,
				close: false,
				overlay: true,
				displayMode: 'once',
				id: 'question',
				zindex: 999,
				title: '',
				message: "Have you used any oil or travelled any KM?s on this job? If yes, please add those items to the timesheet.",
				position: 'center',
				buttons: [
					['<button><b>YES</b></button>', function (instance, toast) {
						var initscope = angular.element(document.getElementById("APPID")).scope();
						initscope.$apply(function () {
							initscope.chkforKMS = true;
						});
						instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
					}],
					['<button>NO</button>', function (instance, toast) {
						var initscope = angular.element(document.getElementById("APPID")).scope();
						initscope.$apply(function () {
							initscope.createTimesheet(param, submit);
						});
						instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');

						
					}],
				],
				onClosing: function(instance, toast, closedBy){
					console.info('Closing | closedBy: ' + closedBy);
				},
				onClosed: function(instance, toast, closedBy){
					console.info('Closed | closedBy: ' + closedBy);
				}
				});

			} catch (err) {
					alert("izitoast err: " + err.message);
				};
		};

		function connectSTAT(data) {
            try {
                if (typeof data === 'string' || data instanceof String) {
                    var data = JSON.parse(data);
                };
                var initscope = angular.element(document.getElementById("APPID")).scope();
                initscope.$apply(function () {
					initscope.connectionStatus = data.Connected ;
					if(data.Connected =="TRUE"){
						initscope.getLocalTimesheets();
					}else{
						initscope.loading=false;
					};            
                });
            }
            catch (err) {

            };
        };

		function getStatusOfAppOnlineorOffline(data) {
            try {
                if (typeof data === 'string' || data instanceof String) {
                    var data = JSON.parse(data);
                };
                var initscope = angular.element(document.getElementById("APPID")).scope();
                initscope.$apply(function () {
					initscope.connectionStatus = data.Connected;
					if(initscope.connectionStatus == 'FALSE'){
						// $scope.msgOnErrorConn("Your Offline","Please connect to Online");
						// return;
						initscope.getLocalData('JCEmployee');
						initscope.getLocalData('UserActivityCodes');
						initscope.getLocalData('UserDefaultWorkCentre');
					}
                });
            }
            catch(err) {
				console.log("getStatusOfAppOnlineorOffline " + err.message);
            };
        };
		
		function injectTimesheet(data) {
			console.log("injectTimesheet ",data);
			try {
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					initscope.setTimeSheets(data);				
				});

			}
			catch (err) {
				console.log("injectTimesheetError:" + err.message);
			};
		};

		function injectFailedSync(data) {

		try {

			if (typeof data === 'string' || data instanceof String) {
				var data = JSON.parse(data);
			};
			var initscope = angular.element(document.getElementById("APPID")).scope();
			initscope.$apply(function () {
				initscope.failedTimeSheets = data;
			});
		}
		catch (err) {

		};

		};



		function injectFailedMsg(data) {
			try {
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					for(var x =0; x<data.length;x++){
						var failedMsg ={};
						failedMsg.key = data[x].key;
						failedMsg.data = data[x].data;	
						initscope.failedMessageList.push(failedMsg);
					};					
				});

			}
			catch (err) {
				
			};
		};
		function getTimesheetFromGen(data) {
			try {
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					if(data!==undefined && data.length>0){
						initscope.setTimeSheets(data);
					}else{
						initscope.loading=false;
					};		
				});
			}
			catch (err) {
				
			};
		};

		function GetSitesData(data){
			try{
				console.log("sites data ",data);
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					initscope.SitesList = JSON.parse(base64.decode(data[0].data)).listItem;
					console.log("sites list data ",initscope.SitesList);
				});
			}
			catch(err){
				console.log("error occured at GetSitesData function ",err);
			}
		};

		function setToknUserList(data) {
			try {
				console.log("setToknUserList ",data);
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					try{
						initscope.AllUserList = data;
						initscope.ToknUserList= [];							
						if(initscope.toknUser!=undefined && initscope.toknUser.name!=undefined && initscope.toknUser.name =='Universal' ){
							var uniGroup  =  "";
							for(x=0; x<initscope.toknUser.groups.length;x++){
								if(initscope.toknUser.groups[x].company == initscope.company){
									uniGroup  =  initscope.toknUser.groups[x].groupName;
								};
							};
							for(var a=0; a<initscope.AllUserList.length;a++){
								if(initscope.AllUserList[a].groups!=undefined){
									for(var b =0; b<initscope.AllUserList[a].groups.length; b++){
										if(initscope.AllUserList[a].groups[b].groupName == uniGroup && initscope.AllUserList[a].name != 'Universal'
											&& initscope.AllUserList[a].groups[b].company ==initscope.company ){
											initscope.ToknUserList.push(initscope.AllUserList[a]);
										};
									};
								};
							};
							/*console.log("------initscope.ToknUserList------"+JSON.stringify(initscope.ToknUserList));*/
						};
					}catch(err){
						console.log("Error in setToknUserList at =>" + err.message);
					};
				});
			}
			catch (err) {
				console.log(err.message);
			};
		};
		

		function setJobManager(data){
			try{
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					if(data && data[0]){
						initscope.jobManagerUsualName = data[0].Employee.UsualName;
					};
				});
			}
			catch(error){
				console.log("Error in getHRPersonResponse function")
			}
		};

		function chkSyncResponse(data) {
			if (typeof data === 'string' || data instanceof String) {
				var data = JSON.parse(data);
			};
			var scope = angular.element(document.getElementById("APPID")).scope();
			scope.$apply(function () {
		
			});
		};
		function chkPostGenDataResponse(data) {
			console.log("inside chkPostGenDataResponse");
			if (typeof data === 'string' || data instanceof String) {
				var data = JSON.parse(data);
			};
			var scope = angular.element(document.getElementById("APPID")).scope();
			scope.$apply(function () {
				if(data.Result === true){					
					for (var x = 0; x < scope.timesheets.length; x++) {
						for (var y = 0; y < scope.timesheets[x].LineItems.length; y++) {
							if(scope.timesheets[x].LineItems[y].TAG === data.SynchKey){
								scope.timesheets[x].LineItems[y].STATE = "Submitting";
							};
						};
					};
				};
			});
		};

		function getUserResponse(data) {
			if (typeof data === 'string' || data instanceof String) {
				var data = JSON.parse(data);
			};
			var scope = angular.element(document.getElementById("APPID")).scope();
			scope.$apply(function () {
				scope.deviceUser=data;
				scope.checkUserDetails();
			});
		};

		function injectFailedSync(data) {

			try {

				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					initscope.failedTimeSheets = data;
				});
			}
			catch (err) {

			};

		};

		function doNothingResponse() {
			var scope = angular.element(document.getElementById("APPID")).scope();
			scope.$apply(function () {
			});
		};

		function injectLocalTimeSheets(data) {

			try {
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					initscope.setLocalTimesheets(data);
					
				});
			}
			catch (err) {
				console.log("Error in injectLocalTimeSheets: " + err.message);
			};
		};
		function getLocalTimeSheets(data) {

			try {
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					initscope.setLocalTimesheets(data);
					initscope.exeDataRefresh("GetTimesheetData", "injectTimesheet");
					// initscope.getGenDataTimesheets();
				});
			}
			catch (err) {

			};
		};
		function setLocalData(data) {
			console.log("setLocalData ",data);
			try {
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					if(initscope.connectionStatus == "FALSE"){
						initscope.setLocalDataWhenOffline(data);
					}
				});
			}
			catch (err) {
				console.log("Error in getLocalTimeSheets: " + err.message);
			};
		};


		
		function setSyncCreated(data) {

			try {
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					/*console.log("data in setSyncCreated is" + JSON.stringify(data) );*/
					console.log("data in setSyncCreated syncMethodText is" );
					try{

					}catch(err){
						console.log("Error in setSyncCreated " + err.message);
					};

					

				});
			}
			catch (err) {

			};
		};
		function checkWeekExist(data) {

			try {
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					
					if(data[0].Error!=undefined && data[0].Error.StatusCode =="404"){
						/*Timesheet for weekending date not found, submit new one*/
						initscope.submitDisbTimeSheet(initscope.postTimesheetEntry, initscope.newLineItems,false);
					}else if(data[0].JCTimesheet!=undefined){
						/*Update existing timesheet*/
						initscope.submitDisbTimeSheet(initscope.postTimesheetEntry, initscope.newLineItems,true);
					};
				});
			}
			catch (err) { 

			};
		};

		function setEmployees(data) {
				console.log("Employee data =>",data);
			try {
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					initscope.setUser(data);
					
				});
			}
			catch (err) {

			};
		};

		function setUserList(data) {

			try {
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					initscope.ToknUserList =data;

				});
			}
			catch (err) {

			};
		};
		
		function setEmployeeDetails(data) {

			try {
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					
					initscope.selectedActivity.Code= data[0].Employee.DefaultActivity;
				});
			}
			catch (err) {

			};
		};

		function setToknUser(data) {
			try {
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					try{
						initscope.toknUser = data[0];
					}catch(err){
						console.log("Error in setEmployee at =>" + err.message);
					};
				});
			}
			catch (err) {

			};
		};
			

		function OkMessage() {

			try {
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					initscope.OkMessage();

				});
			}
			catch (err) {

			};
		};


		function deleteMessage() {

			try {
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					initscope.msgOnSuccess("TimeSheet", "TimeSheet Deleted");
					initscope.updateListStatus();

				});
			}
			catch (err) {

			};
		};


		function addpref(input) {
			try {
				if (input.length < 2) {
					input = "0".concat(input);
				};
				return input;
			}
			catch (err){
				return input;
			};
		};
		function getmm_dd_yyyy(dat) {

			try {
				var day = addpref(dat.getDate().toString());
				var month = addpref((dat.getMonth() + 1).toString());

				return day + "/" + month + "/" + dat.getFullYear();
			}
			catch (err) {

			}
		};
		function get_weekday_mm_dd_yyyy(dat) {

			try {
				var day = addpref(dat.getDate().toString());
				var month = addpref((dat.getMonth() + 1).toString());
				var weekOftheDate =getDayOftheWeek(dat.getDay());

				return weekOftheDate +" "+ day + "/" + month + "/" + dat.getFullYear();
			}
			catch (err) {
				console.log("Error changing date format");
			};
		};
		function getDayOftheWeek(datNo) {
		
			var days = ["Sun","Mon", "Tue", "Wed", "Thurs", "Fri", "Sat" ];
			return days[datNo];
		};

		function windowEdit() {
			$('.edit-wrap').toggleClass('active');
		};
		function windowCreate() {
			$('.create-wrap').toggleClass('active');
		};

		function w3_open() {
			document.getElementById("mySidebar").style.display = "block";
		};

		function menuToogle() {
			$('.off-canvas').toggleClass('open');
			$('body').toggleClass('expand');
			$('.hm-btn').toggleClass('open');
		};

		function w3_close() {
			$('.off-canvas').toggleClass('open');
			$('body').toggleClass('expand');
			$('.hm-btn').toggleClass('open');
		};

		function dd_expand(param) {
			$(param).parents('.dropdown').toggleClass('expand');
		};
		function dd_expand(param) {
			$(param).parents('.dropdown').toggleClass('expand');
		};

		function setListManager(data) {

			try {
				
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {	
					initscope.setScopeListManager(data);
				});
			}
			catch (err) {

			};
		};
		function injectJob(data) {
			try {
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					initscope.setJobs(data);

				});
			}
			catch (err) {

			};

		};

		function SyncOK(data){
			if (typeof data === 'string' || data instanceof String) {
				var data = JSON.parse(data);
			};
			var scope = angular.element(document.getElementById("APPID")).scope();
			scope.$apply(function () {
				/*if(data.Result === true){
					for (var x = 0; x < scope.timesheets.length; x++) {
						for (var y = 0; y < scope.timesheets[x].LineItems.length; y++) {
							if(scope.timesheets[x].LineItems[y].TAG === data.SynchKey){
								scope.timesheets[x].LineItems[y].STATE = "EMailed";
							};
						};
					};
					setTimeout(function () { scope.deleteLocalTimeSheetSync(data.SynchKey); }, 500);
					
				};*/
			});
		};

		function SyncFail(data){
			if (typeof data === 'string' || data instanceof String) {
				var data = JSON.parse(data);
			};
			var scope = angular.element(document.getElementById("APPID")).scope();
			scope.$apply(function () {
				/*if(data.Result === false){
					for (var x = 0; x < scope.timesheets.length; x++) {
						for (var y = 0; y < scope.timesheets[x].LineItems.length; y++) {
							if(scope.timesheets[x].LineItems[y].TAG === data.SynchKey){
								scope.timesheets[x].LineItems[y].STATE = "EMail Failed";
							};
						};
					};
				};*/
			});
		};
		function PostGenDataOK(data){
			if (typeof data === 'string' || data instanceof String) {
				var data = JSON.parse(data);
			};
			var scope = angular.element(document.getElementById("APPID")).scope();
			scope.$apply(function () {
				if(data.Result === true){
			
				
					for (var x = 0; x < scope.timesheets.length; x++) {
						for (var y = 0; y < scope.timesheets[x].LineItems.length; y++) {
							if(scope.timesheets[x].LineItems[y].TAG === data.SynchKey){
								scope.timesheets[x].LineItems[y].STATE = "Submitted";
								
							};
						};
					};
					scope.updateListStatus();
					setTimeout(function () { scope.deleteLocalTimeSheetSync(data.SynchKey); }, 500);
					
				};
			});
		};
		function PostJobOK(data){
			if (typeof data === 'string' || data instanceof String) {
				var data = JSON.parse(data);
			};
			var scope = angular.element(document.getElementById("APPID")).scope();
			scope.$apply(function () {
				if(data.Result === true){
					scope.loadingJob = true;
					scope.getAllJCJobs();
					
				};
			});
		};
		function PostGenDataFail(data){
			/*console.log("PostGenDataFail ",data);*/
			if (typeof data === 'string' || data instanceof String) {
				var data = JSON.parse(data);
			};
			var scope = angular.element(document.getElementById("APPID")).scope();
			scope.$apply(function () {				
				scope.fetchFailedMsg(data.SynchKey);
				/*scope.deleteSyncChain(data.SynchKey);*/
				for (var x = 0; x < scope.timesheets.length; x++) {
					for (var y = 0; y < scope.timesheets[x].LineItems.length; y++) {
						if(scope.timesheets[x].LineItems[y].TAG === data.SynchKey){
							scope.timesheets[x].LineItems[y].STATE = "Failed";
						};
					};
				};
				scope.updateListStatus();
			});
		};
		function SetFailedMsg(data){
			/*console.log("SetFailedMsg ",data);*/
			if (typeof data === 'string' || data instanceof String) {
				var data = JSON.parse(data);
			};
			var scope = angular.element(document.getElementById("APPID")).scope();
			scope.$apply(function () {
				for (var x = 0; x < scope.timesheets.length; x++) {
					for (var y = 0; y < scope.timesheets[x].LineItems.length; y++) {
						if(scope.timesheets[x].LineItems[y].TAG === data[0].index1){
							scope.timesheets[x].LineItems[y].FailedMessage = data[0].message;
						};
					};
				};
				/*update failed message*/
				var failedMsg ={};
				failedMsg.key = data[0].index1;
				failedMsg.data = data[0].message;	
				scope.failedMessageList.push(failedMsg);
				scope.saveFailedMsgLocal(data[0].index1,data[0].message); 
				scope.deleteFailedMsg(data[0].index1);
			});
		};
		
	

		function DeleteFailedMsgReturn(data){
			if (typeof data === 'string' || data instanceof String) {
				var data = JSON.parse(data);
			};
			var scope = angular.element(document.getElementById("APPID")).scope();
			scope.$apply(function () {
				
			});
		};
		function DeleteSyncChainReturn(data){
			if (typeof data === 'string' || data instanceof String) {
				var data = JSON.parse(data);
			};
			var scope = angular.element(document.getElementById("APPID")).scope();
			scope.$apply(function () {
				
			});
		};
		function clearSignature (){

			/*$scope.signatureName = "";
			$scope.signature = "";*/

			iziToast.question({
			timeout: 0,
			close: false,
			overlay: true,
			displayMode: 'once',
			id: 'question',
			zindex: 999,
			title: 'Clear Signature',
			message: 'Do you really want to clear the signature?',
			position: 'center',
			buttons: [
				['<button><b>YES</b></button>', function (instance, toast) {
					
					var initscope = angular.element(document.getElementById("APPID")).scope();
					initscope.$apply(function () {
						initscope.signatureName="";
						initscope.signature="";
						initscope.checkSignature();
					});
					instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
				}],
				['<button>NO</button>', function (instance, toast) {
					instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
				}],
			],
			onClosing: function(instance, toast, closedBy){
				console.info('Closing | closedBy: ' + closedBy);
			},
			onClosed: function(instance, toast, closedBy){
				console.info('Closed | closedBy: ' + closedBy);
			}
			});
		};

		function signResponseCapture(data) {
			if (typeof data === 'string' || data instanceof String) {
				var data = JSON.parse(data);
			}
			var scope = angular.element(document.getElementById("APPID")).scope();
			scope.$apply(function () {
				scope.setSignatureCapture(data);
			});
		};

		function setDisJobACList(data) {

			try {
				
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					initscope.jobDisACList =[];
					if (data.length > 0){
						initscope.jobDisACList=data[0].JCActivityCodes;
					};
					
				});
			}
			catch (err) {

			};
		};

		function setLeaveRequestData(data){
			try{
				console.log("setLeaveRequestData Data ",data);
				if (typeof data === 'string' || data instanceof String) {
					var data = JSON.parse(data);
				};
				var initscope = angular.element(document.getElementById("APPID")).scope();
				initscope.$apply(function () {
					if(data && data[0]){
						initscope.leaveRequestData = data[0].HRLeaveRequests;
					};
				});
			}
			catch(error){
				console.log("Error in setLeaveRequestData function")
			}
		};


		function init() {

		};

		function addPhoto(object) {
			var scope = angular.element(document.getElementById("APPID")).scope();
			scope.$apply(function() {
				scope.addPhotoNew(object);
			});
		};

	</script>
</head>
<body>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

	
	
 
	<div id="APPID" ng-app="TOKNApp" ng-controller="dataController">
		

		<div class="preloader" ng-if="loadingInit == true">
			<?xml version="1.0" encoding="utf-8"?>
			<div class="loader-ico" style="margin: auto; margin-top:calc(50vh - 120px); width: 100px; display: block;">
				<?xml version="1.0" encoding="utf-8"?>
				<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
					style="margin: auto; display:block; shape-rendering:auto;" width="100px" height="100px"
					viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
					<circle cx="50" cy="50" fill="none" stroke="#fff" stroke-width="10" r="35"
						stroke-dasharray="164.93361431346415 56.97787143782138" transform="rotate(23.9792 50 50)" style="transition: none;">
						<animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s"
							values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform>
					</circle>
				</svg>
			</div>
			<h3 style="color: white;">{{loadingMessage}}</h3>
		</div>

		<!-- WEEKENDING DATE MENU -->
		
		<nav class="off-canvas">			
			<div class="menu-content">
				<h2 class="bgred" style="background-color: #3c3c3c ; color: rgb(255, 255, 255);">Week Ending Date</h2>
				<ul>
					<li ng-repeat="ts in timesheets | orderBy: '-WeekEndingDate' | orderBy: '-SortWeekEndingDate'">
						<a ng-click="setTimeSheet(ts.tsIndex)" ng-class="{active: ts.selected == true }">{{ts.ListDate}}
							<span class="sub" ng-if="ts.STATE == 'Submitted'">Approval Pending <i class="fas fa-exclamation-circle"></i></span>
							<span class="new" ng-if="ts.STATE == 'Saved'">New <i class="fas fa-exclamation-circle"></i></span>
							<span class="new" ng-if="ts.STATE == 'Submitting'">Submitting <i class="fas fa-exclamation-circle"></i></span>
							<span class="failed" ng-if="ts.STATE == 'Failed'">Failed <i class="fas fa-times-circle"></i></span>
							<span class="failed" ng-if="ts.STATE == 'Rejected'">Rejected <i class="fas fa-times-circle"></i></span>
							<span class="approved" ng-if="ts.STATE == 'Approved'">Approved <i class="fas fa-check-circle"></i></span>
						</a>
					</li>
				</ul>
			</div>
			
			<div class="ver" style="margin: -10px 10px;text-align: center;">
				<span class="ver-ctl ng-binding" ng-style="button3">VER {{version}}</span>
			</div>	
		</nav>



		<div class="timsheet">
			<div class="header" ng-style="{'background': '#fff'}">
				<a class="hm-btn"><i class="fas fa-bars"></i></a>
				<img style="margin-right: 10px;margin-top: 21px;height: 25px;" src="logo.png">
			</div>
			<div class=" main-container">
				<div class="top-section" ng-style="userNameheading">
					<div ng-repeat="alert in alerts">
						<div ng-if="alert.type ==='danger'" class="alert alert-danger fade in">
							<a href="#" class="close" data-dismiss="alert" aria-label="close">?</a>
							<strong>{{alert.msg}}</strong>
						</div>
						<div ng-if="alert.type === 'warning'" class="alert alert-warning fade in">
							<a href="#" class="close" data-dismiss="alert" aria-label="close">?</a>
							<strong>{{alert.msg}}</strong>
						</div>
						<div ng-if="alert.type === 'success'" class="alert alert-success fade in">
							<a href="#" class="close" data-dismiss="alert" aria-label="close">?</a>
							<strong>{{alert.msg}}</strong>
						</div>
					</div>

					<div class="top-container">

						<div class="head-wrap">
							<!-- <i class="fas fa-chevron-left"></i> -->
							<div><i ng-click="navBack()" style="color: white;font-size: 18px;" class="fa fa-arrow-left"></i></div>
							<div style="margin: -7px 0px 0 0px;" class="head-name">
								<h3 style="color:white" ng-if="toknUser.name!='Universal'">{{user.UsualName}}</h3>
								<h3 style="color:white" ng-if="toknUser.name=='Universal'">Northern-Endeavour</h3>
                          </div>
							<!-- <button class="refresh-button" ng-click="refreshTimesheetList()"> -->
								<i ng-click="refreshTimesheetList()" style="color: white;"class="fa fa-sync"></i>
							<!-- </button> -->
						</div>

						<div class="timesheet-submit" ng-if="timesheet.OidString !== undefined ">
							<p ng-style="heading"><i class="fas fa-check-circle"></i> Timesheet ending {{selectDate | date: 'dd/MM/yyyy'}}
								has been Submitted</p>
						</div>
						<div class="timesheet-submit" ng-if="signature">
							<p ng-style="heading"><i class="fas fa-check-circle"></i> Timesheet ending
								{{rawOutputWEDate | date: 'dd/MM/yyyy'}} has been signed</p>
						</div>

					</div>
				</div>


				<!-- Timesheet Cards -->
				<div class="timesheet-wrap">
					<div class="search-timesheet">
						<h3 style="font-size: 20px; text-align: center; width: 100%; padding: 2px; color: black;">Week Ending Date -
							{{timesheets[selectedWeekEnding].ListDate | date: 'dd/MM/yyyy' }}</h3>
						 <!-- <h3 style="color: skyblue;">Hi {{debugMode}}</h3>  <p style="color: red ;"> Hi{{debugMode}}</p>-->
					</div>
                  
					<div class="timesheet-container">
						<!-- LOADING SCREEN -->
						<div class="preloader" ng-if="loading == true">
							<?xml version="1.0" encoding="utf-8"?>
							<div class="loader-ico" style="margin: auto; margin-top:calc(50vh - 180px); width: 100px; display: block;">
								<?xml version="1.0" encoding="utf-8"?>
								<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
									style="margin: auto; display:block; shape-rendering:auto;" width="100px" height="100px"
									viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
									<circle cx="50" cy="50" fill="none" stroke="#fff" stroke-width="10" r="35"
										stroke-dasharray="164.93361431346415 56.97787143782138" transform="rotate(23.9792 50 50)" style="transition: none;">
										<animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s"
											values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform>
									</circle>
								</svg>
							</div>
							<h3 style="color: white;">{{loadingMessage}}</h3>
						</div>
						<div class="empty" style="opacity: 1; visibility: visibile" ng-if="{ active: timesheet.LineItems.length == 0 }">
							<h3><i class="fas fa-exclamation-circle"></i> No timesheets Created</h3>
						</div>
						<div class="timecard" ng-if="loadingData" ng-repeat="det in timesheets[selectedWeekEnding].LineItems  | orderBy: '-TimeLineDate'" ng-class="{ hourslockdown : timesheet.signature}">
							<div ng-show="ToknUserList.length>0"> 
								<h4 style="margin:5px;color:#555">{{det.EmployeeName}}</h4>
							</div>
							<div ng-click="edit=true; editTimeSheet(det.TYPE,det.TAG)" ng-class="{ inactive: det.STATE!='Saved'  &amp;&amp; det.STATE!='Failed', failedTS:det.STATE=='Failed'&amp;&amp; det.FailedMessage !=undefined}" class="timesheet-contentwrapper">
								<div class="head-wrap">
									<div ng-if="(det.OverTime=='' || det.OverTime==undefined || det.OverTime==0)" class="top-head" style="display: flex; justify-content: space-between; align-items:center; padding: 0 5px;" ng-style="subHeadingNew">
										<div style="display: flex; justify-content: space-between; align-items:center; ">
											<spam>{{det.TYPE}}</spam>
											<span style="margin: 0 3px;" ng-style="subHeadingNew">Date: {{det.ListDate | date: 'dd/MM/yyyy'}}</span>
										</div>
                                        <div>
                                          <span style="color: #333333;" class="saved" ng-if="det.STATE=='Saved'">Saved <i style="color: #87BA7B;" class="fas fa-info-circle"></i></span>
                                          <span style="color: black;" class="pending" ng-if="det.STATE== 'Submitted'">Approval Pending <i style="color: #d50909;" class="fas fa-info-circle"></i></span>
                                          <span style="color: #333333;" class="submitted" ng-if="det.STATE == 'Approved'">Approved<i style="color: #87BA7B;" class="fas fa-check-circle"></i></span>
                                          <span style="color: #333333;" class="failed" ng-if="det.STATE == 'Failed'">Failed <i style="color: #d50909;" class="fas fa-times-circle"></i></span>
                                          <span style="color: #333333;" class="failed" ng-if="det.STATE == 'Rejected'">Rejected <i style="color: #d50909;" class="fas fa-times-circle"></i></span>
                                          <span style="color: #333333;" class="saved" ng-if="det.STATE=='Submitting' ||det.STATE=='Pending'">Submitting <i style="color: #054782;" class="fas fa-info-circle"></i></span>
                                        </div>
                                    </div>

									<div ng-if="!(det.OverTime=='' || det.OverTime==undefined || det.OverTime==0)" class="top-head" style="display: flex; justify-content: space-between; align-items:center; padding: 0 5px;background-color: rgb(246 201 171);" ng-style="subHeadingNew">
										<div style="display: flex; justify-content: space-between; align-items:center; ">
											<spam>{{det.TYPE}}</spam>
											<span style="margin: 0 3px;" ng-style="subHeadingNew">Date: {{det.ListDate | date: 'dd/MM/yyyy'}}</span>
										</div>
                                        <div>
                                          <span style="color: #333333;" class="saved" ng-if="det.STATE=='Saved'">Saved <i style="color: #87BA7B;" class="fas fa-info-circle"></i></span>
                                          <span style="color: black;" class="pending" ng-if="det.STATE== 'Submitted'">Approval Pending <i style="color: #d50909;" class="fas fa-info-circle"></i></span>
                                          <span style="color: #333333;" class="submitted" ng-if="det.STATE == 'Approved'">Approved<i style="color: #87BA7B;" class="fas fa-check-circle"></i></span>
                                          <span style="color: #333333;" class="failed" ng-if="det.STATE == 'Failed'">Failed <i style="color: #d50909;" class="fas fa-times-circle"></i></span>
                                          <span style="color: #333333;" class="failed" ng-if="det.STATE == 'Rejected'">Rejected <i style="color: #d50909;" class="fas fa-times-circle"></i></span>
                                          <span style="color: #333333;" class="saved" ng-if="det.STATE=='Submitting' ||det.STATE=='Pending'">Submitting <i style="color: #054782;" class="fas fa-info-circle"></i></span>
                                     	</div>
                                    </div>

									<div style="display: flex; justify-content: space-between; align-items:center; padding: 0 5px;">
										<div class="header-job" style="width: 20%;">
											<span ng-style="subHeadingNew">Job</span>
											<h3 ng-style="bodyText" style="margin: 25px 0 4px;">{{det.Job}}</h3>
										</div>
										<div class="header-job" style="width: 15%;" ng-if="det.ActivityType != 'Disbursement'">
											<span ng-style="subHeadingNew">Hours</span>
											<h3 ng-if="det.STATE!='Approved' &amp;&amp; det.STATE!='Submitted' &amp;&amp; det.STATE!='Submitting'&amp;&amp; det.STATE!='Rejected'" ng-style="bodyText" style="margin: 25px 0 4px;">{{det.Quantity}}</h3>
											<h3 ng-if="det.STATE=='Approved' || det.STATE=='Submitted' || det.STATE=='Submitting'|| det.STATE=='Rejected'" ng-style="bodyText" style="margin: 25px 0 4px;">{{convertQuantity(det.Quantity)}}</h3>
										</div>								
										<div class="header-job" style="width: 15%;" ng-if="det.ActivityType == 'Disbursement'">
											<span ng-style="subHeadingNew">Qty</span>
											<h3 ng-if="det.STATE!='Approved' &amp;&amp; det.STATE!='Submitted' &amp;&amp; det.STATE!='Submitting'&amp;&amp; det.STATE!='Rejected'" ng-style="bodyText" style="margin: 25px 0 4px;">{{det.Quantity}}</h3>
											<h3 ng-if="det.STATE=='Approved' || det.STATE=='Submitted' || det.STATE=='Submitting'|| det.STATE=='Rejected'" ng-style="bodyText" style="margin: 25px 0 4px;">{{det.Quantity}}</h3>
										</div>

										<div class="header-job" style="width: 15%;">
											<span ng-style="subHeadingNew">Start</span>
											<h3 ng-style="bodyText" style="margin: 25px 0 4px;">{{det.StartTime.substr(0,5)}}</h3>	
										</div>
	
										<div class="header-job" style="width: 15%;">
											<span ng-style="subHeadingNew">Finish</span>
											<h3 ng-style="bodyText" style="margin: 25px 0 4px;">{{det.FinishTime.substr(0,5)}}</h3>
										</div>
										<!-- <div class="header-job" style="width: 15%;" ng-if="det.ActivityType != 'Disbursement' && det.ActivityType != 'Supplementary'">
											<span ng-style="subHeadingNew">Travel</span>
											<h3  ng-if= "det.Travel==true && det.TravelTime===undefined" ng-style="bodyText" style="margin: 25px 0 4px;">0</h3>
											<h3  ng-if= "det.Travel==true && det.TravelTime!==undefined" ng-style="bodyText" style="margin: 25px 0 4px;">{{det.TravelTime}}</h3>
											<h3  ng-if= "det.Travel==false"  ng-style="bodyText" style="margin: 25px 0 4px;">0</h3>
										</div> -->

										<div class="header-job" style="width: 15%;" ng-if="det.ActivityType != 'Disbursement' && det.ActivityType != 'TravelFWTD' && det.ActivityType != 'TravelFDTW'">
											<span ng-style="subHeadingNew">OT</span>
											<h3  ng-if= "det.OverTime==0 || det.OverTime=='' || det.OverTime==undefined" ng-style="bodyText" style="margin: 25px 0 4px;">0</h3>
											<h3  ng-if= "(det.STATE!='Approved' && det.STATE!='Submitted' && det.STATE!='Submitting' && det.STATE!='Rejected') && (det.OverTime!==0 && det.OverTime!=='' && det.OverTime!==undefined)" ng-style="bodyText" style="margin: 25px 0 4px;">{{det.OverTime}}</h3>
											<h3  ng-if="(det.STATE=='Approved' || det.STATE=='Submitted' || det.STATE=='Submitting'|| det.STATE=='Rejected') && (det.OverTime!==0 && det.OverTime!=='' && det.OverTime!==undefined)" ng-style="bodyText" style="margin: 25px 0 4px;">{{convertQuantity(det.OverTime)}}</h3>
										</div>

										<div ng-if="det.ActivityType == 'Disbursement'" class="header-job" style="width: 20%;">
											<span ng-style="subHeadingNew">Activity</span>
											<h3 ng-style="bodyText" style="margin: 25px 0 4px;">{{det.ActivityCode}}</h3>
										</div>
										<!-- <div ng-if="det.ActivityType == 'Supplementary'" class="header-job" style="width: 15%;">
											<span ng-style="subHeadingNew">SuppAC</span>
											<h3 ng-style="bodyText" style="margin: 25px 0 4px;">{{det.SuppAC}}</h3>
										</div> -->
										<div ng-if="det.ActivityType != 'Disbursement'" class="header-job" style="width: 20%;">
											<span ng-style="subHeadingNew">Activity</span>
											<h3 ng-style="bodyText" style="margin: 25px 0 4px;">{{det.ActivityCode}}</h3>
										</div>
									</div>
									
								</div>
								<span ng-if="det.STATE == 'Failed' &amp;&amp; det.FailedMessage !=undefined" class="failed-msg">{{det.FailedMessage}}</span>
								<span ng-if="det.STATE == 'Rejected' &amp;&amp; (det.RejectedBy !='' &amp;&amp; det.RejectedBy !=undefined)" class="failed-msg" style="font-size: smaller;padding-left: 0.4rem;"> <b>Rejected by -</b> {{det.RejectedBy}}<br></span>
								<span ng-if="det.STATE == 'Rejected' &amp;&amp; (det.RejectedTimestamp !='' &amp;&amp; det.RejectedTimestamp !=undefined)" class="failed-msg" style="font-size: smaller;padding-left: 0.4rem;"> <b>Rejected on - </b> {{det.RejectedTimestamp}}<br></span>
								<span ng-if="det.STATE == 'Rejected' &amp;&amp; (det.timesheetrejectReason !=undefined || det.timesheetrejectReason !='')" class="failed-msg" style="font-size: smaller;padding-left: 0.4rem;"><b> Reason - </b>{{det.timesheetrejectReason}}</span>
							</div>
							
						</div>
					</div>
				</div>
				
			</div>
				
          
			<div class="footer">
				<div class="timetheet-toggle">
					<!-- resetWCAndActivity();resetWCAndActivity(); -->
					<div class="btn-toggle" ng-click="checkAppOnlineOrOffline();popupWindow('daily'); " ng-style="button1">New Daily</div>
					<div class="btn-toggle" ng-click="checkAppOnlineOrOffline();popupWindow('weekly');" ng-style="button1">New Weekly</div>
					<!-- <span class="ver-ctl ng-binding" ng-style="button3">VER {{version}}</span> -->
				</div>
			</div>

		</div>

		<!-- ADD HOURS POP UP -->
		<div class="popup-window pw-weeklyhours" style="background:rgba(0,0,0, 0.8);z-index: 101;overflow: scroll;">
			<div class="weekly-container" style="margin: calc(50vh - 270px) 20px 0;overflow: scroll;" ng-style="bar">
				<div class="weekly-header" ng-style="lineBTM">

					<div class="item-close">
						<div class="close" ng-click="captureClose()"></div>
					</div>
					<div class="date-stamp">
						<span>Date</span>
						<h4>{{dayEntry.Date}} - {{dayEntry.Day}}</h4>
					</div>
				</div>
				<!-- <input id="WeeklyTravelHr" type="number" inputmode="decimal"
									ng-keydown="allowTwoDigitWeekly('WeeklyTravelHr',index.dayIndex)"
									pattern="^\d*(\.\d{0,2})?$" class="form-control"
									ng-model="perDayTravelHr[index.dayIndex]"> -->
				<div class="weekly-content">

					<div class="inputbox" ng-class="{ focus:dayEntry.travelHr !== '' ,lockdown: lockWeekly==true}" style="width:93%; margin-top: 20px;">
						<div class="placeholder" ng-style="subHeading">*Travel Hours</div>
						<i style="color:#777" class="fas fa-pencil-alt"></i>
						<input type="number" class="input" ng-model="dayEntry.travelHr" inputmode="decimal" pattern="^\d*(\.\d{0,2})?$">
					</div>
					<div style="display: flex;justify-content: space-between;">
						<div class="inputbox" style="width:45%;" ng-class="{ focus:dayEntry.standBy !== '' ,lockdown: lockWeekly==true}">
							<div class="placeholder" ng-style="subHeading">Standby</div>
							<i style="color:#777" class="fas fa-pencil-alt"></i>
							<input type="number" class="input" ng-model="dayEntry.standBy" inputmode="decimal" pattern="^\d*(\.\d{0,2})?$">
						</div>
						<div class="inputbox" style="width:45%;" ng-class="{ focus:dayEntry.delay !== '' ,lockdown: lockWeekly==true}">
							<div class="placeholder" ng-style="subHeading">Delay</div>
							<i style="color:#777" class="fas fa-pencil-alt"></i>
							<input type="number" class="input" ng-model="dayEntry.delay" inputmode="decimal" pattern="^\d*(\.\d{0,2})?$">
						</div>
					</div>
					<!-- <div class="inputbox" ng-class="{ focus:jobname !== '' ,lockdown: lockDaily==true}" style="width:100%; margin: 0">
						<div class="placeholder" ng-style="subHeading">*Enter Job Code</div>
						<i style="color:#777" class="fas fa-pencil-alt"></i>
						<input id="dailyJobCode" type="text" ng-model="jobname" class="input">
					</div>		 -->

					<div class="sub-popup-header" style="width: calc(100% - 20px);width: -moz-calc(100% - 20px);width: -webkit-calc(100% - 20px);margin: 0px 10px;" ng-style="lineBTM">
						<h3 ng-style="subHeading" style=" font-size: 16px;">Enter work start and end time</h3>
					</div>
					<div class="input-capture-time" style="padding-bottom:70px">

						<div class="inputfield content-50" style=" width: 50%; float: left; display: block;">
							<div class="inputbox content-50 left" ng-class="{ focus: time.startTime !=='',lockdown: lockWeekly==true}">
								<div class="placeholder">Start time</div>

								<input type="text" id="weeklydaystart" class="form-control js-time-picker" ng-model="pickerDayStartTime" ng-change="adjustDayTime()">


								<i class="fas fa-pencil-alt"></i>
							</div>
						</div>

						<div class="inputfield content-50" style=" width: 50%; float: left; display: block;">
							<div class="inputbox" ng-class="{ focus: time.endTime !== '',lockdown: lockWeekly==true}">
								<div class="placeholder">End time</div>

								<input type="text" id="weeklydayend" class="form-control js-time-picker" ng-model="pickerDayEndTime" ng-change="adjustDayTime()">
								<i class="fas fa-pencil-alt"></i>
							</div>
						</div>

					</div>

					<!-- <div ng-if="SplitTotalHoursInWeekly[index.dayIndex].TotalHoursSplit"class="weekly-hours" style="width: 100%;display: inline-flex;justify-content: space-between;">
						<div style="display: flex;align-items: center;justify-content: space-between;flex-direction: column;">
							<span style="font-size: 16px;font-weight: bold;">Standard</span>
							<input style="font-size: 40px;padding: 0;"class="input" ng-model="SplitTotalHoursInWeekly[index.dayIndex].TotalStandardHours" disabled="">
						</div>
						<div style="display: flex;align-items: center;justify-content: space-between;flex-direction: column;">
							<span style="font-size: 16px;font-weight: bold;">Supplementary</span>
							<input style="font-size: 40px;padding: 0;" class="input" ng-model="SplitTotalHoursInWeekly[index.dayIndex].TotalSupplementaryHours" disabled="">
						</div>
					</div> -->	

					<div class="weekly-hours">
						<div>
							<p style="margin:0;">Total Hours</p>
							<input class="input" style="padding: 0; font-size: 30px;margin-bottom: 15px;" ng-model="dayEntry.Hours" disabled="">
						</div>
					</div>
					

				</div>

				<button class="new" ng-click="windowHours(index.dayIndex, false)">Confirm</button>
			</div>
		</div>





		<!-- DAILY TIMESHEET -->
		<div class="popup-window pw-daily pw-edit" ng-style="secondBG">
			<!--<button ng-click="createTimesheet('Daily', true)" class="save">Submit Daily Timesheet</button>-->

			<button ng-click="createTimesheet('Daily', true)" class="save right" ng-if="editTAG!='None'" ng-style="button1">Submit </button>
			<button ng-click="deleteTimesheet()" class="delete left" ng-if="editTAG!='None'" ng-style="button1">Delete </button>
			<button ng-click="createTimesheet('Daily', true)" class="save" ng-if="editTAG=='None'" ng-style="button1">Submit </button>


			<!--<button ng-click="createTimesheet('Daily', true);edit=false" class="save right">Submit</button>
			<button ng-click="deleteTimesheet();edit=false" class="delete left">Delete</button>-->

			<div class="popup-header" ng-style="lineTOP">
				<button ng-click="createTimesheet('Daily', false);" style="color: white;">Save</button>

				<div class="item-close">
					<div class="close" ng-click="closepopup()"></div>
				</div>
              <!-- <img src="logo.png" ng-click="closepopup()"> -->
              
			</div>

			<div class="popup-content">
				<div class="sub-popup-header" ng-style="lineBTM" style="margin:20px 0 35px;font-weight:bold; display: flex; justify-content: space-between;align-items:center;">
					<!-- <div style="font-size:20px" ng-style="subHeading">Daily Timesheet</div> -->
					<div style="display: flex; justify-content: space-between; align-items:center;font-size: 20px;color: #3c3c3c ;">
						<div class="user">
							<i class="fas fa-user"></i>
						</div>
						<div ng-init="uname='Welcome Guest!'" style="margin: 0px 10px 0px; ">
							<span ng-if="toknUser.name != 'Universal'">{{user.UsualName}}</span>
							<span ng-if="toknUser.name == 'Universal'">Northern-Endeavour</span>
						</div>
					</div>
					<div class="date-stamp" ng-style="subHeading">
						<span>Week Ending Date</span>
						<h4 style="color:#000">{{rawOutputWEDate | date: 'dd/MM/yyyy'}}</h4>
					</div>
				</div>
					
					<div class="inputbox focus" style="width:100%; margin: 0 0 10px" ng-class="{lockdown: lockDate==true}">
						<div class="placeholder" ng-style="subHeading">Date Worked</div>
						<md-datepicker id="datePicker" type="date" ng-model="selectDate" md-min-date="minDate" md-placeholder="Select" readonly="" ng-focus="unlockDailyOnBlur()" ng-change="unlockDailyTimesheet()">
						</md-datepicker>
					</div>
					

				<!-- <div class="inputbox" ng-class="{ focus:jobname !== undefined ,lockdown: lockDaily==true}"
					style="width:100%; margin: 0">
					<div class="placeholder">Enter Job Code</div>
					<i class="fas fa-pencil-alt"></i>
					<input id="dailyJobCode" type="text" ng-model="jobname" ng-change="resetWCAndActivity()" class="input">
				</div> -->

				<!-- User DROPDOWN -->
				<!-- <div id="userdropdown01" class="dropdown" style="width:100%" ng-show="ToknUserList.length!=0">
				
					<div class="selected" ng-class="{focus: selectedEmployee.name !== undefined && selectedEmployee.name !== '',lockdown: lockDaily==true}">
						<input type="text" class="input" ng-model="selectedEmployee.name">
						<div id="toknUserList01" class="placeholder" ng-style="subHeading" onclick="dd_expand('#toknUserList01')">
							<span ng-if="selectedEmployee.name == undefined ||selectedEmployee.name  == ''">- Select User* -</span>
							<span ng-if="selectedEmployee.name !== '' && selectedEmployee.name !== undefined">Current User</span>
						</div>                              
						<i class="drop-down-arrow"></i>
					</div>
				
					<div class="selection search">
						<input type="text" placeholder="Search User" ng-model="UserNameFilter">
						<ul>
							<li ng-repeat="listItem in ToknUserList | filter:UserNameFilter">
								<a ng-click="setSelectedEmployee(listItem)" onclick="dd_expand('#toknUserList01')">{{listItem.name}}  {{listItem.surname}}</a>              
							</li>
							<a style="margin: 0 20px;" ng-if="!(ToknUserList | filter:UserNameFilter).length">No User Found </a>
						</ul>  
					</div>
				</div> -->


				<!--Job Dropdown-->
				
				<!-- <div class="dropdown" style="width:100%">
					<div class="selected" ng-class="{focus: jobname !== '',lockdown: lockDaily==true }">
						<input type="text" class="input" ng-model="jobname" name="act">
						<div id="jobListNewCodeEdit02" class="placeholder inputloadercontainer" onclick="dd_expand('#jobListNewCodeEdit02')">
							<span ng-if="jobname  == ''&amp;&amp; !loadingJob">-Select Job-</span>
							<span ng-if="jobname !== ''&amp;&amp; !loadingJob">Job</span>
						</div>

						<i class="drop-down-arrow"></i>
						<div ng-show="loadingJob" class="icon-container" style="inset: 0;width: 100%;height: 60px;position: absolute;left: 0;right: 0;margin-left: auto;margin-right: auto;" aria-hidden="false">
							<div style="display: flex;justify-content: center;align-items: center;height: 50px;">
								<div class="loader">
								</div>
								<div style="padding-left: 10px;">{{currentStatus}}</div>
							</div>
						</div>
					</div>

					
					<div class="selection search">
						<input type="text" placeholder="Search Job" ng-model="SearchJobText">
						<ul>
								
							<li ng-repeat="jobItem in allJobList | filter: SearchJobText ">
								<a ng-click="checkAppOnlineOrOffline();setSelectedJob(jobItem);" onclick="dd_expand('#jobListNewCodeEdit02')">{{jobItem.Code}} - {{jobItem.Name}}</a>
							</li>
                          	<a style="margin: 0 20px;" ng-if="allJobList.length == 0">No Jobs</a>
						</ul>
					</div>

				</div> -->
              
				<div class="inputbox" ng-class="{ focus:jobname !== '' ,lockdown: lockDaily==true}" style="width:100%; margin: 0">
					<div class="placeholder" ng-style="subHeading">*Enter Job Code</div>
					<i style="color:#777" class="fas fa-pencil-alt"></i>
					<input id="dailyJobCode" type="text" ng-model="jobname" class="input">
				</div>
														

				<!--User List Dropdown-->
                <div class="dropdown" style="width:100%; margin-top: 10px;">
                    <div class="selected" ng-class="{focus: selectedUserNameList.length!= 0,lockdown: lockDaily==true }">
                        <input type="text" class="input" ng-model="selectedUserNameList" name="act">
                        <div id="userListNewCodeEdit02" class="placeholder" onclick="dd_expand('#userListNewCodeEdit02')">
                            <span ng-if="selectedUserNameList.length== 0 ">*Select User</span>
                            <span ng-if="selectedUserNameList.length!= 0">*User</span>
                        </div>

                        <i class="fas fa-caret-down"></i>
                    </div>
                    
                    <div class="selection search">
                        <input type="text" placeholder="Search User" ng-model="SearchEmpText">
                        <ul>
                            <li ng-repeat="user in AllUserList | filter: SearchEmpText ">  
            
                                <div class="select"  >
                                    <label class="checkbox confirm" style="padding: 10px;" >
                                        <input type="checkbox" ng-model="user.check" >
                                        <span ng-click="checkToknUser(user.userID)" style="float: left;font-size: 1.1rem; margin-left: 15px;color:#000">{{user.name}}  {{user.surname}} </span>
                                    </label>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

				<!-- Select Sites -->
				<div class="dropdown" style="width:100%">
					<div class="selected" ng-class="{focus: selectedSite.FullName !== undefined,lockdown: lockDaily==true }">
						<input type="text" class="input" disabled="" ng-model="selectedSite.FullName" name="act" ng-value="selectedSite.FullName">
						<div id="activityNewCodeEdit02" class="placeholder" onclick="dd_expand('#activityNewCodeEdit02')">
							<span ng-if="selectedSite.FullName  == undefined &amp;&amp; !loadingAC">*Select Site</span>
							<span ng-if="selectedSite.FullName !== undefined &amp;&amp; !loadingAC">*Site</span>
						</div>
						<i class="drop-down-arrow"></i>
						<div ng-show="loadingAC" class="icon-container" style="inset: 0;width: 100%;height: 60px;position: absolute;left: 0;right: 0;margin-left: auto;margin-right: auto;" aria-hidden="false">
							<div style="display: flex;justify-content: center;align-items: center;height: 50px;">
								<div class="loader">
								</div>
								<div style="padding-left: 10px;">{{currentStatus}}</div>
							</div>
						</div>
					</div>
					<div class="selection search">
						<input type="text" placeholder="Search sites" ng-model="activityFilter">
						<ul>
							<li ng-repeat="site in SitesList | filter: activityFilter ">
								
								<a ng-click="setSelectedSite(site);" onclick="dd_expand('#activityNewCodeEdit02')">
								{{site.Title}}</a>
							</li>
                          	<a style="margin: 0 20px;" ng-if="SitesList.length == 0">No Sites data </a>
						</ul>
					</div>
				</div>
				<!-- <div class="inputbox" ng-class="{ focus:jobname !== '' ,lockdown: lockDaily==true}" style="width:100%; margin: 0">
					<div class="placeholder" ng-style="subHeading">*Enter Job Code</div>
					<i style="color:#777" class="fas fa-pencil-alt"></i>
					<input id="dailyJobCode" type="text" ng-model="jobname" class="input">
				</div> -->
				<!-- Travel Hours -->
				<div class="inputbox" ng-class="{ focus:TravelDataDaily.travelHr !== '' ,lockdown: lockDaily==true}" style="width:100%;margin-left: 0;margin-top: 0;">
					<div class="placeholder" ng-style="subHeading">*Travel Hours</div>
					<i style="color:#777" class="fas fa-pencil-alt"></i>
					<input type="number" class="input" ng-model="TravelDataDaily.travelHr" inputmode="decimal" pattern="^\d*(\.\d{0,2})?$">
				</div>
				<div style="display: flex;justify-content: space-between;width:100%; margin: 0">
					<div class="inputbox" ng-class="{ focus:TravelDataDaily.standBy !== '' ,lockdown: lockDaily==true}" style="width:49%;margin-right: 0;margin-left: 0;">
						<div class="placeholder" ng-style="subHeading">Standby</div>
						<i style="color:#777" class="fas fa-pencil-alt"></i>
						<input type="number" class="input" ng-model="TravelDataDaily.standBy" inputmode="decimal" pattern="^\d*(\.\d{0,2})?$">
					</div>
					<div class="inputbox" ng-class="{ focus:TravelDataDaily.delay !== '' ,lockdown: lockDaily==true}" style="width:49%;margin-right: 0;margin-left: 0;">
						<div class="placeholder" ng-style="subHeading">Delay</div>
						<i style="color:#777" class="fas fa-pencil-alt"></i>
						<input type="number" class="input" ng-model="TravelDataDaily.delay" inputmode="decimal" pattern="^\d*(\.\d{0,2})?$">
					</div>
				</div>

				<div class="select" ng-class="{ focus:DailyUlb !== undefined ,lockdown: lockDaily==true}">
					<label class="checkbox" style="color: #3c3c3c;">
						<input ng-checked="DailyUlb" type="checkbox" ng-model="DailyUlb" ng-change="reduceHours('Daily')">
						<span ng-style="icon">Unpaid lunch break?</span>
					</label>
				</div>

				<div class="input-capture-time">
					<div class="sub-popup-header" ng-style="lineBTM">
						<h3 ng-style="subHeading">Enter your work start and end time</h3>
					</div>
					<div class="clear-fixed">
						<div class="inputfield content-50" style="margin-right:5px;">
							<div class="inputbox content-50 left" ng-class="{ focus: time.startTime !=='',lockdown: lockDaily==true}">
								<div class="placeholder" ng-style="subHeading">Start time</div>

								<input type="text" id="dailystart" class="form-control js-time-picker" ng-model="pickerStartTime" ng-change="adjustTime()">
								<i class="fas fa-pencil-alt"></i>
							</div>
						</div>
					</div>

					<div class="clear-fixed">
						<div class="inputfield content-50" style="margin-left:5px;">
							<div class="inputbox" ng-class="{ focus: time.endTime !== '',lockdown: lockDaily==true}">
								<div class="placeholder" ng-style="subHeading">End time</div>

								<input type="text" id="dailyend" class="form-control js-time-picker" ng-model="pickerEndTime" ng-change="adjustTime()">

								<i class="fas fa-pencil-alt"></i>
							</div>
						</div>

					</div>
				</div>

				<div class="total-hrs">
					<div class="calc-hours">
						<h5 ng-style="subHeading">Total Hours</h5>
						<h3 ng-style="subHeadingHours" style="color: #777;">{{time.hoursWorked}}</h3>
					</div>
				</div>


				<div class="sub-popup-header" ng-style="lineBTM"></div>
     
				<!-- <div class="textlongbox" ng-class="{ focus: StandardText !== undefined,lockdown: lockDaily==true}">
					<div class="note">
						<div class="placeholder">Notes</div>
						<i class="fas fa-pencil-alt" style="margin: -10px 0 ;"></i>
					</div>
					<textarea style="color: #000;" id="dailyNotes" type="text" ng-model="StandardText" class="input"></textarea>
					
				</div> -->

				<div class="textlongbox" ng-class="{ focus: jobDesc !== undefined,lockdown: lockDaily==true}">
					<div class="note">
						<div class="placeholder">Job Description</div>
						<i class="fas fa-pencil-alt" style="margin: -10px 0 ;"></i>
					</div>
					<textarea style="color: #000;" id="dailyNotes" type="text" ng-model="jobDesc" class="input"></textarea>
					
				</div>
				<!-- <div>
					<div class="sub-popup-header" ng-style="lineBTM">
						<h3 ng-style="subHeading">Attachments</h3>
					</div>
						
					<div ng-if="imageAttachments.length === 0">
						<h5 style="text-align: center"><i class="fas fa-exclamation-circle"></i> No current attachments</h5>
					</div>
					<button ng-if="addAttach" class="addattachment" ng-class="{lockdown: lockDaily==true}" ng-style="button1" ng-click="btnUploader();">
						<i class="fa fa-camera" style="color: white;"></i> <span style="color: white;">Add</span>
					</button>
					<ul class="popup-media">
						<li ng-repeat="img in imageAttachments">
							<div class="img-item">
								<img width="50%" height="50%" ng-src="{{img.src}}">
								<button ng-click="imgDelete($index)"><i class="fas fa-minus"></i></button>
							</div>
						</li>
					</ul>
				</div> -->
				
				<div class="inputbox" ng-show="showEmail" ng-class="{ focus:supervisorEmail !== '' ,lockdown: lockDaily==true}" style="width:100%; margin: 20px 0 15px">
					<div class="placeholder" ng-style="subHeading">Approval email</div>
					<input type="input" class="input" ng-model="supervisorEmail" ng-focus="showSVList=true">
					<i class="fas fa-pencil-alt"></i>
				</div>
				<div class="signature" ng-show="showEmail">
					<div class="signiturebox" ng-click="getSignatureCapture('Daily')" ng-class="{ focus: signature !== '',lockdown: lockDaily==true}" ng-style="border">
						<div class="placeholder" ng-style="subHeading">Signature</div>
						<div>{{signatureName}}</div>
						<img ng-if="signature != ''" style="height: calc(100% - 20px); width: auto;" class="signature-img" src="{{signature}}">
					</div>
					<i ng-if="signature == ''" class="fas fa-pencil-alt"></i>
					<i ng-if="signature != ''" class="fas fa-trash-alt fa-2x" style="color:red" onclick="clearSignature()"></i>

				</div>

			</div>
		</div>

		<!-- WEEKLY TIMESHEET -->
		<div class="popup-window pw-weekly" ng-style="secondBG">
			<button ng-click="createTimesheet('Weekly', true)" class="save right" ng-style="button1" ng-if="editTAG!='None'">Submit
			</button>
			<button ng-click="deleteTimesheet()" class="delete left" ng-if="editTAG!='None'" ng-style="button1">Delete </button>
			<button ng-click="createTimesheet('Weekly', true)" class="save" ng-if="editTAG=='None'" ng-style="button1">Submit </button>

			<div class="popup-header" ng-style="lineTOP">
				<button ng-click="createTimesheet('Weekly', false);" style="color: white;">Save</button>

				<div class="item-close">
					<div class="close" ng-click="closepopup()"></div>
				</div>
              <!-- <img src="logo.png" ng-click="closepopup()"> -->
			</div>

			<div class="popup-content">
				<div class="sub-popup-header" ng-style="lineBTM" style="margin:20px 0 35px;font-weight:bold; display: flex; justify-content: space-between;align-items:center;">
					<div style="display: flex; justify-content: space-between; align-items:center;font-size: 20px;color:#3c3c3c ;">
						<div class="user">
							<i class="fas fa-user"></i>
						</div>
						<div ng-init="uname='Welcome Guest!'" style="margin: 0px 10px 0px; ">	
							<span ng-if="toknUser.name != 'Universal'">{{user.UsualName}}</span>
							<span ng-if="toknUser.name == 'Universal'">Northern-Endeavour</span>
						</div>
					</div>
					<div class="date-stamp" ng-style="subHeading">
						<span>Week Ending Date</span>
						<h4 style="color:#000">{{rawOutputWEDate | date: 'dd/MM/yyyy'}}</h4>
					</div>
				</div>

				<div class="inputbox focus" style="width:100%; margin: 0 0 10px" ng-class="{lockdown: lockDate==true}">
					<div class="placeholder" ng-style="subHeading">Weekending Date</div>
					<md-datepicker id="datePicker" type="date" ng-model="selectDate" md-min-date="minDate" md-placeholder="Select" readonly="" ng-focus="unlockWeeklyOnBlur(selectDate)" ng-change="fixWeekEndingDate(); lockWeekly=false;" md-date-filter="selectableDate">
					</md-datepicker>
				</div>

				<!-- User DROPDOWN -->
				<!-- <div id="userdropdown02" class="dropdown" style="width:100%" ng-show="ToknUserList.length!=0">
				
					<div class="selected" ng-class="{focus: selectedEmployee.name !== undefined && selectedEmployee.name !== '',lockdown: lockWeekly==true}">
						<input type="text" class="input" ng-model="selectedEmployee.name">
						<div id="toknUserList02" class="placeholder" ng-style="subHeading" onclick="dd_expand('#toknUserList02')">
							<span ng-if="selectedEmployee.name == undefined ||selectedEmployee.name  == ''">- Select User* -</span>
							<span ng-if="selectedEmployee.name !== '' && selectedEmployee.name !== undefined">Current User</span>
						</div>                              
						<i class="drop-down-arrow"></i>
					</div>
				
					<div class="selection search">
						<input type="text" placeholder="Search User" ng-model="UserNameFilter">
						<ul>
							<li ng-repeat="listItem in ToknUserList | filter:UserNameFilter">
								<a ng-click="setSelectedEmployee(listItem)" onclick="dd_expand('#toknUserList02')">{{listItem.name}}  {{listItem.surname}}</a>              
							</li>
							<a style="margin: 0 20px;" ng-if="!(ToknUserList | filter:UserNameFilter).length">No User Found </a>
						</ul>  
					</div>
				</div> -->


				<!--Job Dropdown-->
				
				<!-- <div class="dropdown" style="width:100%">
					<div class="selected" ng-class="{focus: jobname !== '' ,lockdown: lockWeekly==true}">
						<input type="text" class="input " ng-model="jobname" name="act">
						<div id="jobListNewCodeEdit03" class="placeholder inputloadercontainer" onclick="dd_expand('#jobListNewCodeEdit03')">
							<span ng-if="jobname  == '' &amp;&amp; !loadingJob">-Select Job-</span>
							<span ng-if="jobname !== '' &amp;&amp; !loadingJob ">Job</span>
						</div>

						<i class="drop-down-arrow"></i>
						<div ng-show="loadingJob" class="icon-container" style="inset: 0;width: 100%;height: 60px;position: absolute;left: 0;right: 0;margin-left: auto;margin-right: auto;" aria-hidden="false">
							<div style="display: flex;justify-content: center;align-items: center;height: 50px;">
								<div class="loader">
								</div>
								<div style="padding-left: 10px;">{{currentStatus}}</div>
							</div>
						</div>
					</div>

					
					<div class="selection search">
						<input type="text" placeholder="Search Job" ng-model="SearchJobText">
						<ul>
								
							<li ng-repeat="jobItem in allJobList | filter: SearchJobText ">
								<a ng-click="checkAppOnlineOrOffline();setSelectedJob(jobItem);" onclick="dd_expand('#jobListNewCodeEdit03')">{{jobItem.Code}} - {{jobItem.Name}}</a>
							</li>
							<a style="margin: 0 20px;" ng-if="allJobList.length == 0">No Jobs</a>
						</ul>
					</div>					
				</div> -->

				<div class="inputbox" ng-class="{focus: jobname !== '' ,lockdown: lockWeekly==true}" style="width:100%; margin: 0">
					<div class="placeholder" ng-style="subHeading">*Enter Job Code</div>
					<i style="color:#777" class="fas fa-pencil-alt"></i>
					<input id="dailyJobCode" type="text" ng-model="jobname" class="input">
				</div>

				
				<!--User List Dropdown-->
                <div class="dropdown" style="width:100%; margin-top: 10px;">
                    <div class="selected" ng-class="{focus: selectedUserNameList.length!= 0,lockdown: lockWeekly==true }">
                        <input type="text" class="input" ng-model="selectedUserNameList" name="act">
                        <div id="userSelectedEdit01" class="placeholder" onclick="dd_expand('#userSelectedEdit01')">
                            <span ng-if="selectedUserNameList.length== 0 ">*Select User</span>
                            <span ng-if="selectedUserNameList.length!= 0">*User</span>
                        </div>

                        <i class="fas fa-caret-down"></i>
                    </div>
                    
                    <div class="selection search">
                        <input type="text" placeholder="Search User" ng-model="SearchEmpText">
                        <ul>
                            <li ng-repeat="user in AllUserList | filter: SearchEmpText ">  
            
                                <div class="select"  >
                                    <label class="checkbox confirm" style="padding: 10px;" >
                                        <input type="checkbox" ng-model="user.check" >
                                        <span ng-click="checkToknUser(user.userID)" style="float: left;font-size: 1.1rem; margin-left: 15px;color:#000">{{user.name}}  {{user.surname}} </span>
                                    </label>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

				<!-- Select Sites -->
				<div class="dropdown" style="width:100%">
					<div class="selected" ng-class="{focus: selectedSite.FullName !== undefined,lockdown: lockWeekly==true }">
						<input type="text" class="input" disabled="" ng-model="selectedSite.FullName" name="act" ng-value="selectedSite.FullName">
						
						<div id="userSelectedEdit02" class="placeholder" onclick="dd_expand('#userSelectedEdit02')">
							<span ng-if="selectedSite.FullName  == undefined &amp;&amp; !loadingAC">*Select Site</span>
							<span ng-if="selectedSite.FullName !== undefined &amp;&amp; !loadingAC">*Site</span>
						</div>
						<i class="drop-down-arrow"></i>
						<div ng-show="loadingAC" class="icon-container" style="inset: 0;width: 100%;height: 60px;position: absolute;left: 0;right: 0;margin-left: auto;margin-right: auto;" aria-hidden="false">
							<div style="display: flex;justify-content: center;align-items: center;height: 50px;">
								<div class="loader">
								</div>
								<div style="padding-left: 10px;">{{currentStatus}}</div>
							</div>
						</div>
					</div>
					<div class="selection search">
						<input type="text" placeholder="Search sites" ng-model="activityFilter">
						<ul>
							<li ng-repeat="site in SitesList | filter: activityFilter ">
								<a ng-click="setSelectedSite(site);" onclick="dd_expand('#userSelectedEdit02')">
								{{site.Title}}</a>
							</li>
                          	<a style="margin: 0 20px;" ng-if="SitesList.length == 0">No Sites data </a>
						</ul>
					</div>
				</div>

				
				<div class="select" ng-class="{ focus:DailyUlb !== undefined ,lockdown: lockWeekly==true}">
					<label class="checkbox">
						<input ng-checked="DailyUlb" type="checkbox" ng-model="DailyUlb" ng-change="reduceHours('Weekly')">
						<span ng-style="icon">Unpaid lunch break?</span>
					</label>
				</div> 


				<div class="input-capture-time">
					<div class="sub-popup-header" ng-style="lineBTM">
						<h3 ng-style="subHeading">Enter your work start and end time</h3>
					</div>
					<div class="clear-fixed">
						<div class="inputfield content-50" style="margin-right:5px;">
							<div class="inputbox content-50 left" ng-class="{ focus: time.startTime !=='',lockdown: lockWeekly==true}">
								<div class="placeholder" ng-style="subHeading">Start time</div>

								<input type="text" id="weeklystart" class="form-control js-time-picker" ng-model="pickerStartTime" ng-change="adjustWeeklyTime()">

								<i class="fas fa-pencil-alt"></i>
							</div>
						</div>
					</div>

					<div class="clear-fixed">
						<div class="inputfield content-50" style="margin-left:5px;">
							<div class="inputbox" ng-class="{ focus: time.endTime !== '' ,lockdown: lockWeekly==true}">
								<div class="placeholder" ng-style="subHeading">End time</div>

								<input type="text" id="weeklyend" class="form-control js-time-picker" ng-model="pickerEndTime" ng-change="adjustWeeklyTime()">
								<i class="fas fa-pencil-alt"></i>
							</div>
						</div>
					</div>
				</div>

				<div class="total-hrs">
					<div class="calc-hours">
						<h5 ng-style="subHeading">Total Hours</h5>
						<h3 ng-style="subHeadingHours" style="color: #777;">{{time.hoursWorked}}</h3>
					</div>
				</div>

				<div class="sub-popup-header" ng-style="lineBTM"></div>

				<!-- <div class="textlongbox" ng-class="{ focus: StandardText !== '', lockdown: lockWeekly==true}">
					<div class="placeholder" ng-style="subHeading">Notes</div>
					<textarea id="weeklyNotes" type="text" ng-model="StandardText" class="input"></textarea>
					<i class="fas fa-pencil-alt"></i>
				</div> -->

				<!-- <div class="textlongbox" ng-class="{ focus: StandardText !== undefined,lockdown: lockWeekly==true}">
					<div class="note">
						<div class="placeholder">Notes</div>
						<i class="fas fa-pencil-alt" style="margin: -10px 0 ;"></i>
					</div>
					<textarea style="color: #000;" id="dailyNotes" type="text" ng-model="StandardText" class="input"></textarea>
					
				</div> -->

				<div class="textlongbox" ng-class="{ focus: jobDesc !== undefined,lockdown: lockDaily==true}">
					<div class="note">
						<div class="placeholder">Job Description</div>
						<i class="fas fa-pencil-alt" style="margin: -10px 0 ;"></i>
					</div>
					<textarea style="color: #000;" id="dailyNotes" type="text" ng-model="jobDesc" class="input"></textarea>
					
				</div>
				<!-- <div>
					<div class="sub-popup-header" ng-style="lineBTM">
						<h3 ng-style="subHeading">Attachments</h3>
					</div>
						
					<div ng-if="imageAttachments.length === 0">
						<h5 style="text-align: center"><i class="fas fa-exclamation-circle"></i> No current attachments</h5>
					</div>
					<button ng-if="addAttach" class="addattachment" ng-class="{lockdown: lockWeekly==true}" ng-style="button1" ng-click="btnUploader();">
						<i class="fa fa-camera" style="color: white;"></i> <span style="color: white;">Add</span>
					</button>
					<ul class="popup-media">
						<li ng-repeat="img in imageAttachments">
							<div class="img-item">
								<img width="50%" height="50%" ng-src="{{img.src}}">
								<button ng-click="imgDelete($index)"><i class="fas fa-minus"></i></button>
							</div>
						</li>
					</ul>
				</div> -->

				<div ng-show="showEmail" class="inputbox content-50 right" style="width:100%; margin: 20px 0 15px" ng-class="{ focus: supervisorEmail !=='' ,lockdown: lockWeekly==true}">
					<div class="placeholder" ng-style="subHeading">Approval email</div>
					<input type="text" class="input" ng-model="supervisorEmail">
					<i class="fas fa-pencil-alt"></i>
				</div>
				<div class="signature" ng-show="showEmail">
					<div class="signiturebox" ng-click="getSignatureCapture('Weekly')" ng-class="{ focus: signature !== '',lockdown: lockWeekly==true}" ng-style="border">
						<div class="placeholder" ng-style="subHeading">Signature</div>
						<div>{{signatureName}}</div>
						<img ng-if="signature != ''" style="height: calc(100% - 20px); width: auto;" class="signature-img" src="{{signature}}">
					</div>
					<i ng-if="signature == ''" class="fas fa-pencil-alt"></i>
					<i ng-if="signature != ''" class="fas fa-trash-alt fa-2x" style="color:red" onclick="clearSignature()"></i>
				</div>

				<!-- Timesheet Cards -->
				<div class="weekly-footer" ng-style="barWhite">

					<div class="ts-container">
						<div class="week-nav">

							<h3 style="color:#000">Week Ending Date - {{rawOutputWEDate | date: 'dd/MM/yyyy'}}</h3>
							
						</div>
						<div class="sub-header"  ng-class="{ lockdown: lockWeekly==true}">
							<h4 style="color:#000">Work Hours</h4>
							<ul>
								<li ng-repeat="hpd in hoursperday" style="background: white;">
									<button ng-click="index.dayIndex=$index;windowHours(index.dayIndex, true)">
										<span ng-style="subHeading">{{hpd.Day}}</span>
										<span class="num" style="color: black;">{{hpd.Hours}}</span>
									</button>
								</li>
							</ul>
						</div>
					</div>
				</div>			
			</div>
		</div>
		<!-- <span class="ver-ctl">VER {{version}}</span> -->
	</div>


</body>
</html>